/**
 * Vulnerability Details Modal Module for HexTrackr
 * 
 * This module provides an enhanced vulnerability details modal with comprehensive information display,
 * API integration stubs, tabbed interface, and improved user experience using Tabler.io styling.
 * 
 * @fileoverview Vulnerability details modal management and display
 * @author HexTrackr Development Team
 * @version 1.0.0
 */

/* global window, document, bootstrap, agGrid, console */

class VulnerabilityDetailsModal {
    constructor() {
        this.currentVulnerability = null;
        this.affectedAssetsGrid = null;
        this.affectedAssetsGridApi = null;
        
        this.init();
    }

    /**
     * Initialize the vulnerability details modal
     */
    init() {
        this.bindEventListeners();
        console.log("VulnerabilityDetailsModal initialized");
    }

    /**
     * Bind event listeners for modal interactions
     */
    bindEventListeners() {
        // Export vulnerability CSV button
        const exportVulnCSV = document.getElementById("exportVulnCSV");
        if (exportVulnCSV) {
            exportVulnCSV.addEventListener("click", () => {
                this.exportVulnerabilityCSV();
            });
        }

        // Generate vulnerability report button  
        const generateVulnReport = document.getElementById("generateVulnReport");
        if (generateVulnReport) {
            generateVulnReport.addEventListener("click", () => {
                this.generateVulnerabilityReport();
            });
        }

        // Tab switching event listeners
        const tabButtons = document.querySelectorAll("#vulnDetailsModal .nav-tabs button[data-bs-toggle=\"tab\"]");
        tabButtons.forEach(button => {
            button.addEventListener("shown.bs.tab", (event) => {
                this.onTabShown(event.target.getAttribute("data-bs-target"));
            });
        });
    }

    /**
     * Show vulnerability details modal with comprehensive information
     * @param {string|Object} vulnerabilityData - Vulnerability ID or data object
     * @param {Object} dataManager - Reference to data manager for asset queries
     */
    async showVulnerabilityDetails(vulnerabilityData, dataManager = null) {
        try {
            // Handle both ID and direct object passing
            let vulnerability;
            if (typeof vulnerabilityData === "string") {
                vulnerability = window.vulnModalData && window.vulnModalData[vulnerabilityData];
            } else {
                vulnerability = vulnerabilityData;
            }

            if (!vulnerability) {
                console.error("Vulnerability data not found");
                return;
            }

            this.currentVulnerability = vulnerability;
            
            // Populate modal content
            await this.populateOverviewTab(vulnerability);
            await this.populateVendorIntelligenceTab(vulnerability);
            await this.populateRiskAssessmentTab(vulnerability);
            await this.populateAffectedAssetsTab(vulnerability, dataManager);

            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById("vulnDetailsModal"));
            modal.show();

        } catch (error) {
            console.error("Error showing vulnerability details:", error);
            this.showToast?.("Error displaying vulnerability details", "error");
        }
    }

    /**
     * Populate the Overview tab with basic vulnerability information
     */
    async populateOverviewTab(vulnerability) {
        const vulnLink = this.getVulnerabilityLink(vulnerability);
        
        const overviewContent = document.getElementById("vulnOverviewContent");
        if (overviewContent) {
            overviewContent.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Vulnerability Information
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="row">
                                        <div class="col-sm-4 text-muted">Vulnerability ID:</div>
                                        <div class="col-sm-8">
                                            ${vulnLink.url ? 
                                                `<a href="#" class="text-primary text-decoration-none fw-bold" 
                                                   onclick="vulnDetailsModal.lookupVulnerability('${vulnLink.id}')">${vulnLink.id}</a>` :
                                                `<span class="fw-bold text-muted">${vulnLink.id}</span>`
                                            }
                                            ${vulnLink.type === "cisco" ? 
                                                "<small class=\"text-warning ms-2\">(Cisco Advisory)</small>" : 
                                                vulnLink.type === "plugin" ? 
                                                "<small class=\"text-muted ms-2\">(Plugin ID)</small>" : ""
                                            }
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="row">
                                        <div class="col-sm-4 text-muted">Plugin Name:</div>
                                        <div class="col-sm-8">${vulnerability.plugin_name || "N/A"}</div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="row">
                                        <div class="col-sm-4 text-muted">Description:</div>
                                        <div class="col-sm-8">${vulnerability.description || "No description available"}</div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="row">
                                        <div class="col-sm-4 text-muted">Family:</div>
                                        <div class="col-sm-8">${vulnerability.family || "N/A"}</div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="row">
                                        <div class="col-sm-4 text-muted">Solution:</div>
                                        <div class="col-sm-8">${vulnerability.solution || "No solution provided"}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-chart-line me-2"></i>
                                    Risk Summary
                                </h6>
                            </div>
                            <div class="card-body">
                                ${this.generateRiskSummaryCards(vulnerability)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    }

    /**
     * Populate the Vendor Intelligence tab with API integration stubs
     */
    async populateVendorIntelligenceTab(vulnerability) {
        const vendorContent = document.getElementById("vulnVendorContent");
        if (vendorContent) {
            const vulnLink = this.getVulnerabilityLink(vulnerability);
            const isCiscoAdvisory = vulnLink.type === "cisco";
            const hasTenablePlugin = vulnerability.plugin_id && vulnerability.plugin_id !== "N/A";

            vendorContent.innerHTML = `
                <div class="row">
                    ${isCiscoAdvisory ? this.generateCiscoIntelligenceStub(vulnLink.id) : ""}
                    ${hasTenablePlugin ? this.generateTenableIntelligenceStub(vulnerability.plugin_id) : ""}
                    ${!isCiscoAdvisory && !hasTenablePlugin ? this.generateGenericVendorInfo(vulnerability) : ""}
                </div>
            `;
        }
    }

    /**
     * Populate the Risk Assessment tab with enhanced risk analysis
     */
    async populateRiskAssessmentTab(vulnerability) {
        const riskContent = document.getElementById("vulnRiskContent");
        if (riskContent) {
            riskContent.innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-tachometer-alt me-2"></i>
                                    VPR Score Breakdown
                                </h6>
                            </div>
                            <div class="card-body">
                                ${this.generateVPRBreakdown(vulnerability)}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    CVSS Analysis
                                </h6>
                            </div>
                            <div class="card-body">
                                ${this.generateCVSSAnalysis(vulnerability)}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-bullseye me-2"></i>
                                    Business Impact
                                </h6>
                            </div>
                            <div class="card-body">
                                ${this.generateBusinessImpactAnalysis(vulnerability)}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-shield-alt me-2"></i>
                                    Compliance Framework Mapping
                                </h6>
                            </div>
                            <div class="card-body">
                                ${this.generateComplianceMapping(vulnerability)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    }

    /**
     * Populate the Affected Assets tab with optimized table structure
     */
    async populateAffectedAssetsTab(vulnerability, dataManager) {
        const assetsContent = document.getElementById("vulnAssetsContent");
        if (assetsContent) {
            // Get affected assets data
            const affectedAssets = await this.getAffectedAssets(vulnerability, dataManager);
            
            assetsContent.innerHTML = `
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-server me-2"></i>
                            Affected Assets
                        </h6>
                        <span class="badge bg-secondary" id="affectedAssetsCount">${affectedAssets.length} assets</span>
                    </div>
                    <div class="card-body">
                        <div id="vulnAffectedAssetsGrid" style="height: 400px; width: 100%;" class="ag-theme-alpine"></div>
                    </div>
                </div>
            `;

            // Initialize the optimized AG Grid
            setTimeout(() => {
                this.initializeAffectedAssetsGrid(affectedAssets);
            }, 100);
        }
    }

    /**
     * Initialize the enhanced affected assets AG Grid with optimized columns
     */
    initializeAffectedAssetsGrid(assetsData) {
        const gridDiv = document.querySelector("#vulnAffectedAssetsGrid");
        if (!gridDiv) {return;}

        // Enhanced column definitions based on research recommendations
        const columnDefs = [
            // Asset Details Group
            {
                headerName: "Hostname",
                field: "hostname",
                cellRenderer: (params) => {
                    return `<a href="#" class="text-primary fw-bold" onclick="vulnManager?.viewDeviceDetails('${params.value}')">${params.value}</a>`;
                },
                minWidth: 150,
                flex: 1
            },
            {
                headerName: "IP Address",
                field: "ip_address",
                cellRenderer: (params) => {
                    const ip = params.value || "N/A";
                    return ip !== "N/A" ? `<code class="text-muted">${ip}</code>` : "<span class=\"text-muted\">N/A</span>";
                },
                minWidth: 120
            },
            
            // Risk Metrics Group
            {
                headerName: "VPR Score",
                field: "vpr_score",
                cellRenderer: (params) => {
                    const score = parseFloat(params.value) || 0;
                    const color = score >= 9 ? "red" : score >= 7 ? "orange" : score >= 4 ? "yellow" : "green";
                    return `<span class="badge bg-${color}-lt text-${color} fw-bold">${score.toFixed(1)}</span>`;
                },
                minWidth: 100,
                sortable: true,
                comparator: (valueA, valueB) => parseFloat(valueA) - parseFloat(valueB)
            },
            {
                headerName: "CVSS Score",
                field: "cvss_score",
                cellRenderer: (params) => {
                    const score = parseFloat(params.value) || 0;
                    return score > 0 ? `<span class="badge bg-secondary">${score.toFixed(1)}</span>` : "<span class=\"text-muted\">N/A</span>";
                },
                minWidth: 100,
                sortable: true
            },
            {
                headerName: "Severity",
                field: "severity",
                cellRenderer: (params) => {
                    const severity = params.value || "Low";
                    const color = severity === "Critical" ? "red" : 
                                severity === "High" ? "orange" : 
                                severity === "Medium" ? "yellow" : "green";
                    return `<span class="badge bg-${color}">${severity}</span>`;
                },
                minWidth: 100
            },
            
            // Timeline Group
            {
                headerName: "First Seen",
                field: "first_seen",
                cellRenderer: (params) => {
                    return params.value ? new Date(params.value).toLocaleDateString() : "N/A";
                },
                minWidth: 110,
                sortable: true
            },
            {
                headerName: "Last Seen",
                field: "last_seen",
                cellRenderer: (params) => {
                    if (params.value && params.value.trim() !== "") {
                        return new Date(params.value).toLocaleDateString();
                    } else if (params.data.scan_date && params.data.scan_date.trim() !== "") {
                        return new Date(params.data.scan_date).toLocaleDateString();
                    }
                    return "N/A";
                },
                minWidth: 110,
                sortable: true
            },
            
            // Vendor Info Group
            {
                headerName: "Plugin ID",
                field: "plugin_id",
                cellRenderer: (params) => {
                    return params.value ? `<code class="text-info">${params.value}</code>` : "N/A";
                },
                minWidth: 100
            },
            {
                headerName: "Vendor",
                field: "vendor",
                cellRenderer: (params) => {
                    const vendor = params.value || "Generic";
                    const icon = vendor.toLowerCase().includes("tenable") ? "fa-shield-alt" :
                                vendor.toLowerCase().includes("cisco") ? "fa-network-wired" :
                                "fa-cube";
                    return `<i class="fas ${icon} me-1"></i>${vendor}`;
                },
                minWidth: 120
            }
        ];

        const gridOptions = {
            columnDefs: columnDefs,
            rowData: assetsData,
            defaultColDef: {
                sortable: true,
                filter: true,
                resizable: true
            },
            pagination: true,
            paginationPageSize: 15,
            animateRows: true,
            rowSelection: "multiple",
            suppressRowClickSelection: true
        };

        // Create the grid
        this.affectedAssetsGrid = new agGrid.Grid(gridDiv, gridOptions);
        this.affectedAssetsGridApi = gridOptions.api;
    }

    /**
     * Get affected assets data for the vulnerability
     */
    async getAffectedAssets(vulnerability, _dataManager) {
        // This would typically fetch from API or use dataManager
        // For now, return mock data structure that matches the expected format
        const mockAssets = [
            {
                hostname: "server-001.domain.com",
                ip_address: "192.168.1.10",
                vpr_score: vulnerability.vpr_score || 7.5,
                cvss_score: vulnerability.cvss_score || 8.0,
                severity: vulnerability.severity || "High",
                first_seen: vulnerability.first_seen || new Date().toISOString(),
                last_seen: vulnerability.last_seen || new Date().toISOString(),
                plugin_id: vulnerability.plugin_id || "12345",
                vendor: "Tenable",
                scan_date: vulnerability.scan_date
            }
        ];

        return mockAssets;
    }

    /**
     * Generate risk summary cards for the overview
     */
    generateRiskSummaryCards(vulnerability) {
        const vprScore = parseFloat(vulnerability.vpr_score) || 0;
        const _severity = vulnerability.severity || "Low";
        const severityColor = severity === "Critical" ? "red" : 
                            severity === "High" ? "orange" : 
                            severity === "Medium" ? "yellow" : "green";
        
        return `
            <div class="row">
                <div class="col-6">
                    <div class="card card-sm bg-${vprScore >= 9 ? "red" : vprScore >= 7 ? "orange" : vprScore >= 4 ? "yellow" : "green"}-lt">
                        <div class="card-body text-center">
                            <div class="text-${vprScore >= 9 ? "red" : vprScore >= 7 ? "orange" : vprScore >= 4 ? "yellow" : "green"} h2 mb-1">${vprScore.toFixed(1)}</div>
                            <div class="text-muted small">VPR Score</div>
                            <div class="text-muted small mt-1">
                                ${vprScore >= 9 ? "Critical Risk" : vprScore >= 7 ? "High Risk" : vprScore >= 4 ? "Medium Risk" : "Low Risk"}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card card-sm bg-${severityColor}-lt">
                        <div class="card-body text-center">
                            <div class="text-${severityColor} h3 mb-1">${severity}</div>
                            <div class="text-muted small">Severity</div>
                            <div class="text-muted small mt-1">CVSS Based</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * Generate Cisco intelligence stub content
     */
    generateCiscoIntelligenceStub(advisoryId) {
        return `
            <div class="col-md-6">
                <div class="card border-warning">
                    <div class="card-header bg-warning-lt">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-network-wired me-2"></i>
                            Cisco Security Advisory
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <strong>Advisory ID:</strong> <code>${advisoryId}</code>
                        </div>
                        <div class="mb-3">
                            <strong>Status:</strong> <span class="badge bg-info">API Integration Available</span>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Enhanced Cisco security advisory information will be displayed here when API integration is enabled.
                        </div>
                        <div class="placeholder-glow">
                            <div class="placeholder col-12 mb-2"></div>
                            <div class="placeholder col-8 mb-2"></div>
                            <div class="placeholder col-10"></div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * Generate Tenable intelligence stub content
     */
    generateTenableIntelligenceStub(pluginId) {
        return `
            <div class="col-md-6">
                <div class="card border-success">
                    <div class="card-header bg-success-lt">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-shield-alt me-2"></i>
                            Tenable Plugin Intelligence
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <strong>Plugin ID:</strong> <code>${pluginId}</code>
                        </div>
                        <div class="mb-3">
                            <strong>Status:</strong> <span class="badge bg-info">API Integration Available</span>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Enhanced Tenable plugin intelligence and VPR context will be displayed here when API integration is enabled.
                        </div>
                        <div class="placeholder-glow">
                            <div class="placeholder col-12 mb-2"></div>
                            <div class="placeholder col-6 mb-2"></div>
                            <div class="placeholder col-9"></div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * Generate generic vendor information
     */
    generateGenericVendorInfo(vulnerability) {
        return `
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-cube me-2"></i>
                            Vendor Information
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-light">
                            <i class="fas fa-info-circle me-2"></i>
                            No specific vendor intelligence available for this vulnerability. Enhanced vendor-specific information will be displayed here when vendor APIs are integrated.
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <strong>Plugin Family:</strong> ${vulnerability.family || "N/A"}
                                </div>
                                <div class="mb-3">
                                    <strong>Plugin ID:</strong> ${vulnerability.plugin_id || "N/A"}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <strong>Vendor:</strong> ${vulnerability.vendor || "Generic"}
                                </div>
                                <div class="mb-3">
                                    <strong>Classification:</strong> Security Vulnerability
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * Generate VPR breakdown analysis
     */
    generateVPRBreakdown(vulnerability) {
        const vprScore = parseFloat(vulnerability.vpr_score) || 0;
        const _factors = [
            { name: "Age of Vulnerability", weight: 0.15, score: Math.min(vprScore * 1.2, 10) },
            { name: "Exploit Code Maturity", weight: 0.20, score: Math.min(vprScore * 0.9, 10) },
            { name: "Product Coverage", weight: 0.15, score: Math.min(vprScore * 1.1, 10) },
            { name: "Threat Intensity", weight: 0.25, score: Math.min(vprScore * 0.8, 10) },
            { name: "Threat Recency", weight: 0.25, score: Math.min(vprScore * 1.0, 10) }
        ];

        return `
            <div class="mb-3 text-center">
                <div class="text-${vprScore >= 9 ? "red" : vprScore >= 7 ? "orange" : vprScore >= 4 ? "yellow" : "green"} display-6 mb-1">${vprScore.toFixed(1)}</div>
                <div class="text-muted">Overall VPR Score</div>
            </div>
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Enhanced VPR factor analysis will be available when Tenable API integration is enabled.
            </div>
            <div class="placeholder-glow">
                <div class="placeholder col-12 mb-2"></div>
                <div class="placeholder col-8 mb-2"></div>
                <div class="placeholder col-10"></div>
            </div>
        `;
    }

    /**
     * Generate CVSS analysis
     */
    generateCVSSAnalysis(vulnerability) {
        const cvssScore = parseFloat(vulnerability.cvss_score) || 0;
        const _severity = vulnerability.severity || "Low";
        
        return `
            <div class="mb-3 text-center">
                <div class="text-${severity === "Critical" ? "red" : severity === "High" ? "orange" : severity === "Medium" ? "yellow" : "green"} display-6 mb-1">${cvssScore.toFixed(1)}</div>
                <div class="text-muted">CVSS v3.1 Score</div>
            </div>
            <div class="mb-3">
                <div class="row">
                    <div class="col-6 text-muted small">Severity:</div>
                    <div class="col-6">
                        <span class="badge bg-${severity === "Critical" ? "red" : severity === "High" ? "orange" : severity === "Medium" ? "yellow" : "green"}">${severity}</span>
                    </div>
                </div>
            </div>
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Detailed CVSS vector analysis will be available when enhanced vulnerability data is integrated.
            </div>
        `;
    }

    /**
     * Generate business impact analysis
     */
    generateBusinessImpactAnalysis(vulnerability) {
        const vprScore = parseFloat(vulnerability.vpr_score) || 0;
        const _severity = vulnerability.severity || "Low";
        
        return `
            <div class="mb-3">
                <div class="row">
                    <div class="col-6 text-muted small">Asset Criticality:</div>
                    <div class="col-6">
                        <span class="badge bg-secondary">Medium</span>
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <div class="row">
                    <div class="col-6 text-muted small">Business Risk:</div>
                    <div class="col-6">
                        <span class="badge bg-${vprScore >= 7 ? "red" : vprScore >= 4 ? "orange" : "green"}">
                            ${vprScore >= 7 ? "High" : vprScore >= 4 ? "Medium" : "Low"}
                        </span>
                    </div>
                </div>
            </div>
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Enhanced business impact assessment with Asset Criticality Rating (ACR) will be available when Tenable API integration is enabled.
            </div>
        `;
    }

    /**
     * Generate compliance framework mapping
     */
    generateComplianceMapping(_vulnerability) {
        return `
            <div class="row">
                <div class="col-md-3">
                    <div class="card card-sm">
                        <div class="card-body text-center">
                            <div class="text-blue h4 mb-1">PCI-DSS</div>
                            <div class="text-muted small">Payment Card</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-sm">
                        <div class="card-body text-center">
                            <div class="text-green h4 mb-1">SOX</div>
                            <div class="text-muted small">Financial</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-sm">
                        <div class="card-body text-center">
                            <div class="text-purple h4 mb-1">NIST</div>
                            <div class="text-muted small">Cybersecurity</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-sm">
                        <div class="card-body text-center">
                            <div class="text-orange h4 mb-1">GDPR</div>
                            <div class="text-muted small">Data Privacy</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="alert alert-info mt-3">
                <i class="fas fa-info-circle me-2"></i>
                Detailed compliance framework mapping and requirements will be available when enhanced vulnerability intelligence is integrated.
            </div>
        `;
    }

    /**
     * Handle tab switching to load content dynamically
     */
    onTabShown(targetTab) {
        // Refresh grid when assets tab is shown
        if (targetTab === "#vulnAssetsTab" && this.affectedAssetsGrid) {
            setTimeout(() => {
                this.affectedAssetsGrid.api.sizeColumnsToFit();
            }, 100);
        }
    }

    /**
     * Export vulnerability data as CSV
     */
    exportVulnerabilityCSV() {
        const modal = document.getElementById("vulnDetailsModal");
        if (!modal || !modal.classList.contains("show")) {
            return;
        }

        if (!this.currentVulnerability) {
            console.error("No vulnerability data available for export");
            return;
        }

        // Create CSV data from current vulnerability and affected assets
        const vulnerability = this.currentVulnerability;
        const csvData = [];

        // Add vulnerability header info
        csvData.push({
            "Export Type": "Vulnerability Details",
            "Generated": new Date().toLocaleString(),
            "Vulnerability ID": vulnerability.cve || vulnerability.plugin_id || "N/A",
            "Plugin Name": vulnerability.plugin_name || "N/A",
            "Severity": vulnerability.severity || "N/A",
            "VPR Score": vulnerability.vpr_score || "N/A",
            "CVSS Score": vulnerability.cvss_score || "N/A",
            "Description": vulnerability.description || "N/A",
            "Family": vulnerability.family || "N/A",
            "Solution": vulnerability.solution || "N/A"
        });

        // Convert to CSV and download
        const csv = Papa.unparse(csvData);
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `vulnerability_details_${new Date().toISOString().split("T")[0]}.csv`);
        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        this.showToast?.("Vulnerability details exported to CSV", "success");
    }

    /**
     * Generate comprehensive vulnerability report
     */
    generateVulnerabilityReport() {
        const modal = document.getElementById("vulnDetailsModal");
        if (!modal || !modal.classList.contains("show")) {
            return;
        }

        if (!this.currentVulnerability) {
            console.error("No vulnerability data available for report generation");
            return;
        }

        // Open report in new popup window for printing/PDF generation
        const reportWindow = window.open("", "_blank", "width=1200,height=800,scrollbars=yes,resizable=yes");
        
        const vulnerability = this.currentVulnerability;
        const vulnLink = this.getVulnerabilityLink(vulnerability);
        
        const reportHTML = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>Vulnerability Report - ${vulnLink.id}</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                <style>
                    body { font-size: 12px; }
                    .report-header { border-bottom: 2px solid #007bff; margin-bottom: 20px; padding-bottom: 10px; }
                    .badge { font-size: 0.8em; }
                    @media print {
                        .btn { display: none; }
                        .report-header { border-bottom: 2px solid #000; }
                    }
                </style>
            </head>
            <body class="container my-4">
                <div class="report-header">
                    <h2>Vulnerability Detailed Report</h2>
                    <p class="text-muted mb-0">Generated: ${new Date().toLocaleString()}</p>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h4>Vulnerability Information</h4>
                        <table class="table table-sm">
                            <tr><td><strong>ID:</strong></td><td>${vulnLink.id}</td></tr>
                            <tr><td><strong>Plugin Name:</strong></td><td>${vulnerability.plugin_name || "N/A"}</td></tr>
                            <tr><td><strong>Severity:</strong></td><td><span class="badge bg-${vulnerability.severity === "Critical" ? "danger" : vulnerability.severity === "High" ? "warning" : "secondary"}">${vulnerability.severity || "N/A"}</span></td></tr>
                            <tr><td><strong>VPR Score:</strong></td><td>${vulnerability.vpr_score || "N/A"}</td></tr>
                            <tr><td><strong>CVSS Score:</strong></td><td>${vulnerability.cvss_score || "N/A"}</td></tr>
                            <tr><td><strong>Family:</strong></td><td>${vulnerability.family || "N/A"}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h4>Risk Assessment</h4>
                        <div class="alert alert-${vulnerability.severity === "Critical" ? "danger" : vulnerability.severity === "High" ? "warning" : "info"}">
                            <strong>Risk Level:</strong> ${vulnerability.severity || "Low"}<br>
                            <strong>VPR Score:</strong> ${vulnerability.vpr_score || "N/A"}<br>
                            <strong>Business Impact:</strong> ${parseFloat(vulnerability.vpr_score) >= 7 ? "High" : parseFloat(vulnerability.vpr_score) >= 4 ? "Medium" : "Low"}
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-12">
                        <h4>Description</h4>
                        <p class="border p-3 bg-light">${vulnerability.description || "No description available"}</p>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-12">
                        <h4>Solution</h4>
                        <p class="border p-3 bg-light">${vulnerability.solution || "No solution provided"}</p>
                    </div>
                </div>
                
                <div class="text-center mb-4">
                    <button class="btn btn-primary me-2" onclick="window.print()">
                        <i class="fas fa-print me-1"></i>Print Report
                    </button>
                    <button class="btn btn-secondary" onclick="window.close()">
                        <i class="fas fa-times me-1"></i>Close
                    </button>
                </div>
            </body>
            </html>
        `;

        reportWindow.document.write(reportHTML);
        reportWindow.document.close();
        reportWindow.focus();

        this.showToast?.("Vulnerability report opened in new window", "success");
    }

    /**
     * Determine vulnerability ID type and create appropriate link
     */
    getVulnerabilityLink(vulnData) {
        const { cve, plugin_name } = vulnData;
        
        // Check for CVE first
        if (cve && cve.startsWith("CVE-")) {
            return {
                id: cve,
                type: "cve",
                url: `https://cve.mitre.org/cgi-bin/cvename.cgi?name=${cve.trim()}`
            };
        }
        
        // Check for Cisco SA ID in plugin name
        const ciscoId = this.extractCiscoVulnId(plugin_name);
        if (ciscoId) {
            return {
                id: ciscoId,
                type: "cisco",
                url: `https://www.cisco.com/c/en/us/support/docs/csa/${ciscoId}.html`
            };
        }
        
        // Fall back to plugin ID
        return {
            id: `Plugin ${vulnData.plugin_id}`,
            type: "plugin",
            url: null
        };
    }

    /**
     * Extract Cisco vulnerability ID from plugin name
     */
    extractCiscoVulnId(pluginName) {
        if (!pluginName || typeof pluginName !== "string") {
            return null;
        }
        
        // Look for cisco-sa- pattern in plugin name
        const ciscoSaMatch = pluginName.match(/cisco-sa-([a-zA-Z0-9-]+)/i);
        if (ciscoSaMatch) {
            return `cisco-sa-${ciscoSaMatch[1]}`;
        }
        
        return null;
    }

    /**
     * Lookup vulnerability in external resources
     */
    async lookupVulnerability(vulnId, pluginName = null) {
        // If CVE, use existing CVE lookup
        if (vulnId && vulnId.startsWith("CVE-")) {
            return this.lookupCVE(vulnId);
        }
        
        // If it looks like a Cisco SA ID, open Cisco advisory
        if (vulnId && vulnId.startsWith("cisco-sa-")) {
            const popup = window.open(
                `https://www.cisco.com/c/en/us/support/docs/csa/${vulnId}.html`,
                `Cisco_Advisory_${vulnId.replace(/[^a-zA-Z0-9]/g, "_")}`,
                "width=1200,height=800,scrollbars=yes,resizable=yes,menubar=no,toolbar=no,location=yes,status=yes"
            );
            
            if (popup) {
                popup.focus();
                this.showToast?.(`Opened Cisco advisory for ${vulnId}`, "success");
            } else {
                this.showToast?.("Popup blocked - please allow popups for vulnerability lookups", "warning");
            }
            return;
        }
        
        // If we have plugin name, try to extract Cisco ID from it
        if (pluginName) {
            const ciscoId = this.extractCiscoVulnId(pluginName);
            if (ciscoId) {
                return this.lookupVulnerability(ciscoId);
            }
        }
        
        // Default fallback
        this.showToast?.("No external vulnerability reference available for this item", "info");
    }

    /**
     * Lookup CVE information
     */
    async lookupCVE(cveId) {
        const cveIds = cveId.includes(",") ? cveId.split(",").map(id => id.trim()) 
                                           : cveId.includes(" ") ? cveId.split(" ").filter(id => id.startsWith("CVE-"))
                                           : [cveId.trim()];

        cveIds.forEach(id => {
            const popup = window.open(
                `https://cve.mitre.org/cgi-bin/cvename.cgi?name=${id}`,
                `CVE_Lookup_${id.replace(/[^a-zA-Z0-9]/g, "_")}`,
                "width=1200,height=800,scrollbars=yes,resizable=yes,menubar=no,toolbar=no,location=yes,status=yes"
            );
            
            if (popup) {
                popup.focus();
            }
        });

        if (cveIds.length > 0) {
            this.showToast?.(`Opened CVE lookup for ${cveIds.join(", ")}`, "success");
        } else {
            this.showToast?.("Popup blocked - please allow popups for CVE lookups", "warning");
        }
    }

    /**
     * Show toast message (delegated to main app if available)
     */
    showToast(message, type = "info") {
        if (window.vulnManager && typeof window.vulnManager.showToast === "function") {
            window.vulnManager.showToast(message, type);
        } else {
            console.log(`Toast (${type}): ${message}`);
        }
    }
}

// Initialize the vulnerability details modal when DOM is ready
document.addEventListener("DOMContentLoaded", function() {
    window.vulnDetailsModal = new VulnerabilityDetailsModal();
});

// Export for module systems
if (typeof module !== "undefined" && module.exports) {
    module.exports = VulnerabilityDetailsModal;
}