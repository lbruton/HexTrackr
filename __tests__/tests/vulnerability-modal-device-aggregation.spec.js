// @ts-check
const { test, expect } = require('@playwright/test');

test('Vulnerability Modal Device Aggregation Test', async ({ page }) => {
  console.log('Starting vulnerability modal device aggregation test...');

  // Navigate to vulnerabilities page
  await page.goto('http://localhost:8080/vulnerabilities.html');
  await page.waitForLoadState('networkidle');

  // Wait for the data to load
  await page.waitForTimeout(3000);

  // Look for vulnerabilities in the grid that might have multiple devices
  console.log('Looking for vulnerabilities with multiple devices...');

  // Try to find a vulnerability row that we can click on
  // First, let's check if the grid has loaded
  await page.waitForSelector('.ag-root-wrapper', { timeout: 10000 });

  // Look for vulnerability rows in the grid
  const vulnerabilityRows = await page.locator('.ag-row').count();
  console.log(`Found ${vulnerabilityRows} vulnerability rows in the grid`);

  if (vulnerabilityRows === 0) {
    console.log('No vulnerabilities found in grid, test cannot proceed');
    throw new Error('No vulnerabilities found in the grid to test with');
  }

  // Click on the first vulnerability row to open the modal
  const firstRow = page.locator('.ag-row').first();
  await firstRow.click();
  
  console.log('Clicked on first vulnerability row');

  // Wait for the vulnerability details modal to appear
  await page.waitForSelector('.vulnerability-details-modal', { timeout: 10000 });
  console.log('Vulnerability details modal appeared');

  // Check if the modal content loaded
  await page.waitForSelector('.vulnerability-details-modal .modal-content', { timeout: 5000 });

  // Look for the affected assets section
  const affectedAssetsSection = page.locator('.vulnerability-details-modal').locator('text=Affected Assets').first();
  await expect(affectedAssetsSection).toBeVisible();
  console.log('Found Affected Assets section');

  // Check for the device count in risk summary or affected assets area
  // This should show more than 1 device if the aggregation is working
  const modalContent = page.locator('.vulnerability-details-modal .modal-content');
  
  // Look for any device count indicators
  const deviceCountElements = await modalContent.locator('text=/\\d+\\s+(device|asset|host)/i').count();
  console.log(`Found ${deviceCountElements} device count indicators`);

  // Check if there's an affected assets grid/table
  const assetsGrid = modalContent.locator('.ag-root-wrapper, .assets-grid, .devices-grid, table');
  const hasAssetsGrid = await assetsGrid.count() > 0;
  
  if (hasAssetsGrid) {
    console.log('Found assets/devices grid in modal');
    
    // Count rows in the assets grid if it exists
    const assetRows = await assetsGrid.locator('.ag-row, tr').count();
    console.log(`Assets grid has ${assetRows} rows`);
    
    // If there are multiple rows (excluding header), the aggregation is working
    if (assetRows > 1) {
      console.log('SUCCESS: Modal shows multiple devices/assets');
    } else {
      console.log('WARNING: Only showing 1 or fewer assets - may indicate aggregation issue');
    }
  } else {
    console.log('No assets grid found - checking for other device indicators');
    
    // Look for any text that might indicate multiple devices
    const modalText = await modalContent.textContent();
    const hasMultipleDevices = /(\d+)\s+(devices?|assets?|hosts?)/i.test(modalText || '');
    
    if (hasMultipleDevices) {
      console.log('SUCCESS: Found text indicating multiple devices');
    } else {
      console.log('INFO: No clear indication of device count in modal text');
    }
  }

  // Take a screenshot for verification
  await page.screenshot({ 
    path: '.playwright-mcp/vulnerability-modal-test.png',
    fullPage: true 
  });
  console.log('Screenshot saved to .playwright-mcp/vulnerability-modal-test.png');

  // Verify modal has proper content structure
  await expect(modalContent).toBeVisible();
  await expect(modalContent).toContainText(/CVE-\d{4}-\d+|vulnerability/i);

  // Test that the modal can be closed
  const closeButton = page.locator('.vulnerability-details-modal .close, .vulnerability-details-modal .modal-close, .vulnerability-details-modal [aria-label="Close"]').first();
  if (await closeButton.count() > 0) {
    await closeButton.click();
    await expect(page.locator('.vulnerability-details-modal')).not.toBeVisible();
    console.log('Modal closed successfully');
  } else {
    console.log('Close button not found, modal might auto-close or use different mechanism');
  }

  console.log('Vulnerability modal device aggregation test completed');
});