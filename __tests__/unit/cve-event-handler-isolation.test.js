/**
 * @fileoverview Jest Unit Tests for CVE Event Handler Isolation
 * Tests individual CVE click targeting and event handler isolation
 * 
 * @version 1.0.0
 * @date 2025-09-10
 * @spec 004-cve-link-system-fix
 * @task T028 - Create Jest unit tests for CVE event handler isolation
 * @author Curly (with soitenly isolated event testing!)
 */

/* global describe, test, expect, beforeEach, afterEach, jest, document, window */

// Mock DOM environment
const { JSDOM } = require('jsdom');

describe('CVE Event Handler Isolation Unit Tests', () => {
    let dom;
    let document;
    let window;
    let CVEUtilities;
    let mockVulnDetailsModal;
    let mockDataManager;

    beforeEach(() => {
        // Setup JSDOM environment
        dom = new JSDOM('<!DOCTYPE html><html><body></body></html>');
        document = dom.window.document;
        window = dom.window;
        
        // Add to global for modules
        global.document = document;
        global.window = window;
        
        // Mock CVE Utilities module
        CVEUtilities = {
            parseCVEString: jest.fn(),
            createMultipleCVELinks: jest.fn(),
            attachCVEEventHandlers: jest.fn(),
            removeCVEEventHandlers: jest.fn(),
            handleCVEClick: jest.fn()
        };

        // Mock vulnerability details modal
        mockVulnDetailsModal = {
            showVulnerabilityDetailsByCVE: jest.fn(),
            clearModalStateData: jest.fn(),
            currentOperationId: null,
            isModalOperationInProgress: false
        };

        // Mock data manager
        mockDataManager = {
            vulnerabilities: [
                {
                    id: 1,
                    hostname: 'device1.test.local',
                    cve: 'CVE-2024-0001',
                    severity: 'High',
                    plugin_name: 'Test Plugin 1',
                    description: 'Test vulnerability 1'
                },
                {
                    id: 2,
                    hostname: 'device2.test.local',
                    cve: 'CVE-2024-0002',
                    severity: 'Critical',
                    plugin_name: 'Test Plugin 2',
                    description: 'Test vulnerability 2'
                }
            ]
        };

        // Setup globals
        window.vulnDetailsModal = mockVulnDetailsModal;
        window.vulnManager = { dataManager: mockDataManager };
        global.CVEUtilities = CVEUtilities;

        console.log('üß™ Test environment setup complete');
    });

    afterEach(() => {
        // Cleanup
        delete global.document;
        delete global.window;
        delete global.CVEUtilities;
        jest.clearAllMocks();
    });

    describe('Individual CVE Click Targeting', () => {
        test('should target specific CVE ID when clicked', () => {
            console.log('üéØ Testing individual CVE click targeting...');

            // Create test container with multiple CVE links
            const container = document.createElement('div');
            container.innerHTML = `
                <div class="test-row">
                    <a href="#" class="vulnerability-cve" data-cve="CVE-2024-0001">CVE-2024-0001</a>
                    <a href="#" class="vulnerability-cve" data-cve="CVE-2024-0002">CVE-2024-0002</a>
                    <a href="#" class="vulnerability-cve" data-cve="CVE-2024-0003">CVE-2024-0003</a>
                </div>
            `;
            document.body.appendChild(container);

            // Create event handler that captures clicked CVE ID
            let capturedCVEId = null;
            const testHandler = (cveId) => {
                capturedCVEId = cveId;
                console.log(`Handler received CVE: ${cveId}`);
            };

            // Attach event handlers using event delegation
            container.addEventListener('click', (event) => {
                if (event.target.classList.contains('vulnerability-cve')) {
                    event.preventDefault();
                    const cveId = event.target.getAttribute('data-cve');
                    testHandler(cveId);
                }
            });

            // Test clicking specific CVE links
            const testCases = [
                { cve: 'CVE-2024-0001', index: 0 },
                { cve: 'CVE-2024-0002', index: 1 },
                { cve: 'CVE-2024-0003', index: 2 }
            ];

            testCases.forEach(testCase => {
                const link = container.querySelectorAll('.vulnerability-cve')[testCase.index];
                link.click();
                
                expect(capturedCVEId).toBe(testCase.cve);
                console.log(`‚úÖ Click on ${testCase.cve} correctly targeted`);
            });

            document.body.removeChild(container);
        });

        test('should prevent "all CVE" behavior in multi-CVE scenarios', () => {
            console.log('üö´ Testing prevention of "all CVE" behavior...');

            // Create row with multiple CVEs
            const multiCVERow = document.createElement('div');
            multiCVERow.innerHTML = `
                <div class="vulnerability-row">
                    <span class="device">device1.test.local</span>
                    <span class="cve-links">
                        <a href="#" class="vulnerability-cve" data-cve="CVE-2024-1001">CVE-2024-1001</a>,
                        <a href="#" class="vulnerability-cve" data-cve="CVE-2024-1002">CVE-2024-1002</a>,
                        <a href="#" class="vulnerability-cve" data-cve="CVE-2024-1003">CVE-2024-1003</a>
                    </span>
                </div>
            `;
            document.body.appendChild(multiCVERow);

            // Track all handler calls
            const handlerCalls = [];
            const isolatedHandler = (cveId) => {
                handlerCalls.push(cveId);
                console.log(`Isolated handler called with: ${cveId}`);
            };

            // Attach isolated event handlers
            const cveLinks = multiCVERow.querySelectorAll('.vulnerability-cve');
            cveLinks.forEach(link => {
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    event.stopPropagation(); // Critical: prevent event bubbling
                    const cveId = event.target.getAttribute('data-cve');
                    isolatedHandler(cveId);
                });
            });

            // Click middle CVE link
            const middleLink = cveLinks[1];
            middleLink.click();

            // Should only have one handler call for the specific CVE
            expect(handlerCalls.length).toBe(1);
            expect(handlerCalls[0]).toBe('CVE-2024-1002');
            
            console.log('‚úÖ Multi-CVE isolation working - no "all CVE" behavior');

            document.body.removeChild(multiCVERow);
        });

        test('should handle event delegation correctly', () => {
            console.log('üìã Testing event delegation patterns...');

            // Create dynamic container that will have CVE links added
            const dynamicContainer = document.createElement('div');
            dynamicContainer.className = 'dynamic-cve-container';
            document.body.appendChild(dynamicContainer);

            // Setup event delegation on container
            const delegatedCalls = [];
            dynamicContainer.addEventListener('click', (event) => {
                if (event.target.classList.contains('vulnerability-cve')) {
                    event.preventDefault();
                    const cveId = event.target.getAttribute('data-cve');
                    delegatedCalls.push(cveId);
                    console.log(`Delegated handler: ${cveId}`);
                }
            });

            // Dynamically add CVE links (simulating AJAX load)
            const newCVEData = [
                'CVE-2024-2001',
                'CVE-2024-2002', 
                'CVE-2024-2003'
            ];

            newCVEData.forEach(cveId => {
                const link = document.createElement('a');
                link.href = '#';
                link.className = 'vulnerability-cve';
                link.setAttribute('data-cve', cveId);
                link.textContent = cveId;
                dynamicContainer.appendChild(link);
            });

            // Test that delegation works for dynamically added elements
            const dynamicLinks = dynamicContainer.querySelectorAll('.vulnerability-cve');
            
            // Click each dynamic link
            dynamicLinks.forEach((link, index) => {
                link.click();
                expect(delegatedCalls[index]).toBe(newCVEData[index]);
            });

            expect(delegatedCalls.length).toBe(3);
            console.log('‚úÖ Event delegation working for dynamic content');

            document.body.removeChild(dynamicContainer);
        });
    });

    describe('Event Handler Isolation Testing', () => {
        test('should isolate event handlers between different views', () => {
            console.log('üîÑ Testing event handler isolation between views...');

            // Create two different view containers
            const tableView = document.createElement('div');
            tableView.className = 'table-view';
            tableView.innerHTML = `
                <table>
                    <tr>
                        <td><a href="#" class="vulnerability-cve" data-cve="CVE-2024-TABLE-001">CVE-2024-TABLE-001</a></td>
                    </tr>
                </table>
            `;

            const cardsView = document.createElement('div');
            cardsView.className = 'cards-view';
            cardsView.innerHTML = `
                <div class="vulnerability-card">
                    <a href="#" class="vulnerability-cve" data-cve="CVE-2024-CARD-001">CVE-2024-CARD-001</a>
                </div>
            `;

            document.body.appendChild(tableView);
            document.body.appendChild(cardsView);

            // Setup isolated handlers for each view
            const tableHandler = jest.fn();
            const cardsHandler = jest.fn();

            // Table view handler
            tableView.addEventListener('click', (event) => {
                if (event.target.classList.contains('vulnerability-cve')) {
                    event.preventDefault();
                    const cveId = event.target.getAttribute('data-cve');
                    tableHandler(cveId);
                }
            });

            // Cards view handler
            cardsView.addEventListener('click', (event) => {
                if (event.target.classList.contains('vulnerability-cve')) {
                    event.preventDefault();
                    const cveId = event.target.getAttribute('data-cve');
                    cardsHandler(cveId);
                }
            });

            // Click table view CVE
            const tableLink = tableView.querySelector('.vulnerability-cve');
            tableLink.click();

            // Click cards view CVE
            const cardsLink = cardsView.querySelector('.vulnerability-cve');
            cardsLink.click();

            // Verify isolation - each handler only called for its view
            expect(tableHandler).toHaveBeenCalledTimes(1);
            expect(tableHandler).toHaveBeenCalledWith('CVE-2024-TABLE-001');
            
            expect(cardsHandler).toHaveBeenCalledTimes(1);
            expect(cardsHandler).toHaveBeenCalledWith('CVE-2024-CARD-001');

            console.log('‚úÖ Event handler isolation between views confirmed');

            document.body.removeChild(tableView);
            document.body.removeChild(cardsView);
        });

        test('should prevent handler interference in complex layouts', () => {
            console.log('üèóÔ∏è Testing handler isolation in complex layouts...');

            // Create complex nested layout
            const complexLayout = document.createElement('div');
            complexLayout.innerHTML = `
                <div class="main-container">
                    <div class="sidebar">
                        <a href="#" class="vulnerability-cve" data-cve="CVE-2024-SIDEBAR-001">CVE-2024-SIDEBAR-001</a>
                    </div>
                    <div class="content">
                        <div class="vulnerability-list">
                            <div class="vuln-item">
                                <a href="#" class="vulnerability-cve" data-cve="CVE-2024-CONTENT-001">CVE-2024-CONTENT-001</a>
                                <div class="nested-details">
                                    <a href="#" class="vulnerability-cve" data-cve="CVE-2024-NESTED-001">CVE-2024-NESTED-001</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(complexLayout);

            // Setup handlers with different priorities
            const handlerLog = [];

            // Global handler (should catch all)
            complexLayout.addEventListener('click', (event) => {
                if (event.target.classList.contains('vulnerability-cve')) {
                    const cveId = event.target.getAttribute('data-cve');
                    handlerLog.push(`global:${cveId}`);
                }
            });

            // Specific area handlers
            const sidebar = complexLayout.querySelector('.sidebar');
            sidebar.addEventListener('click', (event) => {
                if (event.target.classList.contains('vulnerability-cve')) {
                    event.stopPropagation(); // Prevent global handler
                    const cveId = event.target.getAttribute('data-cve');
                    handlerLog.push(`sidebar:${cveId}`);
                }
            });

            const content = complexLayout.querySelector('.content');
            content.addEventListener('click', (event) => {
                if (event.target.classList.contains('vulnerability-cve')) {
                    event.stopPropagation(); // Prevent global handler
                    const cveId = event.target.getAttribute('data-cve');
                    handlerLog.push(`content:${cveId}`);
                }
            });

            // Test clicks in different areas
            const sidebarLink = complexLayout.querySelector('.sidebar .vulnerability-cve');
            const contentLink = complexLayout.querySelector('.content .vulnerability-cve');
            const nestedLink = complexLayout.querySelector('.nested-details .vulnerability-cve');

            sidebarLink.click();
            contentLink.click();
            nestedLink.click();

            // Verify proper isolation and event handling
            expect(handlerLog).toContain('sidebar:CVE-2024-SIDEBAR-001');
            expect(handlerLog).toContain('content:CVE-2024-CONTENT-001');
            expect(handlerLog).toContain('content:CVE-2024-NESTED-001'); // Nested inherits parent

            // Should NOT have global handlers for sidebar/content (due to stopPropagation)
            expect(handlerLog).not.toContain('global:CVE-2024-SIDEBAR-001');
            expect(handlerLog).not.toContain('global:CVE-2024-CONTENT-001');

            console.log('Handler log:', handlerLog);
            console.log('‚úÖ Complex layout handler isolation working');

            document.body.removeChild(complexLayout);
        });
    });

    describe('Race Condition Prevention Testing', () => {
        test('should handle rapid consecutive CVE clicks', () => {
            console.log('‚ö° Testing rapid consecutive CVE clicks...');

            const container = document.createElement('div');
            container.innerHTML = `
                <a href="#" class="vulnerability-cve" data-cve="CVE-2024-RAPID-001">CVE-2024-RAPID-001</a>
                <a href="#" class="vulnerability-cve" data-cve="CVE-2024-RAPID-002">CVE-2024-RAPID-002</a>
            `;
            document.body.appendChild(container);

            // Track handler execution with timing
            const executionLog = [];
            let isHandling = false;

            const raceProtectedHandler = (cveId) => {
                if (isHandling) {
                    executionLog.push(`blocked:${cveId}`);
                    return;
                }

                isHandling = true;
                executionLog.push(`processing:${cveId}`);
                
                // Simulate async operation
                setTimeout(() => {
                    isHandling = false;
                    executionLog.push(`completed:${cveId}`);
                }, 10);
            };

            // Attach handler
            container.addEventListener('click', (event) => {
                if (event.target.classList.contains('vulnerability-cve')) {
                    event.preventDefault();
                    const cveId = event.target.getAttribute('data-cve');
                    raceProtectedHandler(cveId);
                }
            });

            // Rapid clicks
            const links = container.querySelectorAll('.vulnerability-cve');
            links[0].click(); // Should process
            links[1].click(); // Should be blocked
            links[0].click(); // Should be blocked

            // Check immediate results (before async completion)
            expect(executionLog).toContain('processing:CVE-2024-RAPID-001');
            expect(executionLog).toContain('blocked:CVE-2024-RAPID-002');
            expect(executionLog).toContain('blocked:CVE-2024-RAPID-001');

            console.log('Execution log:', executionLog);
            console.log('‚úÖ Race condition prevention working');

            document.body.removeChild(container);
        });

        test('should handle concurrent modal operations', () => {
            console.log('üé≠ Testing concurrent modal operations...');

            // Mock modal with operation tracking
            const modalOperations = [];
            mockVulnDetailsModal.showVulnerabilityDetailsByCVE = jest.fn((cveId) => {
                modalOperations.push(`start:${cveId}`);
                
                // Simulate the race condition protection logic
                if (mockVulnDetailsModal.isModalOperationInProgress) {
                    modalOperations.push(`cancelled:${cveId}`);
                    return;
                }
                
                mockVulnDetailsModal.isModalOperationInProgress = true;
                modalOperations.push(`processing:${cveId}`);
                
                // Simulate async modal opening
                setTimeout(() => {
                    mockVulnDetailsModal.isModalOperationInProgress = false;
                    modalOperations.push(`completed:${cveId}`);
                }, 5);
            });

            // Test concurrent CVE clicks
            const cveIds = ['CVE-2024-MODAL-001', 'CVE-2024-MODAL-002', 'CVE-2024-MODAL-003'];
            
            cveIds.forEach(cveId => {
                mockVulnDetailsModal.showVulnerabilityDetailsByCVE(cveId, mockDataManager);
            });

            // Verify only first operation proceeds
            expect(modalOperations).toContain('start:CVE-2024-MODAL-001');
            expect(modalOperations).toContain('processing:CVE-2024-MODAL-001');
            expect(modalOperations).toContain('start:CVE-2024-MODAL-002');
            expect(modalOperations).toContain('cancelled:CVE-2024-MODAL-002');

            console.log('Modal operations:', modalOperations);
            console.log('‚úÖ Concurrent modal operation protection working');
        });
    });

    describe('Event Handler Cleanup Testing', () => {
        test('should properly cleanup event handlers on view change', () => {
            console.log('üßπ Testing event handler cleanup...');

            const viewContainer = document.createElement('div');
            viewContainer.className = 'view-container';
            document.body.appendChild(viewContainer);

            // Simulate adding view with handlers
            const addView = (viewName) => {
                viewContainer.innerHTML = `
                    <div class="${viewName}-view">
                        <a href="#" class="vulnerability-cve" data-cve="CVE-2024-${viewName.toUpperCase()}-001">CVE-2024-${viewName.toUpperCase()}-001</a>
                    </div>
                `;

                const handler = jest.fn();
                const view = viewContainer.querySelector(`.${viewName}-view`);
                
                view.addEventListener('click', handler);
                
                return { view, handler };
            };

            // Add first view
            const view1 = addView('table');
            
            // Add second view (replaces first)
            const view2 = addView('cards');

            // Test that old handlers don't interfere
            const cardsLink = viewContainer.querySelector('.vulnerability-cve');
            cardsLink.click();

            // Only new handler should be called
            expect(view1.handler).not.toHaveBeenCalled();
            expect(view2.handler).toHaveBeenCalled();

            console.log('‚úÖ Event handler cleanup working properly');

            document.body.removeChild(viewContainer);
        });

        test('should handle memory leaks in event handlers', () => {
            console.log('üíæ Testing memory leak prevention in event handlers...');

            // Create large number of CVE elements
            const largeContainer = document.createElement('div');
            const cveCount = 1000;

            for (let i = 0; i < cveCount; i++) {
                const link = document.createElement('a');
                link.href = '#';
                link.className = 'vulnerability-cve';
                link.setAttribute('data-cve', `CVE-2024-${String(i).padStart(4, '0')}`);
                link.textContent = `CVE-2024-${String(i).padStart(4, '0')}`;
                largeContainer.appendChild(link);
            }

            document.body.appendChild(largeContainer);

            // Add event delegation (efficient)
            const delegatedHandler = jest.fn();
            largeContainer.addEventListener('click', (event) => {
                if (event.target.classList.contains('vulnerability-cve')) {
                    event.preventDefault();
                    delegatedHandler(event.target.getAttribute('data-cve'));
                }
            });

            // Test random clicks
            const randomIndices = [0, 100, 500, 999];
            randomIndices.forEach(index => {
                const link = largeContainer.children[index];
                link.click();
            });

            expect(delegatedHandler).toHaveBeenCalledTimes(4);

            // Cleanup container (simulating view destruction)
            document.body.removeChild(largeContainer);

            // Handler should be garbage collected with container
            // (This is implicit - DOM cleanup handles it)

            console.log('‚úÖ Large scale event handler memory management working');
        });
    });

    describe('Integration with Modal System', () => {
        test('should integrate properly with vulnerability details modal', () => {
            console.log('üîó Testing integration with vulnerability details modal...');

            const container = document.createElement('div');
            container.innerHTML = `
                <a href="#" class="vulnerability-cve" data-cve="CVE-2024-INTEGRATION-001">CVE-2024-INTEGRATION-001</a>
            `;
            document.body.appendChild(container);

            // Setup handler that calls modal
            container.addEventListener('click', (event) => {
                if (event.target.classList.contains('vulnerability-cve')) {
                    event.preventDefault();
                    const cveId = event.target.getAttribute('data-cve');
                    
                    // Call modal (this would normally trigger race condition)
                    if (window.vulnDetailsModal && window.vulnManager) {
                        window.vulnDetailsModal.showVulnerabilityDetailsByCVE(
                            cveId, 
                            window.vulnManager.dataManager
                        );
                    }
                }
            });

            // Click the CVE link
            const cveLink = container.querySelector('.vulnerability-cve');
            cveLink.click();

            // Verify modal method was called
            expect(mockVulnDetailsModal.showVulnerabilityDetailsByCVE)
                .toHaveBeenCalledWith('CVE-2024-INTEGRATION-001', mockDataManager);

            console.log('‚úÖ Modal integration working');

            document.body.removeChild(container);
        });

        test('should handle modal errors gracefully', () => {
            console.log('üö® Testing modal error handling...');

            const container = document.createElement('div');
            container.innerHTML = `
                <a href="#" class="vulnerability-cve" data-cve="CVE-2024-ERROR-001">CVE-2024-ERROR-001</a>
            `;
            document.body.appendChild(container);

            // Mock modal to throw error
            mockVulnDetailsModal.showVulnerabilityDetailsByCVE = jest.fn().mockImplementation(() => {
                throw new Error('Modal system error');
            });

            // Setup error-handling CVE handler
            let errorCaught = false;
            container.addEventListener('click', (event) => {
                if (event.target.classList.contains('vulnerability-cve')) {
                    event.preventDefault();
                    const cveId = event.target.getAttribute('data-cve');
                    
                    try {
                        window.vulnDetailsModal.showVulnerabilityDetailsByCVE(cveId, mockDataManager);
                    } catch (error) {
                        errorCaught = true;
                        console.log('Caught modal error:', error.message);
                    }
                }
            });

            // Click should handle error gracefully
            const cveLink = container.querySelector('.vulnerability-cve');
            cveLink.click();

            expect(errorCaught).toBe(true);
            expect(mockVulnDetailsModal.showVulnerabilityDetailsByCVE).toHaveBeenCalled();

            console.log('‚úÖ Modal error handling working');

            document.body.removeChild(container);
        });
    });

    describe('Performance Testing', () => {
        test('should maintain performance with many event handlers', () => {
            console.log('‚ö° Testing event handler performance...');

            const startTime = Date.now();

            // Create container with many CVE links
            const perfContainer = document.createElement('div');
            const elementCount = 5000;

            for (let i = 0; i < elementCount; i++) {
                const link = document.createElement('a');
                link.href = '#';
                link.className = 'vulnerability-cve';
                link.setAttribute('data-cve', `CVE-2024-PERF-${String(i).padStart(4, '0')}`);
                link.textContent = `CVE-2024-PERF-${String(i).padStart(4, '0')}`;
                perfContainer.appendChild(link);
            }

            const creationTime = Date.now() - startTime;
            document.body.appendChild(perfContainer);

            // Add single delegated handler (efficient)
            const handlerStartTime = Date.now();
            const perfHandler = jest.fn();
            
            perfContainer.addEventListener('click', (event) => {
                if (event.target.classList.contains('vulnerability-cve')) {
                    event.preventDefault();
                    perfHandler(event.target.getAttribute('data-cve'));
                }
            });

            const handlerTime = Date.now() - handlerStartTime;

            // Test clicks on random elements
            const testClickStartTime = Date.now();
            const testIndices = [0, 1000, 2500, 4999];
            
            testIndices.forEach(index => {
                perfContainer.children[index].click();
            });

            const clickTime = Date.now() - testClickStartTime;
            const totalTime = Date.now() - startTime;

            console.log(`Performance metrics for ${elementCount} elements:`);
            console.log(`  Creation: ${creationTime}ms`);
            console.log(`  Handler attachment: ${handlerTime}ms`);
            console.log(`  4 clicks: ${clickTime}ms`);
            console.log(`  Total: ${totalTime}ms`);

            // Performance assertions
            expect(handlerTime).toBeLessThan(50); // Handler attachment should be fast
            expect(clickTime).toBeLessThan(10);   // Clicks should be very fast
            expect(perfHandler).toHaveBeenCalledTimes(4);

            console.log('‚úÖ Event handler performance acceptable');

            document.body.removeChild(perfContainer);
        });
    });
});