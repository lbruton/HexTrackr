/* eslint-env jest */
/* global describe, test, expect, beforeEach, jest */

/**
 * @fileoverview Unit tests for VulnerabilitySearchManager
 * Tests search functionality, filtering, and CVE/Cisco SA lookups
 */

describe('VulnerabilitySearchManager', () => {
    let searchManager;
    let mockDataManager;
    let mockParentManager;
    let mockDocument;

    beforeEach(() => {
        // Reset modules and mocks
        jest.resetModules();
        jest.clearAllMocks();

        // Mock DOM elements
        mockDocument = {
            getElementById: jest.fn((id) => {
                const elements = {
                    'searchInput': { 
                        value: '', 
                        addEventListener: jest.fn(),
                        focus: jest.fn()
                    },
                    'clearSearchBtn': { 
                        addEventListener: jest.fn(),
                        style: { display: 'none' },
                        classList: { add: jest.fn(), remove: jest.fn() }
                    },
                    'severityFilter': {
                        value: 'all',
                        addEventListener: jest.fn()
                    },
                    'searchButton': {
                        addEventListener: jest.fn()
                    }
                };
                return elements[id] || null;
            }),
            querySelector: jest.fn()
        };

        // Replace global document
        global.document = mockDocument;

        // Mock data manager
        mockDataManager = {
            getCurrentData: jest.fn().mockReturnValue([
                {
                    id: 1,
                    hostname: 'server-01',
                    plugin_name: 'SSL Certificate Issue',
                    severity: 'high',
                    cve: 'CVE-2024-1234',
                    description: 'SSL certificate vulnerability found'
                },
                {
                    id: 2,
                    hostname: 'server-02',
                    plugin_name: 'Apache Vulnerability',
                    severity: 'critical',
                    cve: 'CVE-2024-5678',
                    description: 'Critical Apache server vulnerability'
                },
                {
                    id: 3,
                    hostname: 'router-01',
                    plugin_name: 'Cisco IOS Issue',
                    severity: 'medium',
                    cisco_sa: 'cisco-sa-20240101-ios',
                    description: 'Cisco IOS vulnerability'
                }
            ]),
            setFilteredData: jest.fn()
        };

        // Mock parent manager
        mockParentManager = {
            showToast: jest.fn()
        };

        // Import and create search manager
        const { VulnerabilitySearchManager } = require('/Volumes/DATA/GitHub/HexTrackr/app/public/scripts/shared/vulnerability-search.js');
        searchManager = new VulnerabilitySearchManager(mockDataManager, mockParentManager);
    });

    describe('Initialization', () => {
        test('should initialize search elements', () => {
            searchManager.initializeSearch();

            expect(mockDocument.getElementById).toHaveBeenCalledWith('searchInput');
            expect(mockDocument.getElementById).toHaveBeenCalledWith('clearSearchBtn');
            expect(mockDocument.getElementById).toHaveBeenCalledWith('severityFilter');
            expect(mockDocument.getElementById).toHaveBeenCalledWith('searchButton');
        });

        test('should set up event listeners', () => {
            searchManager.initializeSearch();

            const searchInput = mockDocument.getElementById('searchInput');
            const clearBtn = mockDocument.getElementById('clearSearchBtn');
            const severityFilter = mockDocument.getElementById('severityFilter');

            expect(searchInput.addEventListener).toHaveBeenCalledWith('input', expect.any(Function));
            expect(clearBtn.addEventListener).toHaveBeenCalledWith('click', expect.any(Function));
            expect(severityFilter.addEventListener).toHaveBeenCalledWith('change', expect.any(Function));
        });
    });

    describe('Search Functionality', () => {
        beforeEach(() => {
            searchManager.initializeSearch();
        });

        test('should perform basic text search', () => {
            const searchInput = mockDocument.getElementById('searchInput');
            searchInput.value = 'Apache';

            searchManager.performSearch();

            expect(mockDataManager.setFilteredData).toHaveBeenCalledWith(
                expect.arrayContaining([
                    expect.objectContaining({ plugin_name: 'Apache Vulnerability' })
                ])
            );
        });

        test('should search by hostname', () => {
            const searchInput = mockDocument.getElementById('searchInput');
            searchInput.value = 'server-01';

            searchManager.performSearch();

            expect(mockDataManager.setFilteredData).toHaveBeenCalledWith(
                expect.arrayContaining([
                    expect.objectContaining({ hostname: 'server-01' })
                ])
            );
        });

        test('should search by CVE', () => {
            const searchInput = mockDocument.getElementById('searchInput');
            searchInput.value = 'CVE-2024-1234';

            searchManager.performSearch();

            expect(mockDataManager.setFilteredData).toHaveBeenCalledWith(
                expect.arrayContaining([
                    expect.objectContaining({ cve: 'CVE-2024-1234' })
                ])
            );
        });

        test('should search by Cisco SA', () => {
            const searchInput = mockDocument.getElementById('searchInput');
            searchInput.value = 'cisco-sa-20240101';

            searchManager.performSearch();

            expect(mockDataManager.setFilteredData).toHaveBeenCalledWith(
                expect.arrayContaining([
                    expect.objectContaining({ cisco_sa: 'cisco-sa-20240101-ios' })
                ])
            );
        });

        test('should perform case-insensitive search', () => {
            const searchInput = mockDocument.getElementById('searchInput');
            searchInput.value = 'APACHE';

            searchManager.performSearch();

            expect(mockDataManager.setFilteredData).toHaveBeenCalledWith(
                expect.arrayContaining([
                    expect.objectContaining({ plugin_name: 'Apache Vulnerability' })
                ])
            );
        });
    });

    describe('Severity Filtering', () => {
        beforeEach(() => {
            searchManager.initializeSearch();
        });

        test('should filter by critical severity', () => {
            const severityFilter = mockDocument.getElementById('severityFilter');
            severityFilter.value = 'critical';

            searchManager.performSearch();

            expect(mockDataManager.setFilteredData).toHaveBeenCalledWith(
                expect.arrayContaining([
                    expect.objectContaining({ severity: 'critical' })
                ])
            );
        });

        test('should filter by high severity', () => {
            const severityFilter = mockDocument.getElementById('severityFilter');
            severityFilter.value = 'high';

            searchManager.performSearch();

            expect(mockDataManager.setFilteredData).toHaveBeenCalledWith(
                expect.arrayContaining([
                    expect.objectContaining({ severity: 'high' })
                ])
            );
        });

        test('should show all severities when filter is "all"', () => {
            const severityFilter = mockDocument.getElementById('severityFilter');
            severityFilter.value = 'all';

            searchManager.performSearch();

            expect(mockDataManager.setFilteredData).toHaveBeenCalledWith(
                expect.arrayContaining([
                    expect.objectContaining({ severity: 'high' }),
                    expect.objectContaining({ severity: 'critical' }),
                    expect.objectContaining({ severity: 'medium' })
                ])
            );
        });

        test('should combine search and severity filter', () => {
            const searchInput = mockDocument.getElementById('searchInput');
            const severityFilter = mockDocument.getElementById('severityFilter');
            
            searchInput.value = 'server';
            severityFilter.value = 'high';

            searchManager.performSearch();

            expect(mockDataManager.setFilteredData).toHaveBeenCalledWith(
                expect.arrayContaining([
                    expect.objectContaining({ 
                        hostname: 'server-01',
                        severity: 'high'
                    })
                ])
            );
        });
    });

    describe('Clear Search', () => {
        beforeEach(() => {
            searchManager.initializeSearch();
        });

        test('should clear search input and filters', () => {
            const searchInput = mockDocument.getElementById('searchInput');
            const severityFilter = mockDocument.getElementById('severityFilter');
            const clearBtn = mockDocument.getElementById('clearSearchBtn');

            searchInput.value = 'test search';
            severityFilter.value = 'critical';

            searchManager.clearSearch();

            expect(searchInput.value).toBe('');
            expect(severityFilter.value).toBe('all');
            expect(clearBtn.style.display).toBe('none');
        });

        test('should reset filtered data to show all', () => {
            searchManager.clearSearch();

            expect(mockDataManager.setFilteredData).toHaveBeenCalledWith(
                mockDataManager.getCurrentData()
            );
        });

        test('should dispatch searchCleared event', () => {
            const eventListener = jest.fn();
            searchManager.addEventListener('searchCleared', eventListener);

            searchManager.clearSearch();

            expect(eventListener).toHaveBeenCalled();
        });
    });

    describe('CVE Lookup', () => {
        test('should perform CVE lookup', async () => {
            global.fetch = jest.fn().mockResolvedValue({
                ok: true,
                json: () => Promise.resolve({
                    cve: 'CVE-2024-1234',
                    description: 'Test CVE description',
                    severity: 'HIGH'
                })
            });

            const result = await searchManager.lookupVulnerability('CVE-2024-1234');

            expect(global.fetch).toHaveBeenCalledWith(
                expect.stringContaining('CVE-2024-1234')
            );
            expect(result).toHaveProperty('cve', 'CVE-2024-1234');
        });

        test('should handle CVE lookup errors', async () => {
            global.fetch = jest.fn().mockRejectedValue(new Error('Network error'));

            await expect(searchManager.lookupVulnerability('CVE-2024-1234'))
                .rejects.toThrow('Network error');
        });
    });

    describe('Event Handling', () => {
        beforeEach(() => {
            searchManager.initializeSearch();
        });

        test('should dispatch searchPerformed event', () => {
            const eventListener = jest.fn();
            searchManager.addEventListener('searchPerformed', eventListener);

            searchManager.performSearch();

            expect(eventListener).toHaveBeenCalledWith(
                expect.objectContaining({
                    detail: expect.objectContaining({
                        searchTerm: expect.any(String),
                        resultCount: expect.any(Number)
                    })
                })
            );
        });

        test('should show/hide clear button based on input', () => {
            const searchInput = mockDocument.getElementById('searchInput');
            const clearBtn = mockDocument.getElementById('clearSearchBtn');
            
            // Simulate input event
            searchInput.value = 'test';
            const inputHandler = searchInput.addEventListener.mock.calls
                .find(call => call[0] === 'input')[1];
            
            inputHandler();
            expect(clearBtn.style.display).toBe('inline-block');

            searchInput.value = '';
            inputHandler();
            expect(clearBtn.style.display).toBe('none');
        });
    });

    describe('Error Handling', () => {
        test('should handle missing DOM elements gracefully', () => {
            mockDocument.getElementById = jest.fn().mockReturnValue(null);

            expect(() => {
                searchManager.initializeSearch();
            }).not.toThrow();
        });

        test('should handle empty data gracefully', () => {
            mockDataManager.getCurrentData.mockReturnValue([]);

            searchManager.performSearch();

            expect(mockDataManager.setFilteredData).toHaveBeenCalledWith([]);
        });

        test('should handle null search terms', () => {
            const searchInput = mockDocument.getElementById('searchInput');
            searchInput.value = null;

            expect(() => {
                searchManager.performSearch();
            }).not.toThrow();
        });
    });
});