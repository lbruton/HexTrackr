#!/bin/bash
# HexTrackr Safe Pre-Commit Hook
# Only auto-fixes formatting (markdown + CSS)
# Warns about JavaScript issues but doesn't auto-fix

set -e  # Exit on error

echo "ğŸ” Running safe auto-fixes..."
echo ""

# Layer 1: Safe Auto-Fixes (formatting only, cannot break code)
echo "  ğŸ“ Fixing markdown formatting..."
if npm run lint:md:fix --silent 2>&1 | grep -q "error"; then
    echo "     âš ï¸  Markdown fixes applied"
else
    echo "     âœ… Markdown clean"
fi

echo ""
echo "  ğŸ¨ Fixing CSS formatting..."
if npm run stylelint:fix --silent 2>&1 | grep -q "error"; then
    echo "     âš ï¸  CSS fixes applied"
else
    echo "     âœ… CSS clean"
fi

# Layer 2: Check JavaScript (warn only - NO AUTO-FIX)
echo ""
echo "âš ï¸  Checking JavaScript (warnings only, no auto-fix)..."
echo ""

ESLINT_OUTPUT=$(npm run eslint --silent 2>&1 || true)
ESLINT_EXIT_CODE=$?

if [ $ESLINT_EXIT_CODE -ne 0 ]; then
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âš ï¸  ESLint found issues (NOT auto-fixed for safety)"
    echo ""
    echo "$ESLINT_OUTPUT" | head -20
    echo ""
    echo "Review manually with: npm run eslint"
    echo ""
    echo "ğŸš¨ CRITICAL: Read .github/CODACY_GUIDELINES.md before"
    echo "   fixing 'undefined variable' warnings!"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""

    # Ask user if they want to proceed
    read -p "Commit with ESLint warnings? (y/N): " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "âŒ Commit cancelled. Fix ESLint issues and try again."
        exit 1
    fi
    echo "âš ï¸  Proceeding with warnings (developer reviewed)"
else
    echo "âœ… JavaScript clean"
fi

# Stage the auto-fixed files (only markdown and CSS)
git add -u

echo ""
echo "âœ… Safe fixes applied and staged"
echo ""
echo "ğŸ’¡ Tip: To bypass this hook in emergency: git commit --no-verify"
echo ""