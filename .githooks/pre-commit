#!/bin/sh
# Enhanced pre-commit: run quality checks on staged files

echo "[pre-commit] Running code quality checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track overall status
OVERALL_STATUS=0

# ============================================================================
# MARKDOWN LINTING with Auto-fix
# ============================================================================
STAGED_MD_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.md$' || true)

if [ -n "$STAGED_MD_FILES" ]; then
  echo "\n${YELLOW}[pre-commit]${NC} Checking Markdown files..."
  
  # Step 1: Run markdownlint --fix for auto-fixable issues
  echo "${YELLOW}[pre-commit]${NC} Auto-fixing standard Markdown issues with markdownlint..."
  if command -v npx >/dev/null 2>&1; then
    npx markdownlint --fix $STAGED_MD_FILES 2>/dev/null || true
  fi
  
  # Step 2: Run custom script for remaining issues not handled by markdownlint --fix
  echo "${YELLOW}[pre-commit]${NC} Auto-fixing custom Markdown issues..."
  for file in $STAGED_MD_FILES; do
    node app/public/scripts/fix-markdown.js --file="$file"
  done
  
  # Re-stage auto-fixed files
  git add $STAGED_MD_FILES
  
  # Skip validation step - rely on Codacy for quality checks
  echo "${GREEN}[pre-commit]${NC} Markdown auto-fix complete (validation delegated to Codacy)"
  MD_STATUS=0
  
  if [ $MD_STATUS -ne 0 ]; then
    echo "${RED}[pre-commit]${NC} Markdownlint validation failed after auto-fix"
    OVERALL_STATUS=1
  else
    echo "${GREEN}[pre-commit]${NC} Markdown validation passed"
  fi
fi

# ============================================================================
# CSS/SCSS LINTING with Auto-fix
# ============================================================================
STAGED_CSS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(css|scss)$' || true)

if [ -n "$STAGED_CSS_FILES" ]; then
  echo "\n${YELLOW}[pre-commit]${NC} Checking CSS/SCSS files..."
  
  # Run auto-fix first
  echo "${YELLOW}[pre-commit]${NC} Auto-fixing CSS issues..."
  ./node_modules/.bin/stylelint --fix $STAGED_CSS_FILES
  
  # Re-stage auto-fixed files
  git add $STAGED_CSS_FILES
  
  # Run validation
  ./node_modules/.bin/stylelint $STAGED_CSS_FILES
  CSS_STATUS=$?
  
  if [ $CSS_STATUS -ne 0 ]; then
    echo "${RED}[pre-commit]${NC} Stylelint validation failed after auto-fix"
    OVERALL_STATUS=1
  else
    echo "${GREEN}[pre-commit]${NC} CSS validation passed"
  fi
fi

# ============================================================================
# JAVASCRIPT LINTING with Selective Auto-fix
# ============================================================================
STAGED_JS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.js$' | grep -v '\.min\.js$' || true)

if [ -n "$STAGED_JS_FILES" ]; then
  echo "\n${YELLOW}[pre-commit]${NC} Checking JavaScript files..."
  
  # Run auto-fix for safe issues only
  echo "${YELLOW}[pre-commit]${NC} Auto-fixing safe JavaScript issues..."
  ./node_modules/.bin/eslint --fix --fix-type suggestion,layout --config eslint.config.mjs $STAGED_JS_FILES
  
  # Re-stage auto-fixed files
  git add $STAGED_JS_FILES
  
  # Run full validation
  ./node_modules/.bin/eslint --config eslint.config.mjs $STAGED_JS_FILES
  JS_STATUS=$?
  
  if [ $JS_STATUS -ne 0 ]; then
    echo "${RED}[pre-commit]${NC} ESLint validation failed"
    echo "${YELLOW}[pre-commit]${NC} Run 'npm run eslint' to see details"
    OVERALL_STATUS=1
  else
    echo "${GREEN}[pre-commit]${NC} JavaScript validation passed"
  fi
fi

# ============================================================================
# FINAL RESULT
# ============================================================================
if [ $OVERALL_STATUS -ne 0 ]; then
  echo "\n${RED}[pre-commit]${NC} Code quality checks failed. Please fix issues before committing."
  echo "${YELLOW}[pre-commit]${NC} Tip: Some issues were auto-fixed and staged. Review changes with 'git diff --cached'"
  exit $OVERALL_STATUS
fi

