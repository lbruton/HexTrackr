---
alwaysApply: true
---

# HexTrackr Quick Reference

## Project Overview
HexTrackr is a vulnerability and ticket management system with Node.js/Express backend and vanilla JavaScript frontend.

## Key Files
- **Server**: [server.js](mdc:server.js) - Main Express server with SQLite
- **Database**: [scripts/init-database.js](mdc:scripts/init-database.js) - Schema initialization
- **Frontend**: [scripts/pages/vulnerability-manager.js](mdc:scripts/pages/vulnerability-manager.js) - Main UI logic
- **Settings**: [scripts/shared/settings-modal.js](mdc:scripts/shared/settings-modal.js) - Global utilities

## Critical Commands
```bash
# Development (Docker only)
docker-compose up -d               # Start services
npm run dev                        # Development server
docker-compose restart            # ALWAYS before testing

# Quality Assurance
npm run lint:all                  # Run all linters
npm run fix:all                   # Fix auto-fixable issues
npx playwright test              # Run tests

# Database
npm run init-db                   # Initialize database
```

## Architecture Patterns

### Vulnerability Rollover
- **Dedup Key**: `normalizeHostname(hostname) + CVE` or `plugin_id + description`
- **Process**: CSV → Papa.parse → `processVulnerabilityRowsWithRollover()` → DB
- **Sequential**: Use loops, not parallel processing

### API Responses
```javascript
// Success
{ success: true, data: result }

// Error  
{ success: false, error: "Error message" }
```

### Security
- Use `PathValidator` class for all file operations
- Always validate user inputs
- Use parameterized SQL queries
- Escape HTML output with `escapeHtml()`

## Development Rules
1. **Docker Only** - Never run Node.js locally
2. **Sequential Processing** - Use loops for database operations
3. **Error Handling** - Always use try-catch with proper logging
4. **Code Style** - Double quotes, semicolons, curly braces
5. **Testing** - Run `docker-compose restart` before tests

## Common Patterns

### Database Query
```javascript
db.all("SELECT * FROM table WHERE field = ?", [value], (err, rows) => {
    if (err) throw err;
    // Process rows
});
```

### File Upload
```javascript
const upload = multer({
    storage: multer.diskStorage({
        destination: './uploads',
        filename: (req, file, cb) => {
            cb(null, crypto.randomBytes(16).toString('hex'));
        }
    }),
    limits: { fileSize: 100 * 1024 * 1024 }, // 100MB
    fileFilter: (req, file, cb) => {
        if (file.mimetype === 'text/csv') {
            cb(null, true);
        } else {
            cb(new Error('Only CSV files allowed'), false);
        }
    }
});
```

### Modal Management
```javascript
// Open modal
const modal = new bootstrap.Modal(document.getElementById('modal-id'));
modal.show();

// Close modal
const modal = bootstrap.Modal.getInstance(document.getElementById('modal-id'));
modal.hide();
```

## File Organization
```
scripts/
├── pages/          # Page-specific logic
├── shared/         # Reusable components
└── utils/          # Utility functions

styles/
├── shared/         # Global styles
├── pages/          # Page-specific styles
└── utils/          # Utility styles

tests/
├── *.spec.js       # Playwright tests
└── test-*.csv      # Test data
```

## Performance Targets
- **Page Load**: <2 seconds
- **Table Load**: <500ms
- **Chart Update**: <200ms
- **Modal Open**: <100ms
- **Codacy Issues**: <50 (currently ~83)

## Security Checklist
- [ ] Use `PathValidator` for file operations
- [ ] Validate all user inputs
- [ ] Use parameterized SQL queries
- [ ] Escape HTML output
- [ ] Set proper CORS headers
- [ ] Validate file uploads (type, size)
- [ ] Clean up temporary files