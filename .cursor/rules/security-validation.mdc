---
globs: *.js,*.html
---

# Security and Validation Standards for HexTrackr

## Path Security
Always use the `PathValidator` class from [server.js](mdc:server.js) for all file operations:

```javascript
// ✅ Correct - Use PathValidator
const validatedPath = PathValidator.validatePath(filePath);
const content = PathValidator.safeReadFileSync(validatedPath);

// ❌ Wrong - Direct file operations
const content = fs.readFileSync(filePath);
```

### PathValidator Methods
- `PathValidator.validatePath(filePath)` - Validate and normalize paths
- `PathValidator.safeReadFileSync(filePath, options)` - Safe file reading
- `PathValidator.safeWriteFileSync(filePath, data, options)` - Safe file writing
- `PathValidator.safeReaddirSync(dirPath, options)` - Safe directory reading

## Input Validation

### File Upload Validation
```javascript
// Validate file type and size
const allowedTypes = ['text/csv', 'application/vnd.ms-excel'];
const maxSize = 100 * 1024 * 1024; // 100MB

if (!allowedTypes.includes(file.mimetype)) {
    return res.status(400).json({ 
        success: false, 
        error: "Invalid file type. Only CSV files are allowed." 
    });
}

if (file.size > maxSize) {
    return res.status(400).json({ 
        success: false, 
        error: "File too large. Maximum size is 100MB." 
    });
}
```

### CSV Data Validation
```javascript
// Validate CSV structure and content
function validateCSVData(rows) {
    if (!Array.isArray(rows) || rows.length === 0) {
        throw new Error("CSV data must be a non-empty array");
    }
    
    const requiredFields = ['hostname', 'plugin_id', 'description'];
    const firstRow = rows[0];
    
    for (const field of requiredFields) {
        if (!(field in firstRow)) {
            throw new Error(`Missing required field: ${field}`);
        }
    }
    
    return true;
}
```

### User Input Sanitization
```javascript
// Escape HTML to prevent XSS
function escapeHtml(text) {
    const map = {
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        "\"": "&quot;",
        "'": "&#039;"
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

// Sanitize user input before display
const safeDescription = escapeHtml(userInput.description);
```

## SQL Injection Prevention

### Parameterized Queries
```javascript
// ✅ Correct - Use parameterized queries
const stmt = db.prepare(`
    SELECT * FROM vulnerabilities_current 
    WHERE hostname = ? AND cve = ?
`);
const result = stmt.get(hostname, cve);

// ❌ Wrong - String concatenation
const query = `SELECT * FROM vulnerabilities_current WHERE hostname = '${hostname}'`;
```

### Database Input Validation
```javascript
// Validate database inputs
function validateDatabaseInput(input, type) {
    if (type === 'hostname') {
        // Hostname validation
        if (!/^[a-zA-Z0-9.-]+$/.test(input)) {
            throw new Error("Invalid hostname format");
        }
    } else if (type === 'cve') {
        // CVE validation
        if (!/^CVE-\d{4}-\d{4,}$/.test(input)) {
            throw new Error("Invalid CVE format");
        }
    }
    return input;
}
```

## API Security

### Error Handling
```javascript
// Don't expose sensitive information in errors
try {
    const result = await processSensitiveData(data);
    res.json({ success: true, data: result });
} catch (error) {
    console.error("Internal error:", error); // Log full error
    res.status(500).json({ 
        success: false, 
        error: "Internal server error" // Generic error to user
    });
}
```

### Request Validation
```javascript
// Validate request parameters
function validateRequest(req, res, next) {
    const { hostname, cve } = req.params;
    
    if (!hostname || typeof hostname !== 'string') {
        return res.status(400).json({
            success: false,
            error: "Valid hostname is required"
        });
    }
    
    if (cve && !/^CVE-\d{4}-\d{4,}$/.test(cve)) {
        return res.status(400).json({
            success: false,
            error: "Invalid CVE format"
        });
    }
    
    next();
}
```

## File Upload Security

### Multer Configuration
```javascript
const storage = multer.diskStorage({
    destination: (req, file, cb) => {
        // Use PathValidator for destination
        const uploadPath = PathValidator.validatePath('./uploads');
        cb(null, uploadPath);
    },
    filename: (req, file, cb) => {
        // Generate secure filename
        const uniqueName = crypto.randomBytes(16).toString('hex');
        cb(null, uniqueName);
    }
});

const upload = multer({
    storage: storage,
    limits: {
        fileSize: 100 * 1024 * 1024, // 100MB
        files: 1
    },
    fileFilter: (req, file, cb) => {
        // Validate file type
        if (file.mimetype === 'text/csv' || file.mimetype === 'application/vnd.ms-excel') {
            cb(null, true);
        } else {
            cb(new Error('Only CSV files are allowed'), false);
        }
    }
});
```

## CORS and Headers

### Security Headers
```javascript
// Set security headers
app.use((req, res, next) => {
    res.setHeader('X-Content-Type-Options', 'nosniff');
    res.setHeader('X-Frame-Options', 'DENY');
    res.setHeader('X-XSS-Protection', '1; mode=block');
    res.setHeader('Referrer-Policy', 'strict-origin-when-cross-origin');
    next();
});
```

### CORS Configuration
```javascript
const corsOptions = {
    origin: process.env.NODE_ENV === 'production' 
        ? ['https://yourdomain.com'] 
        : ['http://localhost:8080'],
    credentials: true,
    optionsSuccessStatus: 200
};
app.use(cors(corsOptions));
```

## Data Validation Patterns

### JSON Schema Validation
```javascript
// Validate JSON data structure
function validateTicketData(ticketData) {
    const required = ['location', 'description', 'urgency', 'category'];
    
    for (const field of required) {
        if (!ticketData[field] || typeof ticketData[field] !== 'string') {
            throw new Error(`Missing or invalid field: ${field}`);
        }
    }
    
    // Validate urgency values
    const validUrgencies = ['Low', 'Medium', 'High', 'Critical'];
    if (!validUrgencies.includes(ticketData.urgency)) {
        throw new Error('Invalid urgency level');
    }
    
    return true;
}
```

### Hostname Normalization
```javascript
// Normalize hostnames for consistent processing
function normalizeHostname(hostname) {
    if (!hostname || typeof hostname !== 'string') {
        throw new Error('Invalid hostname');
    }
    
    return hostname.toLowerCase().trim();
}
```

## Security Best Practices

1. **Never trust user input** - Always validate and sanitize
2. **Use parameterized queries** - Prevent SQL injection
3. **Validate file uploads** - Check type, size, and content
4. **Escape output** - Prevent XSS attacks
5. **Use HTTPS in production** - Encrypt data in transit
6. **Log security events** - Monitor for suspicious activity
7. **Regular security updates** - Keep dependencies current
8. **Principle of least privilege** - Minimal required permissions