---
globs: *.js,*.spec.js,*.test.js
---

# Testing and Development Workflow for HexTrackr

## Development Environment

### Docker-Only Development
**CRITICAL**: Always use Docker containers - never run Node.js locally:

```bash
# Start development environment
docker-compose up -d

# Development with auto-reload
npm run dev

# Restart containers before testing
docker-compose restart
```

### Development Commands
```bash
# Quality Assurance
npm run lint:all                  # Run all linters
npm run fix:all                   # Fix all auto-fixable issues
npm run eslint:fix                # Fix JavaScript issues

# Documentation
npm run docs:generate             # Update HTML docs
npm run docs:analyze             # Architecture analysis

# Database
npm run init-db                   # Initialize database
```

## Testing Framework

### Playwright Testing
Tests are located in [tests/](mdc:tests/) directory:

```javascript
// Example test structure
const { test, expect } = require('@playwright/test');

test.describe('Vulnerability Management', () => {
    test.beforeEach(async ({ page }) => {
        // Navigate to vulnerabilities page
        await page.goto('http://localhost:8080/vulnerabilities.html');
    });

    test('should load vulnerability data', async ({ page }) => {
        // Wait for data to load
        await page.waitForSelector('[data-testid="vulnerability-grid"]');
        
        // Check if data is displayed
        const grid = page.locator('[data-testid="vulnerability-grid"]');
        await expect(grid).toBeVisible();
    });

    test('should handle CSV import', async ({ page }) => {
        // Test file upload functionality
        const fileInput = page.locator('input[type="file"]');
        await fileInput.setInputFiles('tests/test-scenario-1-without-cve.csv');
        
        // Wait for import to complete
        await page.waitForSelector('[data-testid="import-success"]');
        
        // Verify data was imported
        const successMessage = page.locator('[data-testid="import-success"]');
        await expect(successMessage).toBeVisible();
    });
});
```

### Test Data Management
```javascript
// Use test-specific CSV files
const testFiles = {
    withCVE: 'tests/test-scenario-2-with-cve.csv',
    withoutCVE: 'tests/test-scenario-1-without-cve.csv'
};

// Clean up test data after each test
test.afterEach(async ({ page }) => {
    // Clear test data if needed
    await page.evaluate(() => {
        localStorage.clear();
    });
});
```

## Code Quality Standards

### ESLint Configuration
Follow the project's [eslint.config.mjs](mdc:eslint.config.mjs):

```javascript
// Run linting
npm run eslint                    # Check all JavaScript files
npm run eslint:fix               # Auto-fix issues

// Specific file patterns
npm run eslint -- scripts/pages/*.js
npm run eslint -- server.js
```

### Code Coverage Goals
- **Target**: <50 total Codacy issues (currently ~83)
- **Security**: Zero critical/high vulnerabilities
- **Testing**: Maintain Playwright test coverage
- **Documentation**: Comprehensive markdown-first docs

## Development Workflow

### Git Workflow
```bash
# Install git hooks
npm run hooks:install

# Before committing
npm run lint:all
npm run fix:all
```

### File Organization
```
scripts/
├── pages/          # Page-specific logic
├── shared/         # Reusable components  
├── utils/          # Utility functions
└── init-database.js # Database setup

tests/
├── *.spec.js       # Playwright tests
├── test-*.csv      # Test data files
└── debug-*.spec.js # Debug tests

styles/
├── shared/         # Shared styles
├── pages/          # Page-specific styles
└── utils/          # Utility styles
```

## Testing Patterns

### Modal Testing
```javascript
test('modal functionality', async ({ page }) => {
    // Open modal
    await page.click('[data-testid="open-modal"]');
    
    // Wait for modal to be visible
    await page.waitForSelector('.modal.show');
    
    // Test modal content
    const modal = page.locator('.modal.show');
    await expect(modal).toBeVisible();
    
    // Close modal
    await page.click('[data-testid="close-modal"]');
    await expect(modal).not.toBeVisible();
});
```

### Data Grid Testing
```javascript
test('AG Grid functionality', async ({ page }) => {
    // Wait for grid to load
    await page.waitForSelector('.ag-grid-container');
    
    // Test sorting
    await page.click('[col-id="hostname"] .ag-header-cell-label');
    
    // Test filtering
    await page.fill('[data-testid="search-input"]', 'test-host');
    
    // Verify filtered results
    const rows = page.locator('.ag-row');
    await expect(rows).toHaveCount(1);
});
```

### API Testing
```javascript
test('API endpoints', async ({ request }) => {
    // Test vulnerabilities endpoint
    const response = await request.get('/api/vulnerabilities');
    expect(response.status()).toBe(200);
    
    const data = await response.json();
    expect(data.success).toBe(true);
    expect(Array.isArray(data.data)).toBe(true);
});
```

## Performance Testing

### Load Testing
```javascript
test('page load performance', async ({ page }) => {
    const startTime = Date.now();
    
    await page.goto('http://localhost:8080/vulnerabilities.html');
    await page.waitForLoadState('networkidle');
    
    const loadTime = Date.now() - startTime;
    expect(loadTime).toBeLessThan(2000); // 2 second limit
});
```

### Memory Testing
```javascript
test('memory usage', async ({ page }) => {
    // Monitor memory usage during operations
    const metrics = await page.evaluate(() => {
        return {
            memory: performance.memory?.usedJSHeapSize || 0,
            timing: performance.timing
        };
    });
    
    expect(metrics.memory).toBeLessThan(100 * 1024 * 1024); // 100MB limit
});
```

## Debugging Patterns

### Console Debugging
```javascript
// Use structured logging
console.log('Debug info:', {
    operation: 'vulnerability-import',
    timestamp: new Date().toISOString(),
    data: { rowCount: rows.length, fileSize: file.size }
});

// Debug specific components
console.debug('AG Grid state:', {
    rowCount: gridApi.getDisplayedRowCount(),
    selectedRows: gridApi.getSelectedRows().length
});
```

### Test Debugging
```javascript
// Debug test failures
test('debug test', async ({ page }) => {
    // Add debug information
    await page.screenshot({ path: 'debug-screenshot.png' });
    
    // Log page state
    const pageContent = await page.content();
    console.log('Page content length:', pageContent.length);
    
    // Debug specific elements
    const elements = await page.locator('[data-testid]').all();
    console.log('Found test elements:', elements.length);
});
```

## Continuous Integration

### Pre-commit Hooks
```bash
#!/bin/sh
# .githooks/pre-commit

# Run linting
npm run lint:all
if [ $? -ne 0 ]; then
    echo "Linting failed. Please fix issues before committing."
    exit 1
fi

# Run tests
npx playwright test
if [ $? -ne 0 ]; then
    echo "Tests failed. Please fix issues before committing."
    exit 1
fi
```

### Build Validation
```bash
# Validate build
docker-compose build
docker-compose up -d
npm run lint:all
npx playwright test
```

## Documentation Standards

### Code Documentation
```javascript
/**
 * Process vulnerability data with rollover logic
 * @param {Array} vulnerabilities - Array of vulnerability objects
 * @param {Object} options - Processing options
 * @param {boolean} options.dryRun - If true, don't save to database
 * @returns {Promise<Object>} Processing result with success status
 * @throws {Error} When input validation fails
 */
async function processVulnerabilityData(vulnerabilities, options = {}) {
    // Implementation
}
```

### Test Documentation
```javascript
/**
 * @fileoverview
 * Tests for vulnerability import functionality
 * 
 * Test scenarios:
 * - CSV import with CVE data
 * - CSV import without CVE data  
 * - Error handling for invalid files
 * - Performance with large datasets
 */
```

## Common Testing Scenarios

### Vulnerability Import Testing
1. **Valid CSV with CVE data** - Should import successfully
2. **Valid CSV without CVE data** - Should use plugin_id + description for dedup
3. **Invalid CSV format** - Should show appropriate error
4. **Large file handling** - Should process within time limits
5. **Duplicate detection** - Should handle rollover correctly

### UI Component Testing
1. **Modal functionality** - Open/close, content display
2. **Data grid operations** - Sorting, filtering, pagination
3. **Chart rendering** - Data visualization, updates
4. **Form validation** - Input validation, error messages
5. **Responsive design** - Mobile/desktop layouts

### API Integration Testing
1. **Data retrieval** - GET endpoints return correct data
2. **Data modification** - POST/PUT endpoints work correctly
3. **Error handling** - Proper error responses
4. **Authentication** - Security measures (when implemented)
5. **Performance** - Response times within limits