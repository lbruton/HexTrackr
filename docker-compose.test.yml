version: '3.8'

# Docker Compose configuration for E2E Testing
# HexTrackr Spec 001: End-to-End Testing Suite with Playwright

services:
  hextrackr:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: hextrackr-test
    environment:
      - NODE_ENV=test
      - PORT=8989
      - DATABASE_PATH=/app/data/hextrackr-test.db
      - LOG_LEVEL=info
      - ENABLE_WEBSOCKET=true
      - ENABLE_AUDIT_LOG=true
      - SESSION_SECRET=test-secret-key-for-e2e-testing
      - MAX_UPLOAD_SIZE=100MB
      - CSV_PROCESSING_BATCH_SIZE=1000
      - ENABLE_PERFORMANCE_MONITORING=true
    ports:
      - "8989:8989"
      - "9229:9229" # Node.js debugger port
    volumes:
      - ./data/test:/app/data
      - ./logs/test:/app/logs
      - ./uploads/test:/app/uploads
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8989/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - hextrackr-test-network
    restart: unless-stopped

  # Test database initialization service
  db-init:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: hextrackr-db-init
    environment:
      - NODE_ENV=test
      - DATABASE_PATH=/app/data/hextrackr-test.db
    volumes:
      - ./data/test:/app/data
      - ./tests/e2e/fixtures:/app/fixtures
    command: >
      sh -c "
        echo 'Initializing test database...';
        node /app/public/scripts/init-database.js;
        echo 'Database initialized successfully';
      "
    networks:
      - hextrackr-test-network
    depends_on:
      hextrackr:
        condition: service_healthy

  # Playwright test runner service (optional - for CI/CD)
  playwright:
    image: mcr.microsoft.com/playwright:v1.40.0-focal
    container_name: playwright-runner
    environment:
      - CI=true
      - PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
      - TEST_URL=http://hextrackr:8989
    volumes:
      - ./tests:/app/tests
      - ./playwright-e2e.config.js:/app/playwright.config.js
      - ./package.json:/app/package.json
      - ./package-lock.json:/app/package-lock.json
      - ./test-results:/app/test-results
      - ./playwright-report:/app/playwright-report
    working_dir: /app
    command: >
      sh -c "
        echo 'Waiting for HexTrackr to be ready...';
        sleep 10;
        npm ci;
        npx playwright test --config=playwright.config.js;
      "
    networks:
      - hextrackr-test-network
    depends_on:
      hextrackr:
        condition: service_healthy
      db-init:
        condition: service_completed_successfully
    profiles:
      - ci

  # Performance monitoring service (optional)
  performance-monitor:
    image: grafana/grafana:latest
    container_name: hextrackr-performance
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_INSTALL_PLUGINS=redis-datasource
    ports:
      - "3001:3000"
    volumes:
      - ./monitoring/grafana:/var/lib/grafana
      - ./monitoring/dashboards:/etc/grafana/provisioning/dashboards
    networks:
      - hextrackr-test-network
    profiles:
      - monitoring

  # Redis cache for test environment (optional)
  redis:
    image: redis:7-alpine
    container_name: hextrackr-redis-test
    ports:
      - "6380:6379"
    volumes:
      - redis-test-data:/data
    command: redis-server --appendonly yes
    networks:
      - hextrackr-test-network
    profiles:
      - cache

networks:
  hextrackr-test-network:
    driver: bridge
    name: hextrackr-test-net

volumes:
  redis-test-data:
    driver: local

# Usage:
# 
# 1. Start test environment:
#    docker-compose -f docker-compose.test.yml up -d
#
# 2. Run tests locally against test environment:
#    npm run test:e2e
#
# 3. Run tests in CI with Playwright container:
#    docker-compose -f docker-compose.test.yml --profile ci up --abort-on-container-exit
#
# 4. Start with performance monitoring:
#    docker-compose -f docker-compose.test.yml --profile monitoring up -d
#
# 5. Start with Redis cache:
#    docker-compose -f docker-compose.test.yml --profile cache up -d
#
# 6. Clean up test environment:
#    docker-compose -f docker-compose.test.yml down -v