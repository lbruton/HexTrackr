{
  "spec": "005-005-darkmode",
  "title": "Dark Mode Theme System API Contracts",
  "version": "1.0.0",
  "description": "API contracts for HexTrackr dark mode theme preference management",
  "status": "PENDING",
  "endpoints": [
    {
      "path": "/api/preferences/theme",
      "method": "GET",
      "description": "Retrieve current user theme preference",
      "parameters": {
        "query": {
          "session_id": {
            "type": "string",
            "required": false,
            "description": "Browser session identifier for preference lookup"
          }
        }
      },
      "responses": {
        "200": {
          "description": "Theme preference retrieved successfully",
          "schema": {
            "type": "object",
            "properties": {
              "theme": {
                "type": "string",
                "enum": ["light", "dark", "system"],
                "description": "Current theme preference"
              },
              "timestamp": {
                "type": "string",
                "format": "date-time",
                "description": "ISO 8601 timestamp of last update"
              },
              "source": {
                "type": "string",
                "enum": ["user", "system", "default"],
                "description": "Source of theme preference"
              },
              "version": {
                "type": "string",
                "description": "Schema version"
              }
            }
          }
        },
        "404": {
          "description": "No theme preference found - return system default",
          "schema": {
            "type": "object",
            "properties": {
              "theme": {
                "type": "string",
                "enum": ["system"]
              },
              "message": {
                "type": "string",
                "description": "Human readable message"
              }
            }
          }
        }
      }
    },
    {
      "path": "/api/preferences/theme",
      "method": "POST",
      "description": "Update user theme preference",
      "parameters": {
        "body": {
          "type": "object",
          "required": ["theme"],
          "properties": {
            "theme": {
              "type": "string",
              "enum": ["light", "dark", "system"],
              "description": "New theme preference to save"
            },
            "session_id": {
              "type": "string",
              "description": "Browser session identifier"
            },
            "source": {
              "type": "string",
              "enum": ["user", "system"],
              "default": "user",
              "description": "Source of theme change"
            }
          }
        }
      },
      "responses": {
        "200": {
          "description": "Theme preference updated successfully",
          "schema": {
            "type": "object",
            "properties": {
              "theme": {
                "type": "string",
                "enum": ["light", "dark", "system"]
              },
              "timestamp": {
                "type": "string",
                "format": "date-time"
              },
              "message": {
                "type": "string",
                "description": "Success confirmation"
              }
            }
          }
        },
        "400": {
          "description": "Invalid theme value provided",
          "schema": {
            "type": "object",
            "properties": {
              "error": {
                "type": "string",
                "description": "Error message"
              },
              "validValues": {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "description": "List of valid theme values"
              }
            }
          }
        },
        "429": {
          "description": "Rate limit exceeded for theme updates",
          "schema": {
            "type": "object",
            "properties": {
              "error": {
                "type": "string",
                "description": "Rate limit error message"
              },
              "retryAfter": {
                "type": "integer",
                "description": "Seconds until next request allowed"
              }
            }
          }
        }
      }
    },
    {
      "path": "/api/preferences/theme/system",
      "method": "GET",
      "description": "Detect browser system theme preference",
      "responses": {
        "200": {
          "description": "System preference detected",
          "schema": {
            "type": "object",
            "properties": {
              "prefersDark": {
                "type": "boolean",
                "description": "True if system prefers dark mode"
              },
              "supported": {
                "type": "boolean",
                "description": "True if browser supports prefers-color-scheme"
              },
              "userAgent": {
                "type": "string",
                "description": "Browser user agent string"
              }
            }
          }
        }
      }
    }
  ],
  "websocket_events": [
    {
      "event": "theme_preference_sync",
      "direction": "server_to_client",
      "description": "Notify all user tabs when theme preference changes",
      "payload": {
        "type": "object",
        "properties": {
          "theme": {
            "type": "string",
            "enum": ["light", "dark", "system"]
          },
          "timestamp": {
            "type": "string",
            "format": "date-time"
          },
          "sessionId": {
            "type": "string",
            "description": "Session that initiated the change"
          }
        }
      }
    },
    {
      "event": "theme_preference_change",
      "direction": "client_to_server",
      "description": "Client notifies server of theme change for cross-tab sync",
      "payload": {
        "type": "object",
        "properties": {
          "theme": {
            "type": "string",
            "enum": ["light", "dark", "system"]
          },
          "sessionId": {
            "type": "string"
          },
          "source": {
            "type": "string",
            "enum": ["user", "system"]
          }
        }
      }
    }
  ],
  "client_side_contracts": [
    {
      "interface": "ThemeController",
      "description": "Main theme management interface",
      "methods": [
        {
          "name": "setTheme",
          "parameters": [
            {
              "name": "theme",
              "type": "string",
              "enum": ["light", "dark", "system"]
            }
          ],
          "returns": {
            "type": "Promise<boolean>",
            "description": "True if theme change succeeded"
          }
        },
        {
          "name": "getTheme",
          "parameters": [],
          "returns": {
            "type": "string",
            "enum": ["light", "dark", "system"]
          }
        },
        {
          "name": "detectSystemPreference", 
          "parameters": [],
          "returns": {
            "type": "string",
            "enum": ["light", "dark"]
          }
        },
        {
          "name": "addThemeChangeListener",
          "parameters": [
            {
              "name": "callback",
              "type": "function",
              "signature": "(oldTheme: string, newTheme: string) => void"
            }
          ],
          "returns": {
            "type": "function",
            "description": "Cleanup function to remove listener"
          }
        }
      ]
    },
    {
      "interface": "ApexChartsThemeAdapter", 
      "description": "ApexCharts theme synchronization",
      "methods": [
        {
          "name": "updateChartTheme",
          "parameters": [
            {
              "name": "chartInstance",
              "type": "object"
            },
            {
              "name": "theme",
              "type": "string",
              "enum": ["light", "dark"]
            }
          ],
          "returns": {
            "type": "Promise<void>"
          }
        },
        {
          "name": "getThemeConfig",
          "parameters": [
            {
              "name": "theme",
              "type": "string",
              "enum": ["light", "dark"]
            }
          ],
          "returns": {
            "type": "object",
            "description": "ApexCharts theme configuration object"
          }
        }
      ]
    }
  ],
  "validation_rules": [
    {
      "rule": "theme_value_validation",
      "description": "Theme values must be one of: light, dark, system",
      "implementation": "validateTheme(theme) => ['light', 'dark', 'system'].includes(theme)"
    },
    {
      "rule": "timestamp_validation",
      "description": "Timestamps must be valid ISO 8601 format",
      "implementation": "validateTimestamp(timestamp) => !isNaN(Date.parse(timestamp))"
    },
    {
      "rule": "rate_limiting",
      "description": "Maximum 10 theme changes per minute per session",
      "implementation": "Rate limiting middleware with 60-second sliding window"
    },
    {
      "rule": "session_validation",
      "description": "Session IDs must be valid UUIDs or browser fingerprints",
      "implementation": "validateSessionId(sessionId) => /^[a-f0-9-]{36}$/.test(sessionId) || isValidFingerprint(sessionId)"
    }
  ],
  "security_considerations": [
    {
      "concern": "XSS Prevention",
      "mitigation": "All theme values validated against enum, DOM updates through security.js utilities"
    },
    {
      "concern": "CSRF Protection", 
      "mitigation": "Theme API endpoints use existing CSRF middleware"
    },
    {
      "concern": "Input Validation",
      "mitigation": "Comprehensive validation for all theme preference inputs"
    },
    {
      "concern": "Storage Security",
      "mitigation": "localStorage values sanitized, database queries parameterized"
    }
  ]
}