const { test, expect } = require("@playwright/test");

test.describe("Vulnerability Colors - Light Mode", () => {
    test.beforeEach(async ({ page }) => {
        await page.goto("http://localhost:8989/vulnerabilities.html");

        // Ensure we're in light mode
        const currentTheme = await page.evaluate(() => {
            return document.body.getAttribute("data-theme") || "light";
        });

        if (currentTheme === "dark") {
            await page.click("[data-bs-toggle='theme']");
            await page.waitForTimeout(100);
        }
    });

    test("Critical severity uses consistent red color", async ({ page }) => {
        // Expected colors based on spec
        const EXPECTED_CRITICAL = "rgb(220, 38, 38)"; // #dc2626

        // Check stat card text color (use first matching element - the VPR score)
        const criticalCardColor = await page.locator(".card:has-text('Critical') .text-vpr-critical")
            .first()
            .evaluate(el => window.getComputedStyle(el).color);

        expect(criticalCardColor).toBe(EXPECTED_CRITICAL);

        // Check chart color (will need to extract from ApexCharts)
        const chartColors = await page.evaluate(() => {
            const chartEl = document.querySelector("#vprTrendsChart");
            if (chartEl && window.ApexCharts) {
                const chart = chartEl._chartInstance;
                return chart ? chart.opts.colors : [];
            }
            return [];
        });

        expect(chartColors[0]).toBe("#dc2626");
    });

    test("High severity uses consistent orange color", async ({ page }) => {
        // Expected colors based on spec (adjusted for WCAG)
        const EXPECTED_HIGH = "rgb(217, 119, 6)"; // #d97706

        // Check stat card text color
        const highCardColor = await page.locator(".card:has-text('High') .text-vpr-high")
            .first()
            .evaluate(el => window.getComputedStyle(el).color);

        expect(highCardColor).toBe(EXPECTED_HIGH);

        // Check chart color
        const chartColors = await page.evaluate(() => {
            const chartEl = document.querySelector("#vprTrendsChart");
            if (chartEl && window.ApexCharts) {
                const chart = chartEl._chartInstance;
                return chart ? chart.opts.colors : [];
            }
            return [];
        });

        expect(chartColors[1]).toBe("#d97706");
    });

    test("Medium severity uses consistent blue color", async ({ page }) => {
        // Expected colors based on spec
        const EXPECTED_MEDIUM = "rgb(37, 99, 235)"; // #2563eb

        // Check stat card
        const mediumCardColor = await page.locator(".card:has-text('Medium') .text-vpr-medium")
            .first()
            .evaluate(el => window.getComputedStyle(el).color);

        expect(mediumCardColor).toBe(EXPECTED_MEDIUM);

        // Check chart color
        const chartColors = await page.evaluate(() => {
            const chartEl = document.querySelector("#vprTrendsChart");
            if (chartEl && window.ApexCharts) {
                const chart = chartEl._chartInstance;
                return chart ? chart.opts.colors : [];
            }
            return [];
        });

        expect(chartColors[2]).toBe("#2563eb");
    });

    test("Low severity uses consistent green color", async ({ page }) => {
        // Expected colors based on spec
        const EXPECTED_LOW = "rgb(22, 163, 74)"; // #16a34a

        // Check stat card text color
        const lowCardColor = await page.locator(".card:has-text('Low') .text-vpr-low")
            .first()
            .evaluate(el => window.getComputedStyle(el).color);

        expect(lowCardColor).toBe(EXPECTED_LOW);

        // Check chart color
        const chartColors = await page.evaluate(() => {
            const chartEl = document.querySelector("#vprTrendsChart");
            if (chartEl && window.ApexCharts) {
                const chart = chartEl._chartInstance;
                return chart ? chart.opts.colors : [];
            }
            return [];
        });

        expect(chartColors[3]).toBe("#16a34a");
    });

    test("CSS variables are properly defined", async ({ page }) => {
        const cssVariables = await page.evaluate(() => {
            const root = document.documentElement;
            const style = getComputedStyle(root);
            return {
                critical: style.getPropertyValue("--vpr-critical").trim(),
                high: style.getPropertyValue("--vpr-high").trim(),
                medium: style.getPropertyValue("--vpr-medium").trim(),
                low: style.getPropertyValue("--vpr-low").trim()
            };
        });

        expect(cssVariables.critical).toBe("#dc2626");
        expect(cssVariables.high).toBe("#d97706");
        expect(cssVariables.medium).toBe("#2563eb");
        expect(cssVariables.low).toBe("#16a34a");
    });

    test("Icons use severity colors", async ({ page }) => {
        // Check that icons inherit the correct color from their severity
        const criticalIconColor = await page.locator(".card:has-text('Critical') .ti")
            .first()
            .evaluate(el => window.getComputedStyle(el).color);

        const EXPECTED_CRITICAL = "rgb(220, 38, 38)";
        expect(criticalIconColor).toBe(EXPECTED_CRITICAL);
    });
});