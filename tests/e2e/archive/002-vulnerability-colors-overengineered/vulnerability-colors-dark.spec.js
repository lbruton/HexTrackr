const { test, expect } = require("@playwright/test");

test.describe("Vulnerability Colors - Dark Mode", () => {
    test.beforeEach(async ({ page }) => {
        await page.goto("http://localhost:8989/vulnerabilities.html");

        // Ensure we're in dark mode
        const currentTheme = await page.evaluate(() => {
            return document.body.getAttribute("data-theme") || "light";
        });

        if (currentTheme !== "dark") {
            await page.click("[data-bs-toggle='theme']");
            await page.waitForTimeout(100);
        }
    });

    test("Critical severity uses consistent red color in dark mode", async ({ page }) => {
        // Expected colors for dark mode
        const EXPECTED_CRITICAL = "rgb(239, 68, 68)"; // #ef4444

        // Check stat card text color
        const criticalCardColor = await page.locator(".card:has-text('Critical') .text-vpr-critical")
            .first()
            .evaluate(el => window.getComputedStyle(el).color);

        expect(criticalCardColor).toBe(EXPECTED_CRITICAL);

        // Check chart color
        const chartColors = await page.evaluate(() => {
            const chartEl = document.querySelector("#vprTrendsChart");
            if (chartEl && window.ApexCharts) {
                const chart = chartEl._chartInstance;
                return chart ? chart.opts.colors : [];
            }
            return [];
        });

        expect(chartColors[0]).toBe("#ef4444");
    });

    test("High severity uses consistent orange color in dark mode", async ({ page }) => {
        // Expected colors for dark mode
        const EXPECTED_HIGH = "rgb(249, 115, 22)"; // #f97316

        // Check stat card text color
        const highCardColor = await page.locator(".card:has-text('High') .text-vpr-high")
            .first()
            .evaluate(el => window.getComputedStyle(el).color);

        expect(highCardColor).toBe(EXPECTED_HIGH);

        // Check chart color
        const chartColors = await page.evaluate(() => {
            const chartEl = document.querySelector("#vprTrendsChart");
            if (chartEl && window.ApexCharts) {
                const chart = chartEl._chartInstance;
                return chart ? chart.opts.colors : [];
            }
            return [];
        });

        expect(chartColors[1]).toBe("#f97316");
    });

    test("Medium severity uses consistent blue color in dark mode", async ({ page }) => {
        // Expected colors for dark mode
        const EXPECTED_MEDIUM = "rgb(59, 130, 246)"; // #3b82f6

        // Check stat card - IMPORTANT: Currently uses text-yellow which is wrong
        const mediumCardColor = await page.locator(".card:has-text('Medium') .text-vpr-medium")
            .first()
            .evaluate(el => window.getComputedStyle(el).color);

        expect(mediumCardColor).toBe(EXPECTED_MEDIUM);

        // Check chart color
        const chartColors = await page.evaluate(() => {
            const chartEl = document.querySelector("#vprTrendsChart");
            if (chartEl && window.ApexCharts) {
                const chart = chartEl._chartInstance;
                return chart ? chart.opts.colors : [];
            }
            return [];
        });

        expect(chartColors[2]).toBe("#3b82f6");
    });

    test("Low severity uses consistent green color in dark mode", async ({ page }) => {
        // Expected colors for dark mode
        const EXPECTED_LOW = "rgb(34, 197, 94)"; // #22c55e

        // Check stat card text color
        const lowCardColor = await page.locator(".card:has-text('Low') .text-vpr-low")
            .first()
            .evaluate(el => window.getComputedStyle(el).color);

        expect(lowCardColor).toBe(EXPECTED_LOW);

        // Check chart color
        const chartColors = await page.evaluate(() => {
            const chartEl = document.querySelector("#vprTrendsChart");
            if (chartEl && window.ApexCharts) {
                const chart = chartEl._chartInstance;
                return chart ? chart.opts.colors : [];
            }
            return [];
        });

        expect(chartColors[3]).toBe("#22c55e");
    });

    test("CSS variables are properly defined for dark mode", async ({ page }) => {
        const cssVariables = await page.evaluate(() => {
            const root = document.documentElement;
            const style = getComputedStyle(root);
            return {
                critical: style.getPropertyValue("--vpr-critical").trim(),
                high: style.getPropertyValue("--vpr-high").trim(),
                medium: style.getPropertyValue("--vpr-medium").trim(),
                low: style.getPropertyValue("--vpr-low").trim()
            };
        });

        expect(cssVariables.critical).toBe("#ef4444");
        expect(cssVariables.high).toBe("#f97316");
        expect(cssVariables.medium).toBe("#3b82f6");
        expect(cssVariables.low).toBe("#22c55e");
    });

    test("Dark mode provides sufficient contrast", async ({ page }) => {
        // Get background color of cards in dark mode
        const cardBackground = await page.locator(".card").first()
            .evaluate(el => window.getComputedStyle(el).backgroundColor);

        // Verify it's the expected dark surface color
        expect(cardBackground).toMatch(/rgb\(26, 35, 50\)|#1a2332/);

        // Check that text has sufficient contrast
        const criticalTextColor = await page.locator(".card:has-text('Critical') .text-red")
            .first()
            .evaluate(el => window.getComputedStyle(el).color);

        // Basic check that it's using the brighter dark mode color
        expect(criticalTextColor).toBe("rgb(239, 68, 68)");
    });

    test("Icons use severity colors in dark mode", async ({ page }) => {
        // Check that icons inherit the correct color from their severity
        const criticalIconColor = await page.locator(".card:has-text('Critical') .ti")
            .first()
            .first()
            .evaluate(el => window.getComputedStyle(el).color);

        const EXPECTED_CRITICAL = "rgb(239, 68, 68)";
        expect(criticalIconColor).toBe(EXPECTED_CRITICAL);
    });
});