const { test, expect } = require("@playwright/test");

test.describe("Vulnerability Theme Switching", () => {
    test.beforeEach(async ({ page }) => {
        await page.goto("http://localhost:8989/vulnerabilities.html");
    });

    test("Theme switch updates all colors simultaneously", async ({ page }) => {
        // Start in light mode
        await page.evaluate(() => {
            document.body.setAttribute("data-theme", "light");
        });
        await page.waitForTimeout(100);

        // Get initial colors in light mode
        const lightColors = await page.evaluate(() => {
            const style = getComputedStyle(document.documentElement);
            return {
                critical: style.getPropertyValue("--vpr-critical").trim(),
                high: style.getPropertyValue("--vpr-high").trim(),
                medium: style.getPropertyValue("--vpr-medium").trim(),
                low: style.getPropertyValue("--vpr-low").trim()
            };
        });

        // Get chart colors in light mode
        const lightChartColors = await page.evaluate(() => {
            const chartEl = document.querySelector("#vprTrendsChart");
            if (chartEl && window.ApexCharts) {
                const chart = chartEl._chartInstance;
                return chart ? chart.opts.colors : [];
            }
            return [];
        });

        // Switch to dark mode
        await page.click("[data-bs-toggle='theme']");
        await page.waitForTimeout(200); // Allow time for theme to switch

        // Get colors after switching to dark mode
        const darkColors = await page.evaluate(() => {
            const style = getComputedStyle(document.documentElement);
            return {
                critical: style.getPropertyValue("--vpr-critical").trim(),
                high: style.getPropertyValue("--vpr-high").trim(),
                medium: style.getPropertyValue("--vpr-medium").trim(),
                low: style.getPropertyValue("--vpr-low").trim()
            };
        });

        // Get chart colors in dark mode
        const darkChartColors = await page.evaluate(() => {
            const chartEl = document.querySelector("#vprTrendsChart");
            if (chartEl && window.ApexCharts) {
                const chart = chartEl._chartInstance;
                return chart ? chart.opts.colors : [];
            }
            return [];
        });

        // Verify light mode colors
        expect(lightColors.critical).toBe("#dc2626");
        expect(lightColors.high).toBe("#d97706");
        expect(lightColors.medium).toBe("#2563eb");
        expect(lightColors.low).toBe("#16a34a");

        expect(lightChartColors[0]).toBe("#dc2626");
        expect(lightChartColors[1]).toBe("#d97706");
        expect(lightChartColors[2]).toBe("#2563eb");
        expect(lightChartColors[3]).toBe("#16a34a");

        // Verify dark mode colors
        expect(darkColors.critical).toBe("#ef4444");
        expect(darkColors.high).toBe("#f97316");
        expect(darkColors.medium).toBe("#3b82f6");
        expect(darkColors.low).toBe("#22c55e");

        expect(darkChartColors[0]).toBe("#ef4444");
        expect(darkChartColors[1]).toBe("#f97316");
        expect(darkChartColors[2]).toBe("#3b82f6");
        expect(darkChartColors[3]).toBe("#22c55e");
    });

    test("Theme switch completes within 50ms", async ({ page }) => {
        // Measure theme switch performance
        const switchTime = await page.evaluate(async () => {
            const start = performance.now();

            // Trigger theme change
            document.body.setAttribute("data-theme",
                document.body.getAttribute("data-theme") === "dark" ? "light" : "dark");

            // Wait for CSS to apply
            await new Promise(resolve => requestAnimationFrame(resolve));

            const end = performance.now();
            return end - start;
        });

        expect(switchTime).toBeLessThan(50);
    });

    test("Chart updates when theme changes", async ({ page }) => {
        // Start in light mode
        await page.evaluate(() => {
            document.body.setAttribute("data-theme", "light");
        });
        await page.waitForTimeout(100);

        // Get initial chart instance ID
        const initialChartId = await page.evaluate(() => {
            const chartEl = document.querySelector("#vprTrendsChart");
            if (chartEl && window.ApexCharts) {
                const chart = chartEl._chartInstance;
                return chart ? chart.id : null;
            }
            return null;
        });

        expect(initialChartId).toBeTruthy();

        // Switch theme
        await page.click("[data-bs-toggle='theme']");
        await page.waitForTimeout(200);

        // Verify chart was updated (colors changed)
        const updatedChart = await page.evaluate(() => {
            const chartEl = document.querySelector("#vprTrendsChart");
            if (chartEl && window.ApexCharts) {
                const chart = chartEl._chartInstance;
                return {
                    id: chart ? chart.id : null,
                    colors: chart ? chart.opts.colors : [],
                    theme: chart ? chart.opts.theme.mode : null
                };
            }
            return null;
        });

        expect(updatedChart.id).toBe(initialChartId); // Same chart instance
        expect(updatedChart.theme).toBe("dark"); // Theme updated
        expect(updatedChart.colors[0]).toBe("#ef4444"); // Dark mode colors applied
    });

    test("Stat card colors update on theme switch", async ({ page }) => {
        // Start in light mode
        await page.evaluate(() => {
            document.body.setAttribute("data-theme", "light");
        });
        await page.waitForTimeout(100);

        // Get critical card color in light mode
        const lightCriticalColor = await page.locator(".card:has-text('Critical') .text-vpr-critical")
            .evaluate(el => window.getComputedStyle(el).color);

        // Switch to dark mode
        await page.click("[data-bs-toggle='theme']");
        await page.waitForTimeout(200);

        // Get critical card color in dark mode
        const darkCriticalColor = await page.locator(".card:has-text('Critical') .text-vpr-critical")
            .evaluate(el => window.getComputedStyle(el).color);

        // Colors should be different
        expect(lightCriticalColor).not.toBe(darkCriticalColor);
        expect(lightCriticalColor).toBe("rgb(220, 38, 38)"); // Light mode red
        expect(darkCriticalColor).toBe("rgb(239, 68, 68)"); // Dark mode red
    });

    test("Multiple rapid theme switches maintain consistency", async ({ page }) => {
        // Rapidly switch themes multiple times
        for (let i = 0; i < 5; i++) {
            await page.click("[data-bs-toggle='theme']");
            await page.waitForTimeout(50);
        }

        // Final state should be consistent
        const currentTheme = await page.evaluate(() => {
            return document.body.getAttribute("data-theme") || "light";
        });

        const colors = await page.evaluate(() => {
            const style = getComputedStyle(document.documentElement);
            return {
                critical: style.getPropertyValue("--vpr-critical").trim(),
                theme: document.body.getAttribute("data-theme") || "light"
            };
        });

        // Verify colors match the theme
        if (colors.theme === "dark") {
            expect(colors.critical).toBe("#ef4444");
        } else {
            expect(colors.critical).toBe("#dc2626");
        }
    });
});