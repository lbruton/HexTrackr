/**
 * @module vulnerability-normalization.spec
 * @description E2E tests for vulnerability chart normalization feature
 * @since 1.0.17
 */

const { test, expect } = require('@playwright/test');

test.describe('Vulnerability Chart Normalization', () => {
    test.beforeEach(async ({ page }) => {
        // Navigate to vulnerabilities page
        await page.goto('http://localhost:8989/vulnerabilities');

        // Wait for chart to load
        await page.waitForSelector('#vulnerability-trends-chart', { timeout: 5000 });
    });

    test('should display normalize toggle button', async ({ page }) => {
        // Check toggle button exists
        const toggleButton = await page.locator('[data-toggle="normalize-chart"]');
        await expect(toggleButton).toBeVisible();
        await expect(toggleButton).toHaveText(/Normalize Data/i);
    });

    test('should toggle between normalized and absolute views', async ({ page }) => {
        const toggleButton = await page.locator('[data-toggle="normalize-chart"]');

        // Initial state should be absolute
        await expect(toggleButton).toHaveAttribute('aria-pressed', 'false');

        // Click to normalize
        await toggleButton.click();
        await expect(toggleButton).toHaveAttribute('aria-pressed', 'true');

        // Wait for chart update
        await page.waitForTimeout(300); // Allow for animation

        // Verify chart updated (check for normalized class or data attribute)
        const chart = await page.locator('#vulnerability-trends-chart');
        await expect(chart).toHaveAttribute('data-normalized', 'true');

        // Click to return to absolute
        await toggleButton.click();
        await expect(toggleButton).toHaveAttribute('aria-pressed', 'false');
        await expect(chart).toHaveAttribute('data-normalized', 'false');
    });

    test('should show both values in tooltip when normalized', async ({ page }) => {
        const toggleButton = await page.locator('[data-toggle="normalize-chart"]');

        // Enable normalization
        await toggleButton.click();
        await page.waitForTimeout(300);

        // Hover over a data point
        const chartArea = await page.locator('#vulnerability-trends-chart .apexcharts-series-markers');
        await chartArea.first().hover();

        // Check tooltip content
        const tooltip = await page.locator('.apexcharts-tooltip');
        await expect(tooltip).toBeVisible();

        // Should contain both normalized and actual values
        const tooltipText = await tooltip.textContent();
        expect(tooltipText).toContain('Index:');
        expect(tooltipText).toContain('Actual:');
    });

    test('should persist view preference across page reloads', async ({ page }) => {
        const toggleButton = await page.locator('[data-toggle="normalize-chart"]');

        // Set to normalized view
        await toggleButton.click();
        await expect(toggleButton).toHaveAttribute('aria-pressed', 'true');

        // Reload page
        await page.reload();
        await page.waitForSelector('#vulnerability-trends-chart');

        // Check state is preserved
        const toggleButtonAfterReload = await page.locator('[data-toggle="normalize-chart"]');
        await expect(toggleButtonAfterReload).toHaveAttribute('aria-pressed', 'true');

        const chart = await page.locator('#vulnerability-trends-chart');
        await expect(chart).toHaveAttribute('data-normalized', 'true');
    });

    test('should handle zero baseline gracefully', async ({ page }) => {
        // This test assumes we can inject test data or have a known zero baseline scenario
        // For now, just verify no errors occur
        const toggleButton = await page.locator('[data-toggle="normalize-chart"]');

        // Toggle normalization
        await toggleButton.click();

        // Check for console errors
        const consoleErrors = [];
        page.on('console', msg => {
            if (msg.type() === 'error') {
                consoleErrors.push(msg.text());
            }
        });

        await page.waitForTimeout(500);

        // Should have no division by zero or other errors
        expect(consoleErrors.filter(err => err.includes('division'))).toHaveLength(0);
        expect(consoleErrors.filter(err => err.includes('NaN'))).toHaveLength(0);
    });

    test('should maintain theme compatibility', async ({ page }) => {
        const toggleButton = await page.locator('[data-toggle="normalize-chart"]');
        const themeToggle = await page.locator('[data-bs-toggle="theme"]');

        // Test in light mode
        await toggleButton.click();
        const lightModeStyles = await toggleButton.evaluate(el => {
            const computed = window.getComputedStyle(el);
            return {
                background: computed.backgroundColor,
                color: computed.color
            };
        });

        // Switch to dark mode
        await themeToggle.click();
        await page.waitForTimeout(300);

        const darkModeStyles = await toggleButton.evaluate(el => {
            const computed = window.getComputedStyle(el);
            return {
                background: computed.backgroundColor,
                color: computed.color
            };
        });

        // Styles should be different between themes
        expect(lightModeStyles.background).not.toBe(darkModeStyles.background);

        // Button should remain visible and functional
        await expect(toggleButton).toBeVisible();
        await toggleButton.click(); // Should still work
        await expect(toggleButton).toHaveAttribute('aria-pressed', 'false');
    });

    test('should update chart within performance threshold', async ({ page }) => {
        const toggleButton = await page.locator('[data-toggle="normalize-chart"]');

        // Measure toggle performance
        const startTime = Date.now();
        await toggleButton.click();

        // Wait for chart update indication
        await page.waitForFunction(
            () => document.querySelector('#vulnerability-trends-chart[data-normalized="true"]'),
            { timeout: 500 }
        );

        const endTime = Date.now();
        const duration = endTime - startTime;

        // Should complete within 500ms
        expect(duration).toBeLessThan(500);
    });

    test('should handle time range changes with normalization', async ({ page }) => {
        const toggleButton = await page.locator('[data-toggle="normalize-chart"]');
        const timeRangeSelector = await page.locator('[data-range-selector]');

        // Enable normalization
        await toggleButton.click();

        // Change time range
        await timeRangeSelector.selectOption('7d');
        await page.waitForTimeout(300);

        // Chart should remain normalized
        const chart = await page.locator('#vulnerability-trends-chart');
        await expect(chart).toHaveAttribute('data-normalized', 'true');

        // Change to another range
        await timeRangeSelector.selectOption('30d');
        await page.waitForTimeout(300);

        // Still normalized
        await expect(chart).toHaveAttribute('data-normalized', 'true');
    });

    test('should display all severity lines clearly when normalized', async ({ page }) => {
        const toggleButton = await page.locator('[data-toggle="normalize-chart"]');

        // Enable normalization
        await toggleButton.click();
        await page.waitForTimeout(300);

        // Check all severity series are visible
        const criticalSeries = await page.locator('.apexcharts-series[seriesName="Critical"]');
        const highSeries = await page.locator('.apexcharts-series[seriesName="High"]');
        const mediumSeries = await page.locator('.apexcharts-series[seriesName="Medium"]');
        const lowSeries = await page.locator('.apexcharts-series[seriesName="Low"]');

        await expect(criticalSeries).toBeVisible();
        await expect(highSeries).toBeVisible();
        await expect(mediumSeries).toBeVisible();
        await expect(lowSeries).toBeVisible();

        // Verify all lines have reasonable y-positions (not all at bottom)
        const positions = await page.evaluate(() => {
            const series = document.querySelectorAll('.apexcharts-series path');
            return Array.from(series).map(s => {
                const d = s.getAttribute('d');
                // Extract y-coordinates from path
                const yCoords = d.match(/L[\d.]+\s+([\d.]+)/g)?.map(m => parseFloat(m.split(' ')[1]));
                return yCoords ? Math.min(...yCoords) : null;
            });
        });

        // All series should have different minimum y-positions (indicating they're spread out)
        const uniquePositions = [...new Set(positions.filter(p => p !== null))];
        expect(uniquePositions.length).toBeGreaterThan(1);
    });
});