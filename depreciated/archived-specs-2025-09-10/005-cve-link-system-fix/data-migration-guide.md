# CVE Data Migration Guide

## Overview

This guide documents the safe migration strategy for fixing truncated CVE records in the HexTrackr database. The migration tool addresses the data loss issue (B004) where multi-CVE entries were truncated to only store the first CVE.

**Task**: T042 - Data migration strategy for existing truncated CVE records
**Script**: `app/public/scripts/fix-truncated-cves.js`
**Created**: 2025-09-10 by Shemp (Overflow Handler)

## The Problem

### Original Bug (B004)

- **Issue**: When importing CSV files with multiple CVEs, only the first CVE was stored
- **Example**: `"CVE-2024-1234, CVE-2024-5678, CVE-2024-9999"` â†’ stored as `"CVE-2024-1234"`
- **Impact**: Lost vulnerability data, incomplete security assessments
- **Fixed**: Import logic now preserves all CVEs

### Data Recovery Challenge

- Lost CVE data cannot be automatically recovered from truncated fields
- However, CVE IDs often appear in description and plugin_name fields
- Migration tool can extract and restore these CVEs

## Migration Tool Features

### Enhanced Capabilities

1. **Automated Detection**
   - Scans all vulnerability records
   - Identifies single CVE entries that may be truncated
   - Extracts CVEs from description and plugin_name fields
   - Compares stored CVE with found CVEs

2. **Safe Migration Path**
   - Backup creation before any changes
   - Dry-run mode for testing
   - Validation of CVE formats
   - Detailed logging of all changes
   - Rollback capability via backups

3. **Reporting**
   - Statistics on affected records
   - Migration success/failure tracking
   - JSON log files for audit trail
   - Console output for monitoring

## Usage Instructions

### Step 1: Analysis

First, analyze your database to detect truncated records:

```bash
cd app/public/scripts
node fix-truncated-cves.js --analyze
```

**Output Example:**

```
ðŸ” CVE Data Migration Tool - Enhanced Version
=============================================
Mode: --analyze
Database: /path/to/hextrackr.db

âœ… Connected to HexTrackr database

ðŸ”Ž Automated Truncation Detection
ðŸ“Š Total vulnerability records: 1543

ðŸ“ˆ Detection Results:
   â€¢ Single CVE records: 892
   â€¢ Multi-CVE records: 651
   â€¢ Suspected truncations: 47

âš ï¸  Truncated Records Found:
ID    | Hostname        | Stored CVE      | Missing CVEs
------|-----------------|-----------------|------------------
234   | server01.local  | CVE-2024-1234   | CVE-2024-5678, CVE-2024-9999
```

### Step 2: Backup

Create a backup of your database:

```bash
node fix-truncated-cves.js --backup
```

This creates: `data/hextrackr_backup_[timestamp].db`

### Step 3: Dry Run

Test the migration without making changes:

```bash
node fix-truncated-cves.js --dry-run
```

**Output Example:**

```
ðŸ”„ DRY RUN - Safe CVE Data Migration
Processing 47 truncated records...

[DRY RUN] Would update record 234:
   From: CVE-2024-1234
   To:   CVE-2024-1234, CVE-2024-5678, CVE-2024-9999

ðŸ“Š Migration Summary:
   â€¢ Records processed: 47
   â€¢ Successful updates: 45
   â€¢ Errors: 2
```

### Step 4: Actual Migration

If dry-run looks good, perform the actual migration:

```bash
node fix-truncated-cves.js --migrate
```

**Output Example:**

```
ðŸ“¦ Creating database backup...
âœ… Backup created: data/hextrackr_backup_1736520000000.db

ðŸ”„ ACTUAL MIGRATION - Safe CVE Data Migration
âœ… Updated record 234: CVE-2024-1234 â†’ CVE-2024-1234, CVE-2024-5678, CVE-2024-9999

ðŸ“Š Migration Summary:
   â€¢ Records processed: 47
   â€¢ Successful updates: 45
   â€¢ Errors: 2

ðŸ“ Migration log saved: data/migration_log_1736520000000.json
âœ… Migration completed successfully!
```

## Migration Safety Features

### Validation

- **CVE Format**: Validates all CVEs match pattern `/^CVE-\d{4}-\d{4,}$/`
- **Duplicate Check**: Removes duplicate CVEs before updating
- **Data Integrity**: Preserves original data in backup

### Error Handling

- Skips records with invalid CVE formats
- Logs all errors with record IDs
- Continues processing even if individual records fail
- Exit code indicates success (0) or failure (1)

### Audit Trail

Migration creates detailed JSON log:

```json
{
  "timestamp": "2025-09-10T12:00:00.000Z",
  "mode": "--migrate",
  "stats": {
    "totalRecords": 1543,
    "truncatedRecords": 47,
    "fixedRecords": 45
  },
  "migrationLog": [
    {
      "id": 234,
      "hostname": "server01.local",
      "oldValue": "CVE-2024-1234",
      "newValue": "CVE-2024-1234, CVE-2024-5678, CVE-2024-9999",
      "status": "success"
    }
  ]
}
```

## Alternative: Re-Import Strategy

If you have access to original CSV files:

### Advantages

- **Complete Data**: Restores all original CVE information
- **Clean Import**: Uses fixed import logic
- **No Guesswork**: Doesn't rely on extracting from descriptions

### Process

1. Export current vulnerability IDs for reference
2. Clear affected vulnerability records
3. Re-import CSV files with fixed import logic
4. Verify all CVEs properly stored

### Commands

```bash
# Export current data (optional)
sqlite3 data/hextrackr.db "SELECT * FROM vulnerabilities" > backup.csv

# Re-import with fixed logic
# Use the web UI import feature or API endpoint
```

## Post-Migration Verification

### Database Checks

```sql
-- Check for multi-CVE records
SELECT COUNT(*) FROM vulnerabilities 
WHERE cve LIKE '%,%' OR cve LIKE '% %';

-- Verify no truncation patterns remain
SELECT id, hostname, cve FROM vulnerabilities 
WHERE cve LIKE 'CVE-%' 
  AND (description LIKE '%CVE-%' OR plugin_name LIKE '%CVE-%')
LIMIT 10;
```

### Functional Testing

1. **CVE Link Test**: Click individual CVE links
   - Should open ONLY the clicked CVE
   - Not all CVEs in the record

2. **Modal Display**: Verify CVE details show correctly
   - Correct CVE information displayed
   - External links work properly

3. **Performance**: Check with many CVEs
   - Page load time acceptable
   - No browser freezing

## Rollback Procedure

If issues occur after migration:

### Using Backup

```bash
# Stop the application
docker-compose down

# Restore backup
cp data/hextrackr_backup_[timestamp].db data/hextrackr.db

# Restart application
docker-compose up -d
```

### Verification

```bash
# Check database integrity
sqlite3 data/hextrackr.db "PRAGMA integrity_check;"

# Verify record count
sqlite3 data/hextrackr.db "SELECT COUNT(*) FROM vulnerabilities;"
```

## Prevention Measures

### Going Forward

1. **Fixed Import Logic**: Server.js now properly handles multi-CVE strings
2. **CVE Utilities Module**: Provides consistent CVE handling
3. **Event Isolation**: Prevents UI issues with multiple CVEs
4. **Validation**: All CVE inputs validated before storage

### Monitoring

- Regular checks for truncation patterns
- Audit imports for completeness
- Monitor CVE field consistency

## Troubleshooting

### Common Issues

#### "Database is locked"

- Stop the application before migration
- `docker-compose down`

#### "Invalid CVE format"

- Some records may have malformed CVEs
- Check migration log for details
- Manual correction may be needed

#### "No records to migrate"

- Database may already be clean
- Or detection didn't find patterns
- Check manually with SQL queries

### Getting Help

- Check migration logs in `data/migration_log_*.json`
- Review error messages in console output
- Verify backup exists before troubleshooting

## Summary

The enhanced migration tool provides:

- **Automated detection** of truncated CVE records
- **Safe migration** with backup and dry-run modes
- **Detailed logging** for audit and troubleshooting
- **Validation** to ensure data integrity
- **Flexibility** with multiple operation modes

This comprehensive approach ensures existing data can be safely recovered while preventing future data loss through the fixed import logic and CVE utilities module.

---

*"Heyyy, I made sure your data migration is safer than a bank vault, you knuckleheads! Even included rollback procedures!"* - Shemp
