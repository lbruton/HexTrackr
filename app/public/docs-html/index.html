<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HexTrackr Documentation Portal</title>

    <!-- FOUC Prevention: Apply theme before CSS loads -->
    <script>
    (function() {
        try {
            var stored = localStorage.getItem('hextrackr-theme');
            if (stored) {
                // FIX (HEX-140): Handle both JSON and simple string formats
                var theme = null;
                try {
                    var data = JSON.parse(stored);
                    theme = data.theme || data; // Handle {"theme":"dark"} or "dark"
                } catch (parseError) {
                    // Simple string format (backward compatibility)
                    theme = stored;
                }
                if (theme === 'dark' || theme === 'light') {
                    document.documentElement.setAttribute('data-bs-theme', theme);
                }
            } else {
                // Fallback to sessionStorage (private browsing)
                stored = sessionStorage.getItem('hextrackr-theme');
                if (stored) {
                    var theme = null;
                    try {
                        var data = JSON.parse(stored);
                        theme = data.theme || data;
                    } catch (parseError) {
                        theme = stored;
                    }
                    if (theme === 'dark' || theme === 'light') {
                        document.documentElement.setAttribute('data-bs-theme', theme);
                    }
                }
            }
        } catch(e) {
            // Silent fail - theme controller will handle initialization
        }
    })();
    </script>

    <link href="../vendor/tabler/css/tabler.min.css" rel="stylesheet">
    <!-- Font Awesome (LOCAL HOSTED - eliminates glyph bbox warnings) -->
    <link href="../fonts/fontawesome.min.css" rel="stylesheet">

    <!-- AG Grid CSS for advanced tables -->
    <link rel="stylesheet" href="../vendor/ag-grid/ag-theme-quartz.css">

    <!-- Modular HexTrackr CSS -->
    <link rel="stylesheet" href="../styles/shared/base.css">
    <link rel="stylesheet" href="../styles/shared/header.css">
    <link rel="stylesheet" href="../styles/shared/dark-theme.css">
    <link rel="stylesheet" href="../styles/css-variables.css">
    <link rel="stylesheet" href="../styles/shared/modals.css">
    <!-- Prism.js custom theme in docs-tabler.css (HEX-167) - DO NOT load CDN theme -->
    <link href="./css/docs-tabler.css" rel="stylesheet">
</head>
<body>
    <!-- Header component auto-injected here -->
    <div id="headerContainer"></div>

    <!-- Main Page Content -->
    <div class="page">
        <div class="page-wrapper">
            
            <!-- Page body -->
            <div class="page-body">
                <div class="container-xl">
                    <!-- Breadcrumb Navigation -->
                    <div class="row">
                        <div class="col-12">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb" id="breadcrumb">
                                    <!-- Breadcrumb will be populated by JavaScript -->
                                </ol>
                            </nav>
                        </div>
                    </div>
                    
                    <div class="row">
                        <!-- Navigation Panel -->
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <path d="M14 3v4a1 1 0 0 0 1 1h4"/>
                                            <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z"/>
                                            <path d="M9 9l1 0"/>
                                            <path d="M9 13l6 0"/>
                                            <path d="M9 17l6 0"/>
                                        </svg>
                                        Navigation
                                    </h3>
                                </div>
                                <div class="card-body">
                                    <div class="list-group list-group-flush" id="docsNavigation">
                                        <!-- Navigation will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Main Content -->
                        <div class="col-md-9">
                            <div class="card">
                                <div class="card-body">
                                    <div id="contentArea" class="docs-content">
                                        <!-- Content will be loaded here -->
                                        <div class="d-flex justify-content-center my-5">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Back to Top Button -->
        <button id="backToTop" class="btn btn-primary back-to-top">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                <polyline points="7 11 12 6 17 11"/>
                <polyline points="7 17 12 12 17 17"/>
            </svg>
        </button>
        </div>
    </div>

    <!-- Footer component auto-injected here -->
    <div id="footerContainer"></div>

    <!-- Settings Modal Container - Auto-injected by shared/settings-modal.js -->
    <div id="settingsModalContainer"></div>

    <!-- Scripts -->
    <script src="../vendor/tabler/js/tabler.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism autoloader to load language grammars from CDN
        if (window.Prism) {
            Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
        }
    </script>
    <!-- Markdown parsing library for external files -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.0.0/marked.min.js"></script>

    <!-- AG Grid for advanced data tables -->
    <script src="../vendor/ag-grid/ag-grid-community.min.js"></script>

    <!-- Mermaid.js for diagram rendering -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

    <!-- Security: DOMPurify for XSS protection -->
    <script src="../scripts/utils/purify.min.js"></script>
    
    <!-- Theme Controller -->
    <!-- CRITICAL: Must use type="module" for ES6 imports to work
         DO NOT REMOVE type="module" - this breaks the theme synchronization
         This has been incorrectly changed multiple times causing import errors -->
    <script type="module" src="../scripts/shared/theme-controller.js"></script>

    <!-- Logger Utility (loaded first for zero-cost production logging) -->
    <script src="../scripts/shared/logger.js"></script>

    <!-- Shared component loaders -->
    <script src="../scripts/shared/config-loader.js"></script>
    <script src="../scripts/shared/header-loader.js"></script>
    <!-- HEX-133 Task 1.5: Authentication state management for user menu -->
    <script src="../scripts/shared/auth-state.js"></script>

    <!-- User Preferences Service (HEX-138) -->
    <script src="../scripts/shared/preferences-service.js"></script>
    <script src="../scripts/shared/preferences-sync.js"></script>

    <script>
        /**
         * Initialize authentication state and user menu (HEX-137)
         * Checks session, updates user menu with Change Password/Sign Out when authenticated
         * Docs portal is public - no redirect if unauthenticated
         */
        document.addEventListener('DOMContentLoaded', async () => {
            const isAuth = await authState.init();

            if (isAuth) {
                // Update user menu in shared header with authenticated options
                authState.updateUserMenu();

                console.log('✅ Authenticated as:', authState.getUser().username);

                // HEX-138: Load user preferences from database
                if (window.preferencesSync) {
                    await window.preferencesSync.initialize();
                }
            } else {
                console.log('ℹ️ Viewing docs as guest (not authenticated)');
            }
        });
    </script>
    <script src="../scripts/shared/footer-loader.js"></script>
    <script src="../scripts/shared/backup-modal.js"></script>
    <script src="../scripts/shared/settings-modal.js"></script>
    <!-- Page-specific script -->
    <script src="./js/docs-portal-v2.js"></script>
    <!-- Documentation table converter for AG-Grid integration -->
    <script src="./js/table-converter.js"></script>
    <!-- Roadmap table sorting functionality -->
    <script src="./js/roadmap-table-sorter.js"></script>
</body>
</html>
