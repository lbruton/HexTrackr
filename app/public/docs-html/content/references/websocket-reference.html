<!-- Fragment template for documentation content injected by docs-tabler.js -->
<section class="doc-fragment">
    <h1>WebSocket Reference</h1>
<p>This reference complements the <a href="#api-reference/websocket-api">WebSocket API</a> by documenting the low-level classes and events used inside HexTrackr. The implementation lives in <code>server.js</code> (backend) and <code>app/public/scripts/shared/websocket-client.js</code> (frontend).</p>
<hr>
<h2>ProgressTracker (server.js)</h2>
<p>The <code>ProgressTracker</code> class encapsulates session lifecycle management for long-running operations (CSV imports, backups, restores).</p>
<h3>Constructor</h3>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> tracker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProgressTracker</span>(io);</code></pre><ul>
<li><code>io</code>: Socket.io server instance.</li>
<li>Initialises throttling (<code>THROTTLE_INTERVAL = 100 ms</code>) and a hourly cleanup timer.</li>
</ul>
<h3>createSession(metadata?)</h3>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> sessionId = tracker.<span class="hljs-title function_">createSession</span>({ <span class="hljs-attr">operation</span>: <span class="hljs-string">&#x27;csv-import&#x27;</span> });</code></pre><ul>
<li>Generates a UUID v4 and stores <code>{ progress, status, metadata }</code>.</li>
<li>Returns the <code>sessionId</code> string.</li>
<li>Emits nothing immediately-the client joins via <code>join-progress</code> to receive state.</li>
</ul>
<h3>createSessionWithId(sessionId, metadata?)</h3>
<pre><code class="language-javascript">tracker.<span class="hljs-title function_">createSessionWithId</span>(frontendId, { <span class="hljs-attr">operation</span>: <span class="hljs-string">&#x27;csv-import&#x27;</span> });</code></pre><ul>
<li>Uses a caller-supplied identifier (the staging importer forwards the ID returned by the frontend).</li>
<li>Overwrites any existing state with the same ID.</li>
</ul>
<h3>updateProgress(sessionId, progress, message?, metadata?)</h3>
<pre><code class="language-javascript">tracker.<span class="hljs-title function_">updateProgress</span>(sessionId, <span class="hljs-number">60</span>, <span class="hljs-string">&#x27;Processing batch 3/10&#x27;</span>, { <span class="hljs-attr">currentStep</span>: <span class="hljs-number">3</span> });</code></pre><ul>
<li>Clamps <code>progress</code> to the <code>0-100</code> range.</li>
<li>Merges <code>metadata</code> into the stored session data.</li>
<li>Emits a throttled <code>progress-update</code> event to room <code>progress-{sessionId}</code>.</li>
</ul>
<h3>completeSession(sessionId, message?, metadata?)</h3>
<pre><code class="language-javascript">tracker.<span class="hljs-title function_">completeSession</span>(sessionId, <span class="hljs-string">&#x27;Import completed successfully&#x27;</span>);</code></pre><ul>
<li>Sets status to <code>completed</code> and progress to <code>100</code>.</li>
<li>Emits <code>progress-complete</code> (no throttling) to the room.</li>
<li>Schedules cleanup five seconds later.</li>
</ul>
<h3>errorSession(sessionId, message, details?)</h3>
<pre><code class="language-javascript">tracker.<span class="hljs-title function_">errorSession</span>(sessionId, <span class="hljs-string">&#x27;Failed to prepare for batch processing&#x27;</span>, { <span class="hljs-attr">code</span>: <span class="hljs-string">&#x27;SQLITE_BUSY&#x27;</span> });</code></pre><ul>
<li>Sets status to <code>error</code> and stores the supplied details.</li>
<li>Emits <code>progress-error</code> immediately.</li>
<li>Schedules cleanup ten seconds later.</li>
</ul>
<h3>getSession(sessionId)</h3>
<p>Returns the current session object or <code>null</code> if not found. Used when new connections join a room to emit <code>progress-status</code>.</p>
<h3>cleanupStaleSessions()</h3>
<p>Runs hourly to remove sessions where <code>lastUpdate</code> is older than one hour.</p>
<hr>
<h2>Socket Handlers (server.js)</h2>
<pre><code class="language-javascript">io.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;connection&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">socket</span>) =&gt;</span> {
  socket.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;join-progress&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">sessionId</span>) =&gt;</span> { ... });
  socket.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;leave-progress&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">sessionId</span>) =&gt;</span> { ... });
  socket.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;disconnect&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">reason</span>) =&gt;</span> { ... });
});</code></pre><ul>
<li><strong>join-progress</strong>: adds the socket to <code>progress-{sessionId}</code> and emits <code>progress-status</code> if a session already exists.</li>
<li><strong>leave-progress</strong>: removes the socket from the room.</li>
<li><strong>disconnect</strong>: debug logs only (no cleanup required-the session timer handles it).</li>
</ul>
<hr>
<h2>Event Payloads</h2>
<p>See the API document for canonical payload examples. For convenience:</p>
<table>
<thead>
<tr>
<th>Event</th>
<th>When Emitted</th>
<th>Key Fields</th>
</tr>
</thead>
<tbody><tr>
<td><code>progress-status</code></td>
<td>Client joins a room with an existing session</td>
<td><code>sessionId</code>, <code>progress</code>, <code>status</code>, <code>metadata</code></td>
</tr>
<tr>
<td><code>progress-update</code></td>
<td>Tracker receives <code>updateProgress</code> (throttled)</td>
<td><code>sessionId</code>, <code>progress</code>, <code>message</code>, <code>metadata</code>, <code>timestamp</code></td>
</tr>
<tr>
<td><code>progress-complete</code></td>
<td>Tracker finishes a session</td>
<td><code>sessionId</code>, <code>message</code>, <code>metadata</code>, <code>duration</code></td>
</tr>
<tr>
<td><code>progress-error</code></td>
<td>Tracker marks a session as failed</td>
<td><code>sessionId</code>, <code>message</code>, <code>metadata</code>, <code>error</code></td>
</tr>
</tbody></table>
<p>All events are sent to room <code>progress-{sessionId}</code> only.</p>
<hr>
<h2>WebSocketClient (frontend)</h2>
<p><code>scripts/shared/websocket-client.js</code> wraps Socket.io and exposes an event emitter style API.</p>
<h3>Instantiation</h3>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> client = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocketClient</span>();
<span class="hljs-keyword">await</span> client.<span class="hljs-title function_">connect</span>();</code></pre><ul>
<li>Auto-detects host/port from <code>window.location</code>.</li>
<li>Attempts WebSocket first with polling fallback.</li>
<li>Retries up to five times with exponential backoff.</li>
</ul>
<h3>Debugging</h3>
<p>Enable verbose console output with:</p>
<pre><code class="language-javascript"><span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">&#x27;hextrackr_debug&#x27;</span>, <span class="hljs-string">&#x27;true&#x27;</span>);</code></pre><p>Remove the key to disable logging.</p>
<h3>Events Exposed by WebSocketClient</h3>
<table>
<thead>
<tr>
<th>Event</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>progress</code></td>
<td>Forwarded <code>progress-update</code> payloads.</td>
</tr>
<tr>
<td><code>progressStatus</code></td>
<td>Forwarded <code>progress-status</code> payloads.</td>
</tr>
<tr>
<td><code>progressComplete</code></td>
<td>Forwarded <code>progress-complete</code> payloads.</td>
</tr>
<tr>
<td><code>progressError</code></td>
<td>Forwarded <code>progress-error</code> payloads.</td>
</tr>
<tr>
<td><code>connectionFailed</code></td>
<td>Fired after all reconnection attempts fail.</td>
</tr>
<tr>
<td><code>disconnect</code></td>
<td>Fired when Socket.io disconnects (reason included).</td>
</tr>
</tbody></table>
<h3>Room Management Helpers</h3>
<p>The client automatically emits <code>join-progress</code> when the Progress Modal opens and <code>leave-progress</code> when it closes. Custom integrations can call:</p>
<pre><code class="language-javascript">client.<span class="hljs-title function_">emit</span>(<span class="hljs-string">&#x27;join-progress&#x27;</span>, sessionId);
client.<span class="hljs-title function_">emit</span>(<span class="hljs-string">&#x27;leave-progress&#x27;</span>, sessionId);</code></pre><h3>Manual Fallback</h3>
<p>When <code>connectionFailed</code> fires, consumers should revert to manual updates. The Progress Modal already implements this behaviour by hiding live status indicators and relying on HTTP responses to advance progress.</p>
<hr>
<h2>Error Handling Tips</h2>
<ul>
<li>Watch for <code>progress-error</code> payloads - they include the underlying SQLite or validation error details.</li>
<li>If a client reconnects mid-import, call <code>join-progress</code> again to receive the last known snapshot via <code>progress-status</code>.</li>
<li>When running in environments without WebSocket support, the importer still works: only the real-time UX is affected.</li>
</ul>

    <!-- Note: This file is intentionally minimal. The full page scaffold, header, footer, and scripts
             are provided by docs-html/index.html. Content generated using this template will be
             fetched and injected into #content-container by docs-html/js/docs-portal-v2.js. -->
</section>
