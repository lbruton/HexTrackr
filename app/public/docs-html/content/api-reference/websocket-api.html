<!-- Fragment template for documentation content injected by docs-tabler.js -->
<section class="doc-fragment">
    <h1>WebSocket API</h1>
<p>HexTrackr uses Socket.io on the main Express server (default port <code>8989</code>) to stream long-running operation progress. WebSocket integration is optional—the UI falls back to manual polling when a socket connection is unavailable.</p>
<hr>
<h2>Server Configuration</h2>
<ul>
<li><strong>Port</strong>: shares the Express HTTP server (<code>http://localhost:8989</code>)</li>
<li><strong>Library</strong>: <code>socket.io</code></li>
<li><strong>Transports</strong>: <code>polling</code> upgradeable to <code>websocket</code></li>
<li><strong>Rooms</strong>: per-session namespace <code>progress-{sessionId}</code></li>
<li><strong>Throttle</strong>: minimum 100 ms between <code>progress-update</code> events</li>
</ul>
<p>The server registers listeners in <code>server.js</code> and manages state through <code>ProgressTracker</code>.</p>
<h3>ProgressTracker Session Model</h3>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;uuid&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;progress&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">45</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;processing&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;startTime&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1724190482000</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;lastUpdate&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1724190491000</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;metadata&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;operation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;csv-import&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;filename&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;scan.csv&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;scanDate&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2025-08-20&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;totalSteps&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;currentStep&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;message&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Loading data to staging table...&quot;</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span></code></pre><p>Sessions are created via <code>ProgressTracker.createSession()</code> (or <code>createSessionWithId</code> when the client supplies its own UUID). They emit progress to the associated room and are cleaned up automatically after completion or after one hour of inactivity.</p>
<hr>
<h2>Event Reference</h2>
<table>
<thead>
<tr>
<th>Event</th>
<th>Direction</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>progress-update</code></td>
<td>server → client</td>
<td>Throttled incremental updates. Includes <code>progress</code>, <code>message</code>, <code>status</code>, and <code>metadata</code>.</td>
</tr>
<tr>
<td><code>progress-status</code></td>
<td>server → client</td>
<td>Snapshot sent immediately after joining a room so reconnecting clients can resume display.</td>
</tr>
<tr>
<td><code>progress-complete</code></td>
<td>server → client</td>
<td>Signals successful completion. Contains final metadata and duration.</td>
</tr>
<tr>
<td><code>progress-error</code></td>
<td>server → client</td>
<td>Signals a fatal error with additional context under <code>error</code>.</td>
</tr>
<tr>
<td><code>join-progress</code></td>
<td>client → server</td>
<td>Subscribes the socket to a progress room (<code>progress-{sessionId}</code>).</td>
</tr>
<tr>
<td><code>leave-progress</code></td>
<td>client → server</td>
<td>Unsubscribes from a room when no longer needed.</td>
</tr>
</tbody></table>
<h3>Event Payloads</h3>
<h4><code>progress-update</code></h4>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;sessionId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1f4bba9b-3f8c-4d13-8cb8-4dedc1b7a9a2&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;progress&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">60</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;message&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Staging complete. Processing 9850 records to final tables...&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;processing&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;timestamp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1724190493000</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;metadata&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;operation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;csv-import&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;currentStep&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;insertedToStaging&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">9850</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span></code></pre><h4><code>progress-complete</code></h4>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;sessionId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1f4bba9b-3f8c-4d13-8cb8-4dedc1b7a9a2&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;progress&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;message&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Import completed successfully&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;completed&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;timestamp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1724190525000</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;metadata&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;operation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;csv-import&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;duration&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">42350</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;recordsCreated&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">9850</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span></code></pre><h4><code>progress-error</code></h4>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;sessionId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1f4bba9b-3f8c-4d13-8cb8-4dedc1b7a9a2&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;progress&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">45</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;message&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Failed to prepare for batch processing&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;error&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;timestamp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1724190508000</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;metadata&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;operation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;csv-import&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;currentStep&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;message&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Failed to prepare for batch processing&quot;</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;error&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;code&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;SQLITE_BUSY&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;detail&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;database is locked&quot;</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span></code></pre><hr>
<h2>Client Integration</h2>
<p><code>app/public/scripts/shared/websocket-client.js</code> wraps Socket.io and exposes a resilient API used by the Progress Modal.</p>
<h3>Connection Lifecycle</h3>
<pre><code class="language-javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">WebSocketClient</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./scripts/shared/websocket-client.js&#x27;</span>;

<span class="hljs-keyword">const</span> client = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocketClient</span>();
<span class="hljs-keyword">await</span> client.<span class="hljs-title function_">connect</span>();

client.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;progress&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">payload</span>) =&gt;</span> <span class="hljs-title function_">updateProgressUI</span>(payload));
client.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;progressComplete&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">payload</span>) =&gt;</span> <span class="hljs-title function_">handleComplete</span>(payload));
client.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;progressStatus&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">payload</span>) =&gt;</span> <span class="hljs-title function_">hydrateFromSnapshot</span>(payload));
client.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;progressError&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">payload</span>) =&gt;</span> <span class="hljs-title function_">showError</span>(payload));
client.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;connectionFailed&#x27;</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">enableManualFallback</span>());</code></pre><h4>Debug Logging</h4>
<p>Set <code>localStorage.hextrackr_debug = &quot;true&quot;</code> to enable verbose console output inside the client wrapper. Logging automatically disables when the value is removed.</p>
<h3>Joining Rooms</h3>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> sessionId = <span class="hljs-string">&#x27;1f4bba9b-3f8c-4d13-8cb8-4dedc1b7a9a2&#x27;</span>;
client.<span class="hljs-title function_">emit</span>(<span class="hljs-string">&#x27;join-progress&#x27;</span>, sessionId);</code></pre><p>The Progress Modal automatically joins when the staging importer returns a session ID and calls <code>leave-progress</code> when the modal closes.</p>
<h3>Reconnection &amp; Fallback</h3>
<ul>
<li>Automatic retries use exponential backoff up to five attempts.</li>
<li>The Progress Modal listens for the <code>connectionFailed</code> callback. When triggered, it displays a warning and continues with manual UI updates provided by HTTP responses.</li>
<li>Heartbeats (<code>ping</code>/<code>pong</code>) run every 30 s to detect broken connections.</li>
</ul>
<hr>
<h2>Manual Mode (No WebSocket)</h2>
<p>If Socket.io is unavailable the UI still works:</p>
<ol>
<li>The <code>WebSocketClient</code> rejects the connection and emits <code>connectionFailed</code>.</li>
<li><code>progress-modal.js</code> switches to manual mode and updates progress via standard UI callbacks.</li>
<li>Import workflows continue unaffected—the WebSocket stream only enhances user feedback.</li>
</ol>
<hr>
<h2>Security Considerations</h2>
<ul>
<li>WebSocket access is limited to local development origins (<code>http://localhost:8080</code>, <code>http://127.0.0.1:8080</code>). Adjust the CORS list in <code>server.js</code> for other environments.</li>
<li>Room names embed the session identifier; treat session IDs as opaque GUIDs.</li>
<li>No authentication layer is implemented. Deploy behind a trusted network segment or add your own gateway.</li>
</ul>

    <!-- Note: This file is intentionally minimal. The full page scaffold, header, footer, and scripts
             are provided by docs-html/index.html. Content generated using this template will be
             fetched and injected into #content-container by docs-html/js/docs-portal-v2.js. -->
</section>
