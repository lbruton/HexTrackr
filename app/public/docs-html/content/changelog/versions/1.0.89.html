<!-- Fragment template for documentation content injected by docs-tabler.js -->
<section class="doc-fragment">
    <hr>
<h2>title: "Version 1.0.89 - Location Details Modal: Integration & Navigation (Session 3)"
date: "2025-10-18"
version: "1.0.89"
status: "In Progress"
category: "Enhancement"</h2><h1>Version 1.0.89 - Location Details Modal: Integration & Navigation (Session 3)</h1><p><strong>Release Status</strong>: üöß In Progress<br><strong>Release Date</strong>: TBD<br><strong>Parent Issue</strong>: <a href="https://linear.app/hextrackr/issue/HEX-288">HEX-288</a> (Location Cards)<br><strong>Implementation</strong>: <a href="https://linear.app/hextrackr/issue/HEX-295">HEX-295</a> Session 3 of 4</p>
<h2>Overview</h2><p>Session 3 integrates ticket functionality and modal navigation into the Location Details Modal. Implements real ticket counts via batch endpoint, ticket creation/view navigation, and modal launch from location cards. Advisory helper integration deferred to Session 4.</p>
<h2>Implementation Tasks</h2><h3>Completed</h3><ul>
<li><input checked="" disabled="" type="checkbox"> Implement ticket count aggregation using <code>POST /api/tickets/batch-device-lookup</code></li>
<li><input checked="" disabled="" type="checkbox"> Implement <code>createTicket(hostname)</code> to launch ticket creation modal</li>
<li><input checked="" disabled="" type="checkbox"> Implement <code>viewTickets(hostname)</code> to show ticket picker modal</li>
<li><input checked="" disabled="" type="checkbox"> Update <code>location-cards.js</code> with click handler to launch modal</li>
<li><input checked="" disabled="" type="checkbox"> Enable &quot;View Site Details&quot; button (was disabled in Session 2)</li>
<li><input checked="" disabled="" type="checkbox"> Convert <code>aggregateDeviceData()</code> to async for ticket integration</li>
<li><input checked="" disabled="" type="checkbox"> Convert <code>createLocationDevicesGrid()</code> to async</li>
<li><input checked="" disabled="" type="checkbox"> Convert <code>showModal()</code> to async</li>
<li><input checked="" disabled="" type="checkbox"> ESLint quote style fixes (auto-fixed)</li>
</ul>
<h3>Deferred to Session 4</h3><ul>
<li><input disabled="" type="checkbox"> Add color-coded ticket status badges (Overdue=red, Pending=yellow, Open=blue)</li>
<li><input disabled="" type="checkbox"> Integrate <code>ciscoAdvisoryHelper.getFixedVersion()</code> for accurate version data</li>
<li><input disabled="" type="checkbox"> Integrate <code>paloAdvisoryHelper.getFixedVersion()</code> for accurate version data</li>
<li><input disabled="" type="checkbox"> Add async loading states for fixed version column (spinner/placeholder)</li>
</ul>
<h2>Technical Details</h2><p><strong>Files Modified</strong>:</p>
<ul>
<li><p><code>app/public/scripts/shared/location-details-modal.js</code> - Added ~90 lines of ticket integration</p>
<ul>
<li><code>checkTicketStateBatch(hostnames)</code> - Batch ticket lookup (lines 655-695)</li>
<li><code>createTicket(hostname)</code> - Navigate to ticket creation (lines 837-858)</li>
<li><code>viewTickets(hostname)</code> - Navigate to ticket picker or single ticket (lines 866-894)</li>
<li><code>showTicketPickerModal(hostname, tickets)</code> - Display multi-ticket picker (lines 903-914)</li>
<li>Converted <code>aggregateDeviceData()</code> to async (lines 705-811)</li>
<li>Converted <code>createLocationDevicesGrid()</code> to async (lines 421-646)</li>
<li>Converted <code>showModal()</code> to async (lines 930-961)</li>
</ul>
</li>
<li><p><code>app/public/scripts/shared/location-cards.js</code> - Updated card click handlers</p>
<ul>
<li>Added location data serialization for modal (line 376)</li>
<li>Changed card <code>onclick</code> to launch modal instead of filter (line 381)</li>
<li>Enabled &quot;View Site Details&quot; button (was disabled, now launches modal) (lines 451-454)</li>
</ul>
</li>
</ul>
<p><strong>Pattern Sources</strong>:</p>
<ul>
<li>Ticket batch lookup: <code>vulnerability-grid.js:51-98</code> (HEX-216 batch optimization)</li>
<li>Ticket creation flow: <code>device-security-modal.js:947-987</code></li>
<li>Ticket navigation: <code>device-security-modal.js:989-1003</code></li>
<li>Ticket picker modal: <code>vulnerability-cards.js:269-312</code></li>
</ul>
<p><strong>API Endpoints Used</strong>:</p>
<ul>
<li><code>POST /api/tickets/batch-device-lookup</code> - Aggregate ticket counts per device</li>
<li><code>GET /api/auth/csrf</code> - CSRF token for POST requests</li>
</ul>
<p><strong>Ticket Navigation Logic</strong>:</p>
<pre><code class="language-javascript"><span class="hljs-comment">// Three-tier pattern based on ticket count:</span>
<span class="hljs-keyword">if</span> (ticketCount === <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// Navigate to ticket creation with pre-filled device</span>
    <span class="hljs-variable language_">sessionStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">&quot;createTicketData&quot;</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
        <span class="hljs-attr">devices</span>: [hostname],
        <span class="hljs-attr">site</span>: hostname.<span class="hljs-title function_">substring</span>(<span class="hljs-number">0</span>, <span class="hljs-number">4</span>).<span class="hljs-title function_">toUpperCase</span>(),
        <span class="hljs-attr">location</span>: hostname.<span class="hljs-title function_">substring</span>(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>).<span class="hljs-title function_">toUpperCase</span>()
    }));
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-string">&quot;/tickets.html&quot;</span>;
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ticketCount === <span class="hljs-number">1</span>) {
    <span class="hljs-comment">// Navigate directly to single ticket</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-string">`/tickets.html?openTicket=<span class="hljs-subst">${tickets[<span class="hljs-number">0</span>].id}</span>`</span>;
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// Show picker modal for multiple tickets</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">ticketPickerModal</span>.<span class="hljs-title function_">show</span>(hostname, tickets);
}</code></pre><h2>Success Criteria</h2><ul>
<li><input checked="" disabled="" type="checkbox"> Version bumped to 1.0.89 across 5 files</li>
<li><input checked="" disabled="" type="checkbox"> Ticket counts display correctly in grid (using batch endpoint)</li>
<li><input checked="" disabled="" type="checkbox"> &quot;Create Ticket&quot; button navigates to ticket creation page</li>
<li><input checked="" disabled="" type="checkbox"> &quot;View Tickets (N)&quot; button navigates to ticket picker or single ticket</li>
<li><input checked="" disabled="" type="checkbox"> Location card click opens Location Details Modal</li>
<li><input checked="" disabled="" type="checkbox"> &quot;View Site Details&quot; button opens Location Details Modal</li>
<li><input checked="" disabled="" type="checkbox"> Hostname click navigates to Device Modal (from Session 2)</li>
<li><input checked="" disabled="" type="checkbox"> ESLint clean (no new errors, quotes auto-fixed)</li>
<li><input disabled="" type="checkbox"> Ticket badges with color coding (deferred to Session 4)</li>
<li><input disabled="" type="checkbox"> Fixed versions with advisory data (deferred to Session 4)</li>
<li><input disabled="" type="checkbox"> Async loading states (deferred to Session 4)</li>
</ul>
<h2>Related Issues</h2><ul>
<li>Parent: <a href="https://linear.app/hextrackr/issue/HEX-288">HEX-288</a> - Location Cards</li>
<li>Implementation: <a href="https://linear.app/hextrackr/issue/HEX-295">HEX-295</a> - Location Details Modal</li>
<li>Session 1: v1.0.87 (Core modal structure)</li>
<li>Session 2: v1.0.88 (Grid + filters)</li>
<li>Session 3: v1.0.89 (Integration + navigation) üöß</li>
<li>Session 4: v1.0.90 (Enhancements)</li>
</ul>
<h2>Progress</h2><p><strong>Sessions Complete</strong>: 2/4 (50%)</p>
<ul>
<li>‚úÖ Session 1: Core modal structure (v1.0.87)</li>
<li>‚úÖ Session 2: Grid + filters implementation (v1.0.88)</li>
<li>üöß Session 3: Ticket integration + fixed version helpers (v1.0.89)</li>
<li>‚è≥ Session 4: Final polish + enhancements (v1.0.90)</li>
</ul>
<h2>Testing Plan</h2><p><strong>Manual Testing Scenarios</strong>:</p>
<ol>
<li><strong>Location Card Click</strong>: Click any location card ‚Üí Modal opens with correct data</li>
<li><strong>View Site Details Button</strong>: Click &quot;View Site Details&quot; button ‚Üí Modal opens</li>
<li><strong>Ticket Count Accuracy</strong>: Verify batch endpoint returns correct ticket counts in grid</li>
<li><strong>Create Ticket Flow</strong>: Click &quot;Create&quot; button ‚Üí Navigate to /tickets.html with pre-filled device data</li>
<li><strong>View Single Ticket</strong>: Click &quot;View Ticket&quot; ‚Üí Navigate directly to ticket edit page</li>
<li><strong>View Multiple Tickets</strong>: Click &quot;View Tickets (N)&quot; ‚Üí Ticket picker modal shows N tickets</li>
<li><strong>Grid Population</strong>: Verify 7 columns display with correct data including ticket counts</li>
<li><strong>Device Navigation</strong>: Click hostname ‚Üí Navigate to Device Modal (Session 2 feature)</li>
<li><strong>Modal Theme</strong>: Verify dark/light theme propagates correctly to modal</li>
<li><strong>Severity Filters</strong>: Click severity cards ‚Üí Grid filters correctly (Session 2 feature)</li>
</ol>
<p><strong>Browser Console Test</strong>:</p>
<pre><code class="language-javascript"><span class="hljs-comment">// Test location card click (simulated)</span>
<span class="hljs-keyword">const</span> testLocation = {
  <span class="hljs-attr">location</span>: <span class="hljs-string">&quot;wtulsa&quot;</span>,
  <span class="hljs-attr">location_display</span>: <span class="hljs-string">&quot;WTULSA&quot;</span>,
  <span class="hljs-attr">device_count</span>: <span class="hljs-number">42</span>,
  <span class="hljs-attr">total_vpr</span>: <span class="hljs-number">1847.3</span>,
  <span class="hljs-attr">severity_breakdown</span>: {
    <span class="hljs-title class_">Critical</span>: { <span class="hljs-attr">count</span>: <span class="hljs-number">12</span>, <span class="hljs-attr">vpr</span>: <span class="hljs-number">456.2</span> },
    <span class="hljs-title class_">High</span>: { <span class="hljs-attr">count</span>: <span class="hljs-number">28</span>, <span class="hljs-attr">vpr</span>: <span class="hljs-number">892.1</span> },
    <span class="hljs-title class_">Medium</span>: { <span class="hljs-attr">count</span>: <span class="hljs-number">15</span>, <span class="hljs-attr">vpr</span>: <span class="hljs-number">398.0</span> },
    <span class="hljs-title class_">Low</span>: { <span class="hljs-attr">count</span>: <span class="hljs-number">8</span>, <span class="hljs-attr">vpr</span>: <span class="hljs-number">101.0</span> }
  },
  <span class="hljs-attr">kev_count</span>: <span class="hljs-number">3</span>,
  <span class="hljs-attr">open_tickets</span>: <span class="hljs-number">2</span>
};

<span class="hljs-variable language_">window</span>.<span class="hljs-property">locationDetailsModal</span>.<span class="hljs-title function_">showLocationDetails</span>(testLocation, <span class="hljs-variable language_">window</span>.<span class="hljs-property">vulnManager</span>?.<span class="hljs-property">dataManager</span>);
<span class="hljs-comment">// Expected: Modal opens, ticket counts appear in grid after batch fetch</span>

<span class="hljs-comment">// Test ticket batch lookup directly</span>
<span class="hljs-keyword">const</span> testDevices = [<span class="hljs-string">&quot;wtulsa-fw01&quot;</span>, <span class="hljs-string">&quot;wtulsa-sw01&quot;</span>, <span class="hljs-string">&quot;wtulsa-ap01&quot;</span>];
<span class="hljs-variable language_">window</span>.<span class="hljs-property">locationDetailsModal</span>.<span class="hljs-title function_">checkTicketStateBatch</span>(testDevices).<span class="hljs-title function_">then</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">log</span>);
<span class="hljs-comment">// Expected: { &quot;wtulsa-fw01&quot;: { count: 2, status: &quot;Open&quot;, tickets: [...] }, ... }</span></code></pre><p><strong>Expected Behavior</strong>:</p>
<ul>
<li>Location card click ‚Üí Modal opens instantly</li>
<li>Grid populates ‚Üí Ticket counts load after ~200-500ms (batch API call)</li>
<li>&quot;Create&quot; button ‚Üí Navigates to /tickets.html with device pre-filled</li>
<li>&quot;View Tickets&quot; ‚Üí Shows picker if 2+, navigates directly if 1</li>
<li>No console errors during modal lifecycle</li>
</ul>

    <!-- Note: This file is intentionally minimal. The full page scaffold, header, footer, and scripts
             are provided by docs-html/index.html. Content generated using this template will be
             fetched and injected into #content-container by docs-html/js/docs-portal-v2.js. -->
</section>
