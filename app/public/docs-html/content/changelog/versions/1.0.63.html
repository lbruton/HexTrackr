<!-- Fragment template for documentation content injected by docs-tabler.js -->
<section class="doc-fragment">
    <hr>
<h2>title: "Version 1.0.63 - Cisco PSIRT Advisory Sync (Phase 0: UI Foundation)"
date: "2025-10-11"
version: "1.0.63"
status: "In Development"
category: "Feature - Multi-Vendor Advisory Integration"</h2><h1>Version 1.0.63 - Cisco PSIRT Advisory Sync</h1><p><strong>Release Status</strong>: üöß In Development<br><strong>Target Release</strong>: TBD<br><strong>Linear Issue</strong>: <a href="https://linear.app/hextrackr/issue/HEX-141">HEX-141</a><br><strong>Architecture Pattern</strong>: KEV Auto-Sync Replication</p>
<hr>
<h2>Overview</h2><p>Building multi-vendor fixed software version tracking system, starting with Cisco PSIRT API integration. This release implements a comprehensive backend sync pattern (mirroring KEV) that will eventually support Palo Alto, Fortinet, and other vendors without schema redesigns.</p>
<p><strong>Design Philosophy</strong>: Modal-in-modal credential management, backend sync with database caching, vendor-neutral + vendor-specific column strategy.</p>
<hr>
<h2>Phase 0: Settings Modal UX Rebuild ‚úÖ COMPLETE (2025-10-11)</h2><h3>üé® Cisco PSIRT Card Redesign</h3><p><strong>Problem</strong>: Original implementation had broken UX - credentials shown inline, no save button, relied on global Save Settings button, inconsistent with KEV pattern.</p>
<p><strong>Solution</strong>: Complete card rebuild matching KEV pattern exactly.</p>
<h4>Features Added</h4><ol>
<li><p><strong>Credential Management Modal</strong> (Modal-in-Modal Pattern)</p>
<ul>
<li>Dedicated &quot;Manage Credentials&quot; button opens focused modal</li>
<li>Smart secret preservation: leave blank to keep existing secret</li>
<li>Only shows credentials during deliberate management action (better security)</li>
<li>Auto-closes on successful save</li>
<li>Updates main card status immediately</li>
</ul>
</li>
<li><p><strong>Status Display</strong></p>
<ul>
<li>Credential Status Badge: &quot;Configured ‚úì&quot; / &quot;Not Configured&quot;</li>
<li>Last Sync timestamp display</li>
<li>Statistics: &quot;X CVEs synced ‚Ä¢ Y matched in your environment&quot;</li>
<li>Real-time status badge: &quot;Synced&quot; / &quot;Syncing&quot; / &quot;Not Synced&quot;</li>
</ul>
</li>
<li><p><strong>User Controls</strong></p>
<ul>
<li>Auto-sync toggle (localStorage: <code>ciscoAutoSyncEnabled</code>, default: enabled)</li>
<li>Sync Now button (disabled until credentials configured)</li>
<li>Button state management prevents accidental clicks</li>
</ul>
</li>
<li><p><strong>Smart UX Logic</strong></p>
<ul>
<li>Sync button enables only after credentials saved</li>
<li>Clear visual feedback during save operation</li>
<li>Spinner animation during sync attempts</li>
<li>Toast notifications for all user actions</li>
</ul>
</li>
</ol>
<h4>Files Modified</h4><p><strong><code>app/public/scripts/shared/settings-modal.html</code></strong></p>
<ul>
<li>Lines 46-92: Replaced broken Cisco PSIRT card with KEV-style layout</li>
<li>Lines 452-493: Added Cisco Credentials Management Modal</li>
</ul>
<p><strong><code>app/public/scripts/shared/settings-modal.js</code></strong></p>
<ul>
<li>Lines 142-157: Updated event listeners for new Cisco functions</li>
<li>Lines 591-857: Implemented 5 new Cisco functions:<ul>
<li><code>openCiscoCredentialsModal()</code> - Loads existing creds, opens modal</li>
<li><code>saveCiscoCredentials()</code> - Validates, saves to DB, updates UI</li>
<li><code>loadCiscoSyncStatus()</code> - Loads status on Settings modal open</li>
<li><code>syncCiscoNow()</code> - Manual sync trigger (stub for Phase 2)</li>
<li><code>toggleCiscoAutoSync()</code> - Persists toggle state to localStorage</li>
</ul>
</li>
<li>Lines 1014-1015: Removed old broken credential handling from <code>saveSettings()</code></li>
<li>Lines 1535-1540: Updated module exports with new Cisco functions</li>
</ul>
<h4>Technical Improvements</h4><ol>
<li><p><strong>Security Enhancement</strong></p>
<ul>
<li>Credentials never visible in main Settings modal</li>
<li>Modal-in-modal creates focused security context</li>
<li>No localStorage storage of credentials (database only)</li>
<li>Client Secret always masked when loading existing credentials</li>
</ul>
</li>
<li><p><strong>UX Consistency</strong></p>
<ul>
<li>Exact visual parity with KEV card (users already understand pattern)</li>
<li>Same button layout, same status badges, same toggle pattern</li>
<li>Predictable interaction model reduces cognitive load</li>
</ul>
</li>
<li><p><strong>Error Handling</strong></p>
<ul>
<li>Validation before save (requires both Client ID and Secret)</li>
<li>Graceful handling when PreferencesService unavailable</li>
<li>User-friendly error messages via toast notifications</li>
</ul>
</li>
</ol>
<h4>Testing Completed</h4><ul>
<li><input checked="" disabled="" type="checkbox"> Settings modal opens, Cisco card matches KEV layout</li>
<li><input checked="" disabled="" type="checkbox"> &quot;Manage Credentials&quot; button opens modal</li>
<li><input checked="" disabled="" type="checkbox"> Enter Client ID and Secret, click Save</li>
<li><input checked="" disabled="" type="checkbox"> Credential Status badge changes to &quot;Configured ‚úì&quot;</li>
<li><input checked="" disabled="" type="checkbox"> &quot;Sync Now&quot; button enables after credential save</li>
<li><input checked="" disabled="" type="checkbox"> Click Sync Now shows &quot;backend not implemented&quot; toast (expected Phase 0 behavior)</li>
<li><input checked="" disabled="" type="checkbox"> Credentials stored in database (verified via <code>preferencesSync</code>)</li>
</ul>
<hr>
<h2>Phase 1: Database Migration ‚úÖ COMPLETE (2025-10-11)</h2><h3>Database Schema Changes</h3><p><strong>File</strong>: <code>app/public/scripts/migrations/005-cisco-advisories.sql</code></p>
<h4>Tables Created</h4><ol>
<li><p><strong><code>cisco_advisories</code></strong> (Rich Metadata Storage)</p>
<ul>
<li><code>cve_id</code> TEXT PRIMARY KEY - CVE identifier</li>
<li><code>advisory_id</code> TEXT - Cisco advisory ID (e.g., &quot;cisco-sa-20241001-xyz&quot;)</li>
<li><code>advisory_title</code> TEXT - Human-readable advisory title</li>
<li><code>severity</code> TEXT - Cisco severity rating</li>
<li><code>cvss_score</code> TEXT - CVSS score from Cisco advisory</li>
<li><code>first_fixed</code> TEXT - JSON array: [&quot;15.2(4)M11&quot;, &quot;16.3.1&quot;]</li>
<li><code>affected_releases</code> TEXT - JSON array of affected versions</li>
<li><code>product_names</code> TEXT - JSON array of affected Cisco products</li>
<li><code>publication_url</code> TEXT - Direct link to Cisco advisory page</li>
<li><code>last_synced</code> TIMESTAMP - Last sync time</li>
</ul>
</li>
<li><p><strong><code>vulnerabilities</code> Table Extensions</strong> (Denormalized Display Columns)</p>
<ul>
<li><code>is_fixed</code> INTEGER DEFAULT 0 - Vendor-neutral boolean (ANY vendor has fix)</li>
<li><code>fixed_cisco_versions</code> TEXT - Display string: &quot;15.2(4)M11, 16.3.1&quot;</li>
<li><code>fixed_cisco_url</code> TEXT - Link to Cisco advisory</li>
<li><code>cisco_synced_at</code> DATETIME - Last time Cisco data synced for this CVE</li>
</ul>
</li>
</ol>
<h4>Indexes Created</h4><ul>
<li><code>idx_cisco_advisories_cve</code> on <code>cisco_advisories(cve_id)</code></li>
<li><code>idx_cisco_advisories_synced</code> on <code>cisco_advisories(last_synced)</code></li>
<li><code>idx_vulnerabilities_is_fixed</code> on <code>vulnerabilities(is_fixed) WHERE is_fixed = 1</code></li>
</ul>
<h4>Migration Verification</h4><p>‚úÖ Verified on dev database:</p>
<pre><code class="language-bash"><span class="hljs-comment"># Table created</span>
sqlite3 app/data/hextrackr.db \
  <span class="hljs-string">&quot;SELECT name FROM sqlite_master WHERE type=&#x27;table&#x27; AND name=&#x27;cisco_advisories&#x27;;&quot;</span>
<span class="hljs-comment"># Output: cisco_advisories</span>

<span class="hljs-comment"># Columns added to vulnerabilities table</span>
PRAGMA table_info(vulnerabilities);
<span class="hljs-comment"># Output:</span>
<span class="hljs-comment">#   20|is_fixed|INTEGER|0|0|0</span>
<span class="hljs-comment">#   21|fixed_cisco_versions|TEXT|0||0</span>
<span class="hljs-comment">#   22|fixed_cisco_url|TEXT|0||0</span>
<span class="hljs-comment">#   23|cisco_synced_at|DATETIME|0||0</span>

<span class="hljs-comment"># Indexes created</span>
SELECT name FROM sqlite_master WHERE <span class="hljs-built_in">type</span>=<span class="hljs-string">&#x27;index&#x27;</span>
  AND (name LIKE <span class="hljs-string">&#x27;idx_cisco%&#x27;</span> OR name LIKE <span class="hljs-string">&#x27;%is_fixed%&#x27;</span>);
<span class="hljs-comment"># Output:</span>
<span class="hljs-comment">#   idx_cisco_advisories_cve</span>
<span class="hljs-comment">#   idx_cisco_advisories_synced</span>
<span class="hljs-comment">#   idx_vulnerabilities_is_fixed</span></code></pre><h4>Architecture Notes</h4><p><strong>Pattern</strong>: Mirrors KEV implementation exactly</p>
<ul>
<li>Separate advisory table for rich vendor metadata</li>
<li>Denormalized display columns for fast queries</li>
<li>Vendor-neutral + vendor-specific column strategy</li>
<li>Future-proof for additional vendors (Palo Alto, Fortinet)</li>
</ul>
<p><strong>Why Separate Table?</strong></p>
<ul>
<li>Cisco advisory data has many fields not relevant to all vulnerabilities</li>
<li>LEFT JOIN pattern keeps vulnerabilities table lean</li>
<li>Can store full JSON responses for future parsing</li>
<li>Easier to purge/refresh vendor data independently</li>
</ul>
<p><strong>Why Denormalized Columns?</strong></p>
<ul>
<li>No JOIN required for vulnerability list views (performance)</li>
<li>Can index on <code>is_fixed</code> for fast filtering</li>
<li>Simple API responses (all data in one row)</li>
</ul>
<hr>
<h2>Phase 2: Backend Service ‚úÖ COMPLETE (2025-10-11)</h2><h3>üîß Architecture Overview</h3><p><strong>MAJOR UPDATE (2025-10-11 Evening)</strong>: Implemented complete two-stage API integration with rate limiting, per-CVE resilience, 90-day TTL, and background worker architecture.</p>
<p><strong>Pattern</strong>: Two-stage vendor API integration with sequential processing, auto-commits, and scheduled background sync</p>
<p><strong>Core Components</strong>:</p>
<ol>
<li><strong>Two-Stage API Pattern</strong> - CVE endpoint ‚Üí parse OS context ‚Üí Software Checker endpoint</li>
<li><strong>Rate Limiting</strong> - Sequential processing with 3-second delays (prevents 429 errors)</li>
<li><strong>Resilience</strong> - Per-CVE auto-commits (survives container restarts)</li>
<li><strong>TTL Cache</strong> - 90-day automatic refresh of stale advisory data</li>
<li><strong>Background Worker</strong> - Startup trigger + 24-hour recurring schedule</li>
<li><strong>User Control</strong> - Database-backed toggle for background sync (defaults enabled)</li>
<li><strong>Nginx Timeout</strong> - 10-minute extended timeout for long-running syncs</li>
</ol>
<h3>Files Created</h3><h4>1. **`app/services/ciscoAdvisoryService.js`** (550 lines)</h4><p><strong>OAuth2 Token Management</strong>:</p>
<ul>
<li><code>getCiscoAccessToken(clientId, clientSecret)</code> - Fetches bearer token from Cisco Identity Services</li>
<li>Uses Basic authentication with Base64-encoded credentials</li>
<li>Token endpoint: <code>https://id.cisco.com/oauth2/default/v1/token</code></li>
<li>Grant type: <code>client_credentials</code></li>
</ul>
<p><strong>Credential Fetch</strong>:</p>
<ul>
<li><code>getCiscoCredentials()</code> - Retrieves API credentials from preferences database</li>
<li>Format: <code>clientId:clientSecret</code> stored in <code>user_preferences.cisco_api_key</code></li>
<li>Throws user-friendly error if credentials not configured</li>
</ul>
<p><strong>Advisory Sync Logic</strong>:</p>
<ul>
<li><code>syncCiscoAdvisories()</code> - Main sync orchestration method</li>
<li>Fetches all unique CVE IDs from vulnerabilities table</li>
<li>Batch processing: 10 CVEs per batch with 1-second rate limiting delay</li>
<li>Transaction-safe: BEGIN ‚Üí process ‚Üí COMMIT (or ROLLBACK on error)</li>
<li>Progress logging every 50 CVEs</li>
</ul>
<p><strong>Advisory Parsing</strong>:</p>
<ul>
<li><code>parseAdvisoryData(advisoryData)</code> - Extracts relevant fields from Cisco API response</li>
<li>Handles nested <code>productNames</code> array to extract <code>firstFixed</code> versions</li>
<li>Stores as JSON arrays for flexibility: <code>[&quot;15.2(4)M11&quot;, &quot;16.3.1&quot;, &quot;17.1.1&quot;]</code></li>
<li>Maps Cisco SIR (Security Impact Rating) to severity field</li>
</ul>
<p><strong>Database Operations</strong>:</p>
<ul>
<li><code>INSERT OR REPLACE INTO cisco_advisories</code> - Upsert advisory metadata</li>
<li><code>UPDATE vulnerabilities SET is_fixed=1, fixed_cisco_versions, fixed_cisco_url</code> - Denormalized display columns</li>
<li>Creates display string: <code>&quot;15.2(4)M11, 16.3.1, 17.1.1&quot;</code> (comma-separated)</li>
</ul>
<p><strong>Status and Metadata</strong>:</p>
<ul>
<li><code>getSyncStatus()</code> - Returns sync statistics (totalAdvisories, matchedCount, lastSync)</li>
<li><code>getMatchedVulnerabilitiesCount()</code> - Counts CVEs with Cisco advisories in active vulnerabilities</li>
<li><code>updateSyncMetadata(recordCount)</code> - Logs sync history to <code>sync_metadata</code> table</li>
<li><code>isAutoSyncNeeded(hoursThreshold)</code> - Checks if 24+ hours since last sync</li>
</ul>
<p><strong>Fallback HTTPS Client</strong>:</p>
<ul>
<li><code>_initHttpsClient()</code> - Custom HTTPS wrapper for environments without <code>global.fetch</code></li>
<li>Supports POST with headers and body</li>
<li>Returns fetch-compatible response object</li>
</ul>
<h4>2. **`app/controllers/ciscoController.js`** (155 lines)</h4><p><strong>Controller Pattern</strong>:</p>
<ul>
<li>Constructor receives <code>db</code> and <code>preferencesService</code> dependencies</li>
<li>Instantiates <code>CiscoAdvisoryService</code> with both dependencies</li>
<li>All methods are async HTTP request handlers</li>
</ul>
<p><strong>Endpoint Handlers</strong>:</p>
<p><strong><code>syncCiscoAdvisories(req, res)</code></strong> - POST /api/cisco/sync</p>
<ul>
<li>Checks if sync already in progress (returns 409 Conflict)</li>
<li>Calls <code>ciscoAdvisoryService.syncCiscoAdvisories()</code></li>
<li>Clears all caches after successful sync (<code>cacheService.clearAll()</code>)</li>
<li>Returns JSON: <code>{success, message, totalAdvisories, matchedCount, totalCvesChecked, lastSync}</code></li>
</ul>
<p><strong><code>getCiscoStatus(req, res)</code></strong> - GET /api/cisco/status</p>
<ul>
<li>Calls <code>ciscoAdvisoryService.getSyncStatus()</code></li>
<li>Returns JSON: <code>{totalAdvisories, matchedCount, lastSync, recordCount, syncInProgress}</code></li>
</ul>
<p><strong><code>getCiscoAdvisoryByCve(req, res)</code></strong> - GET /api/cisco/advisory/:cveId</p>
<ul>
<li>Validates CVE ID presence (400 if missing)</li>
<li>Calls <code>ciscoAdvisoryService.getCiscoAdvisory(cveId)</code></li>
<li>Returns 404 if CVE not found in Cisco advisories</li>
<li>Returns advisory JSON object if found</li>
</ul>
<p><strong><code>checkAutoSync(req, res)</code></strong> - GET /api/cisco/check-autosync?hours=24</p>
<ul>
<li>Accepts <code>hours</code> query parameter (default: 24)</li>
<li>Calls <code>ciscoAdvisoryService.isAutoSyncNeeded(hoursThreshold)</code></li>
<li>Returns JSON: <code>{autoSyncNeeded, hoursThreshold}</code></li>
</ul>
<p><strong>Error Handling</strong>:</p>
<ul>
<li>All methods use try/catch with consistent error response format</li>
<li>Logs errors with ‚ùå emoji for visibility</li>
<li>Returns JSON: <code>{error, message}</code> with appropriate HTTP status codes</li>
</ul>
<h4>3. **`app/routes/cisco.js`** (77 lines)</h4><p><strong>Router Factory Pattern</strong>:</p>
<ul>
<li><code>createCiscoRouter(db, preferencesService)</code> - Returns configured Express router</li>
<li>Instantiates <code>CiscoController</code> with dependencies</li>
<li>Applies authentication and rate limiting middleware</li>
</ul>
<p><strong>Rate Limiting</strong>:</p>
<ul>
<li>Window: 10 minutes (vs KEV&#39;s 5 minutes)</li>
<li>Max requests: 2 per window (vs KEV&#39;s 3)</li>
<li>Rationale: Cisco API processes 1000s of individual CVE requests vs KEV&#39;s single catalog fetch</li>
<li>Custom error message: &quot;Please wait before requesting another Cisco advisory sync&quot;</li>
</ul>
<p><strong>Route Definitions</strong>:</p>
<pre><code class="language-javascript"><span class="hljs-variable constant_">POST</span>   /api/cisco/sync                   <span class="hljs-comment">// Manual sync trigger (auth + rate limit)</span>
<span class="hljs-variable constant_">GET</span>    /api/cisco/status                 <span class="hljs-comment">// Sync status (auth only)</span>
<span class="hljs-variable constant_">GET</span>    /api/cisco/check-autosync?hours   <span class="hljs-comment">// Auto-sync check (auth only)</span>
<span class="hljs-variable constant_">GET</span>    /api/cisco/advisory/:cveId        <span class="hljs-comment">// Individual advisory lookup (auth only)</span></code></pre><p><strong>Middleware Applied</strong>:</p>
<ul>
<li><code>requireAuth</code> - All routes require authentication (session-based)</li>
<li><code>syncLimiter</code> - Only POST /sync endpoint (prevents abuse)</li>
</ul>
<h3>Files Modified</h3><h4>4. **`app/public/server.js`**</h4><p><strong>Line 61</strong> - Added route module import:</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> ciscoRoutes = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;../routes/cisco&quot;</span>); <span class="hljs-comment">// HEX-141: Cisco PSIRT advisory sync</span></code></pre><p><strong>Line 269</strong> - Registered Cisco routes:</p>
<pre><code class="language-javascript">app.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;/api/cisco&quot;</span>, <span class="hljs-title function_">ciscoRoutes</span>(db, <span class="hljs-title class_">PreferencesController</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-property">preferencesService</span>));</code></pre><p><strong>Architecture Note</strong>:</p>
<ul>
<li>Passes <code>PreferencesController.getInstance().preferencesService</code> to access credentials</li>
<li>Singleton pattern ensures same service instance used throughout application</li>
<li>PreferencesController initialized on line 173 with database connection</li>
</ul>
<h4>5. **`app/public/scripts/shared/settings-modal.js`**</h4><p><strong>Lines 811-849</strong> - Updated <code>syncCiscoNow()</code> function:</p>
<ul>
<li>Replaced TODO stub with real API call: <code>POST /api/cisco/sync</code></li>
<li>Updates UI elements on success:<ul>
<li>Status badge: &quot;Syncing&quot; ‚Üí &quot;Synced&quot; (bg-warning ‚Üí bg-success)</li>
<li>Synced count: <code>result.totalAdvisories</code></li>
<li>Matched count: <code>result.matchedCount</code></li>
<li>Last sync time: Formatted <code>Date.toLocaleString()</code></li>
</ul>
</li>
<li>Shows user-friendly toast: &quot;Cisco advisory sync completed: X advisories, Y matched in your environment&quot;</li>
<li>Error handling with status badge &quot;Sync Failed&quot; (bg-danger)</li>
</ul>
<p><strong>Lines 768-809</strong> - Updated <code>loadCiscoSyncStatus()</code> function:</p>
<ul>
<li>Added API call: <code>GET /api/cisco/status</code></li>
<li>Populates sync statistics on Settings modal open</li>
<li>Sets status badge based on state:<ul>
<li><code>syncInProgress</code> ‚Üí &quot;Syncing&quot; (bg-warning)</li>
<li><code>lastSync</code> exists ‚Üí &quot;Synced&quot; (bg-success)</li>
<li>No sync ‚Üí &quot;Not Synced&quot; (bg-secondary)</li>
</ul>
</li>
</ul>
<h3>Technical Implementation Details</h3><p><strong>OAuth2 Flow</strong>:</p>
<ol>
<li>User configures credentials via Settings ‚Üí Manage Credentials modal</li>
<li>Credentials stored in <code>user_preferences</code> table as <code>cisco_api_key</code></li>
<li>On sync, service fetches credentials from database</li>
<li>Service requests OAuth2 token from Cisco Identity Services</li>
<li>Token used for all PSIRT API requests in sync batch</li>
<li>Token discarded after sync completes (not cached - security)</li>
</ol>
<p><strong>Sync Algorithm</strong>:</p>
<pre><code class="language-">1. BEGIN TRANSACTION
2. Fetch all unique CVE IDs from vulnerabilities table
3. Get OAuth2 access token
4. FOR each CVE in batches of 10:
   a. Fetch advisory from Cisco PSIRT API
   b. Parse response and extract metadata
   c. INSERT OR REPLACE into cisco_advisories table
   d. UPDATE vulnerabilities table with denormalized columns
   e. Sleep 1 second (rate limiting)
5. COMMIT TRANSACTION
6. Update sync_metadata table
7. Return statistics</code></pre><p><strong>Error Recovery</strong>:</p>
<ul>
<li>Individual CVE fetch failures logged but don&#39;t abort sync</li>
<li>Database errors trigger ROLLBACK and abort entire sync</li>
<li>OAuth2 failures throw immediately (no point continuing)</li>
</ul>
<p><strong>Performance Optimizations</strong>:</p>
<ul>
<li>Batch processing reduces serial overhead</li>
<li>Rate limiting prevents API throttling</li>
<li>Denormalized columns eliminate JOINs in vulnerability list views</li>
<li>Transaction grouping reduces fsync overhead</li>
</ul>
<h3>API Endpoints Added</h3><pre><code class="language-">POST   /api/cisco/sync
  Description: Trigger manual Cisco PSIRT advisory sync
  Auth: Required (session)
  Rate Limit: 2 requests per 10 minutes
  Response: {success, message, totalAdvisories, matchedCount, totalCvesChecked, lastSync}

GET    /api/cisco/status
  Description: Get current sync status and statistics
  Auth: Required (session)
  Response: {totalAdvisories, matchedCount, lastSync, recordCount, syncInProgress}

GET    /api/cisco/check-autosync?hours=24
  Description: Check if auto-sync is needed
  Auth: Required (session)
  Query Params: hours (number, default: 24)
  Response: {autoSyncNeeded, hoursThreshold}

GET    /api/cisco/advisory/:cveId
  Description: Get Cisco advisory metadata for specific CVE
  Auth: Required (session)
  Path Params: cveId (string, e.g., &quot;CVE-2024-1234&quot;)
  Response: Advisory object or 404</code></pre><h3>Testing Verification</h3><p><strong>Manual Testing Steps</strong>:</p>
<ol>
<li>‚úÖ Docker containers restarted to load backend changes</li>
<li>‚è≥ Navigate to Settings ‚Üí API Configuration ‚Üí Cisco PSIRT card</li>
<li>‚è≥ Verify credentials are saved (from Phase 0)</li>
<li>‚è≥ Click &quot;Sync Now&quot; button</li>
<li>‚è≥ Verify sync completes and shows statistics</li>
<li>‚è≥ Check database tables for advisory data</li>
</ol>
<p><strong>Expected Behavior</strong>:</p>
<ul>
<li>Sync button shows spinner during processing</li>
<li>Toast notification on completion with count</li>
<li>Status badge updates to &quot;Synced&quot; (green)</li>
<li>Statistics update with real counts</li>
<li>Last sync timestamp displays</li>
</ul>
<h3>Known Limitations</h3><p><strong>Phase 2 Scope</strong>:</p>
<ul>
<li>‚úÖ Manual sync only (no auto-sync scheduling yet)</li>
<li>‚úÖ No UI display of fixed versions in vulnerability details (Phase 4)</li>
<li>‚úÖ No auto-sync integration in vulnerability-core.js (Phase 3)</li>
</ul>
<p><strong>API Constraints</strong>:</p>
<ul>
<li>Cisco PSIRT API rate limits not fully documented - conservative 10 CVEs/second assumed</li>
<li>OAuth2 token expiration handling not implemented (tokens valid for hours, sync completes in minutes)</li>
<li>No retry logic for failed individual CVE fetches (logged and skipped)</li>
</ul>
<hr>
<h2>Phase 3: Frontend Auto-Sync Integration (Planned)</h2><h3>Files to Modify</h3><p><strong><code>app/public/scripts/shared/vulnerability-core.js</code></strong></p>
<ul>
<li>Add <code>checkCiscoAutoSync()</code> method (mirror <code>checkKevAutoSync()</code>)</li>
<li>Call on page load after KEV auto-sync check</li>
<li>Fire-and-forget background sync pattern</li>
</ul>
<hr>
<h2>Phase 4: UI Display (Planned)</h2><h3>Files to Modify</h3><p><strong><code>app/public/scripts/shared/vulnerability-details-modal.js</code></strong></p>
<ul>
<li>Update Solution field with vendor priority cascade</li>
<li>Display logic: Cisco ‚Üí Palo Alto ‚Üí Fortinet ‚Üí Manual</li>
<li>Add &quot;View Advisory&quot; link to Cisco advisory URL</li>
</ul>
<hr>
<h2>Multi-Vendor Extensibility Design</h2><h3>Vendor-Neutral + Vendor-Specific Pattern</h3><p><strong>Core Principle</strong>: <code>is_fixed</code> boolean indicates ANY vendor has a fix, vendor-specific columns store actual version data.</p>
<p><strong>Future Vendor Addition</strong> (no schema redesign):</p>
<ol>
<li>Create new advisory table (<code>palo_advisories</code>, <code>fortinet_advisories</code>)</li>
<li>Add vendor columns to vulnerabilities (<code>fixed_palo_versions</code>, etc.)</li>
<li>Create service class (mirror <code>ciscoAdvisoryService.js</code>)</li>
<li>Add to auto-sync check</li>
</ol>
<p><strong>Display Priority Cascade</strong>: Cisco ‚Üí Palo Alto ‚Üí Fortinet ‚Üí Manual solution</p>
<hr>
<h2>Dependencies</h2><ul>
<li><strong>HEX-138</strong>: Cisco PSIRT API OAuth2 Integration ‚úÖ COMPLETED<ul>
<li>Credentials already stored in <code>user_preferences.cisco_api_key</code></li>
<li>OAuth2 flow proven working in <code>vulnerability-search.js</code></li>
</ul>
</li>
</ul>
<hr>
<h2>Related Linear Issues</h2><ul>
<li><strong>HEX-117</strong>: Initial KEV integration (pattern reference)</li>
<li><strong>Future</strong>: Automated scheduling with node-cron (Phase 6)</li>
<li><strong>Future</strong>: Palo Alto advisory integration</li>
<li><strong>Future</strong>: Fortinet advisory integration</li>
</ul>
<hr>
<h2>Breaking Changes</h2><h3>Settings Modal Structure</h3><p><strong>Changed</strong>: Cisco PSIRT card no longer has inline credential input fields.</p>
<p><strong>Migration</strong>: Users with existing credentials will see them preserved in database. New modal-based credential management requires clicking &quot;Manage Credentials&quot; button to view/edit.</p>
<p><strong>Impact</strong>: Low - credential data persists, only UX interaction pattern changed.</p>
<hr>
<h2>Known Issues</h2><p>None. Phase 0 is fully functional and tested.</p>
<hr>
<h2>Upgrade Notes</h2><ol>
<li><p><strong>Docker Restart Required</strong>: Frontend changes require container restart</p>
<pre><code class="language-bash">docker-compose restart</code></pre></li>
<li><p><strong>No Database Migration Yet</strong>: Phase 0 is UI-only, no schema changes</p>
</li>
<li><p><strong>Sync Button Shows Expected Message</strong>: &quot;Sync Now&quot; button will show &quot;backend not yet implemented&quot; until Phase 2 completes (this is expected behavior)</p>
</li>
</ol>
<hr>
<h2>Developer Notes</h2><h3>Architecture Decisions</h3><p><strong>Why Modal-in-Modal Pattern?</strong></p>
<ul>
<li>Credentials only visible during deliberate management action</li>
<li>Reduces accidental exposure risk</li>
<li>Creates focused security context</li>
<li>Cleaner main Settings interface</li>
</ul>
<p><strong>Why Mirror KEV Pattern Exactly?</strong></p>
<ul>
<li>Users already understand KEV interaction model</li>
<li>Reduces development time (proven pattern)</li>
<li>Consistent UX across similar features</li>
<li>Easier maintenance (one pattern to understand)</li>
</ul>
<p><strong>Why Backend Sync vs Frontend API Calls?</strong></p>
<ol>
<li><strong>Security</strong>: OAuth2 tokens stay server-side</li>
<li><strong>Performance</strong>: Single sync updates all CVEs</li>
<li><strong>Consistency</strong>: All users see same data</li>
<li><strong>Rate Limiting</strong>: Avoids per-user Cisco API calls</li>
</ol>
<h3>Testing Strategy</h3><p><strong>Phase 0 Focus</strong>: UI/UX validation only</p>
<ul>
<li>Credential save/load flow</li>
<li>Button state management</li>
<li>Modal open/close behavior</li>
<li>Toast notification display</li>
</ul>
<p><strong>Future Phase Focus</strong>: Backend integration, data accuracy, performance</p>
<hr>
<h2>Timeline</h2><ul>
<li><strong>2025-10-11</strong>: Phase 0 Complete (Settings Modal UX)</li>
<li><strong>TBD</strong>: Phase 1 (Database Migration)</li>
<li><strong>TBD</strong>: Phase 2 (Backend Service)</li>
<li><strong>TBD</strong>: Phase 3 (Auto-Sync Integration)</li>
<li><strong>TBD</strong>: Phase 4 (UI Display)</li>
<li><strong>TBD</strong>: Phase 5 (Polish &amp; Documentation)</li>
</ul>
<hr>
<h2>Phase 2 Architecture Deep Dive (Added 2025-10-11 Evening)</h2><h3>Two-Stage API Integration Pattern</h3><p><strong>Problem</strong>: Cisco&#39;s CVE endpoint doesn&#39;t include fixed versions directly. The Software Checker endpoint requires OS type + version as input parameters.</p>
<p><strong>Solution</strong>: Two-stage lookup pattern</p>
<ol>
<li><p><strong>Stage 1: CVE Endpoint</strong> ‚Üí Parse OS Context</p>
<pre><code class="language-">GET https://sec.cloudapps.cisco.com/security/center/publicationService/v2/security/advisories/cve/{cveId}
Returns: Advisory data with productNames array
Parse: &quot;Cisco IOS 12.2(20)S6a&quot; ‚Üí os_type=&quot;ios&quot;, version=&quot;12.2(20)S6a&quot;</code></pre></li>
<li><p><strong>Stage 2: Software Checker</strong> ‚Üí Fetch Fixed Versions</p>
<pre><code class="language-">GET https://sec.cloudapps.cisco.com/security/center/publicationService/v2/security/advisories/OSType/{osType}?version={version}
Returns: Array of fixed software versions [&quot;12.2(22)S1&quot;, &quot;12.2(30)S&quot;, ...]</code></pre></li>
</ol>
<h3>Rate Limiting Strategy</h3><p><strong>Sequential Processing</strong> with Fixed Delays:</p>
<ul>
<li>Processes CVEs one at a time (no parallel batching)</li>
<li>3-second delay between each CVE</li>
<li>Each CVE requires 2 API calls (6 seconds total per CVE)</li>
<li>126 CVEs √ó 3s = ~6 minutes total sync time</li>
</ul>
<p><strong>Why Not Parallel?</strong>:</p>
<ul>
<li>Parallel batch processing (Promise.all) triggered 429 errors after ~19 CVEs</li>
<li>Two-stage pattern amplifies API call volume (2x)</li>
<li>Conservative delay ensures reliability over speed</li>
</ul>
<h3>Resilience Pattern: Per-CVE Auto-Commits</h3><p><strong>No Batch Transactions</strong>:</p>
<pre><code class="language-javascript"><span class="hljs-comment">// ‚ùå OLD: Single transaction for all CVEs (lost progress on restart)</span>
<span class="hljs-variable constant_">BEGIN</span> <span class="hljs-variable constant_">TRANSACTION</span>;
<span class="hljs-comment">// ... process 126 CVEs ...</span>
<span class="hljs-variable constant_">COMMIT</span>;

<span class="hljs-comment">// ‚úÖ NEW: Each INSERT/UPDATE auto-commits immediately</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> cveId <span class="hljs-keyword">of</span> cveIds) {
    db.<span class="hljs-title function_">prepare</span>(<span class="hljs-string">&quot;INSERT OR REPLACE INTO cisco_advisories ...&quot;</span>).<span class="hljs-title function_">run</span>();
    <span class="hljs-comment">// Auto-commits here - progress persists</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">delay</span>(<span class="hljs-number">3000</span>); <span class="hljs-comment">// Rate limiting</span>
}</code></pre><p><strong>Benefits</strong>:</p>
<ul>
<li>Container restarts don&#39;t lose progress</li>
<li>Network failures only affect current CVE</li>
<li>Database always reflects latest successful sync</li>
</ul>
<h3>90-Day TTL (Time-To-Live)</h3><p><strong>Automatic Stale Data Refresh</strong>:</p>
<pre><code class="language-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> vc.cve
<span class="hljs-keyword">FROM</span> vulnerabilities_current vc
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> cisco_advisories ca <span class="hljs-keyword">ON</span> vc.cve <span class="hljs-operator">=</span> ca.cve_id
<span class="hljs-keyword">WHERE</span> vc.cve <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT NULL</span>
  <span class="hljs-keyword">AND</span> vc.lifecycle_state <span class="hljs-keyword">IN</span> (<span class="hljs-string">&#x27;active&#x27;</span>, <span class="hljs-string">&#x27;reopened&#x27;</span>)
  <span class="hljs-keyword">AND</span> (
      ca.cve_id <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>  <span class="hljs-comment">-- Never synced</span>
      <span class="hljs-keyword">OR</span> julianday(<span class="hljs-string">&#x27;now&#x27;</span>) <span class="hljs-operator">-</span> julianday(ca.last_synced) <span class="hljs-operator">&gt;</span> <span class="hljs-number">90</span>  <span class="hljs-comment">-- Stale</span>
  )</code></pre><p><strong>Why 90 Days</strong>: Balances freshness with API usage, advisories can be updated</p>
<h3>Background Worker Architecture</h3><p><strong>Startup + 24-Hour Schedule</strong>:</p>
<pre><code class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">startCiscoBackgroundSync</span>(<span class="hljs-params">db</span>) {
    <span class="hljs-comment">// Run on startup (10s delay for initialization)</span>
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">runSync</span>(), <span class="hljs-number">10000</span>);

    <span class="hljs-comment">// Repeat every 24 hours</span>
    <span class="hljs-built_in">setInterval</span>(runSync, <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>);
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">runSync</span>(<span class="hljs-params"></span>) {
    <span class="hljs-comment">// Check if background sync enabled (default: true)</span>
    <span class="hljs-keyword">const</span> pref = <span class="hljs-keyword">await</span> preferencesService.<span class="hljs-title function_">getPreference</span>(
        <span class="hljs-variable constant_">ADMIN_USER_ID</span>,
        <span class="hljs-string">&quot;cisco_background_sync_enabled&quot;</span>
    );
    <span class="hljs-keyword">if</span> (!isEnabled) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// Graceful skip</span>

    <span class="hljs-comment">// Check credentials exist</span>
    <span class="hljs-keyword">const</span> { clientId } = <span class="hljs-keyword">await</span> ciscoService.<span class="hljs-title function_">getCiscoCredentials</span>(<span class="hljs-variable constant_">ADMIN_USER_ID</span>);
    <span class="hljs-keyword">if</span> (!clientId) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// Graceful skip</span>

    <span class="hljs-comment">// Run sync</span>
    <span class="hljs-keyword">await</span> ciscoService.<span class="hljs-title function_">syncCiscoAdvisories</span>(<span class="hljs-variable constant_">ADMIN_USER_ID</span>);
}</code></pre><p><strong>User Control</strong>:</p>
<ul>
<li>UI toggle: &quot;Enable background sync&quot; (defaults to enabled)</li>
<li>Preference: <code>cisco_background_sync_enabled</code> (database-stored)</li>
<li>Worker checks preference before each sync</li>
<li>Graceful skip if disabled (no errors logged)</li>
</ul>
<p><strong>Why Database-Stored Toggle</strong>:</p>
<ul>
<li>Server-side worker can&#39;t access browser localStorage</li>
<li>Setting survives container restarts</li>
<li>Multi-instance support (if scaled horizontally later)</li>
</ul>
<h3>Nginx Timeout Configuration</h3><p><strong>Extended Timeout for Rate-Limited Syncs</strong>:</p>
<pre><code class="language-nginx"><span class="hljs-section">location</span> <span class="hljs-regexp">~ ^/api/(cisco|kev)/sync$</span> {
    <span class="hljs-attribute">proxy_pass</span> http://hextrackr_backend;

    <span class="hljs-comment"># Extended timeouts for rate-limited API syncs (10 minutes)</span>
    <span class="hljs-attribute">proxy_connect_timeout</span> <span class="hljs-number">60s</span>;
    <span class="hljs-attribute">proxy_send_timeout</span> <span class="hljs-number">600s</span>;    <span class="hljs-comment"># 2min ‚Üí 10min</span>
    <span class="hljs-attribute">proxy_read_timeout</span> <span class="hljs-number">600s</span>;    <span class="hljs-comment"># 2min ‚Üí 10min</span>
}</code></pre><p><strong>Why 10 Minutes</strong>: 126 CVEs √ó 3s = ~6 minutes minimum, allows buffer for API response time</p>
<h3>Current Statistics (Sync in Progress)</h3><p><strong>As of 2025-10-11</strong>:</p>
<ul>
<li>Total Advisories Synced: 82 (of 126 CVEs)</li>
<li>With Fixed Versions: 71 (86.6%)</li>
<li>Without Fixed Versions: 11 (13.4%)</li>
<li>Average Fixed Versions per CVE: 28.3</li>
<li>Top CVE: CVE-2021-1392 with 65 fixed versions</li>
</ul>
<p><strong>Sample Advisory</strong>:</p>
<pre><code class="language-">CVE-2017-3881: Cisco IOS Cluster Management Protocol RCE
‚îú‚îÄ‚îÄ Advisory: cisco-sa-20170317-cmp
‚îú‚îÄ‚îÄ Fixed Versions: 20 total
‚îÇ   ‚îú‚îÄ‚îÄ Minimum: 12.2(22)S1
‚îÇ   ‚îú‚îÄ‚îÄ Also: 12.2(30)S, 15.3(3)S8, ...
‚îî‚îÄ‚îÄ UI Display: &quot;Fixed in: 12.2(22)S1 or later&quot;</code></pre><h3>Frontend Integration (Phase 3 - Next)</h3><p><strong>Vulnerability Details Modal Query</strong>:</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> advisory = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/cisco/advisory/<span class="hljs-subst">${cveId}</span>`</span>);

<span class="hljs-comment">// Returns:</span>
{
    <span class="hljs-string">&quot;advisory_id&quot;</span>: <span class="hljs-string">&quot;cisco-sa-20170317-cmp&quot;</span>,
    <span class="hljs-string">&quot;minimum_fixed_version&quot;</span>: <span class="hljs-string">&quot;12.2(22)S1&quot;</span>,  <span class="hljs-comment">// first_fixed[0]</span>
    <span class="hljs-string">&quot;total_fixed_versions&quot;</span>: <span class="hljs-number">20</span>,
    <span class="hljs-string">&quot;has_fix&quot;</span>: <span class="hljs-number">1</span>,
    <span class="hljs-string">&quot;advisory_url&quot;</span>: <span class="hljs-string">&quot;https://sec.cloudapps.cisco.com/...&quot;</span>,
    <span class="hljs-string">&quot;last_synced&quot;</span>: <span class="hljs-string">&quot;2025-10-12 00:49:53&quot;</span>
}</code></pre><hr>
<p><strong>Status</strong>: ‚úÖ Phase 2 Complete - Full Backend Architecture Implemented and Working<br><strong>Next Milestone</strong>: Phase 3 - API Endpoint for Frontend Modal + UI Display</p>

    <!-- Note: This file is intentionally minimal. The full page scaffold, header, footer, and scripts
             are provided by docs-html/index.html. Content generated using this template will be
             fetched and injected into #content-container by docs-html/js/docs-portal-v2.js. -->
</section>
