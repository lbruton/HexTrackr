<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HEX-254 Session 3 Logger Test</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #0f0; }
        button { margin: 10px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
        #output { background: #000; padding: 15px; margin-top: 20px; border: 1px solid #0f0; max-height: 600px; overflow-y: auto; }
        .success { color: #0f0; }
        .error { color: #f00; }
        .info { color: #0ff; }
    </style>
</head>
<body>
    <h1>HEX-254 Session 3: Frontend Logger + Audit API Test</h1>

    <h2>Test Controls</h2>
    <button onclick="testConfigLoading()">1. Test Config Loading</button>
    <button onclick="testCategoryLogging()">2. Test Category Logging</button>
    <button onclick="testAuditEndpoint()">3. Test Audit Endpoint</button>
    <button onclick="testLegacyCompatibility()">4. Test Legacy Compatibility</button>
    <button onclick="runAllTests()">â–¶ Run All Tests</button>
    <button onclick="clearOutput()">Clear Output</button>

    <div id="output"></div>

    <script src="/scripts/shared/logger.js"></script>
    <script>
        const output = document.getElementById('output');

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
        }

        function clearOutput() {
            output.innerHTML = '';
        }

        async function testConfigLoading() {
            log('=== Test 1: Config Loading ===', 'info');

            try {
                // Test config endpoint availability
                const response = await fetch('/config/logging.config.json');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const config = await response.json();
                log('âœ… Config loaded from /config/logging.config.json', 'success');
                log(`   Global enabled: ${config.global.enabled}`, 'info');
                log(`   Audit enabled: ${config.global.auditEnabled}`, 'info');
                log(`   Frontend categories: ${Object.keys(config.frontend.categories).length}`, 'info');

                // Check logger.config
                if (window.logger.configLoaded) {
                    log('âœ… Logger config loaded successfully', 'success');
                } else {
                    log('â³ Logger config still loading...', 'info');
                    setTimeout(() => {
                        if (window.logger.configLoaded) {
                            log('âœ… Logger config loaded (async)', 'success');
                        }
                    }, 1000);
                }
            } catch (error) {
                log(`âŒ Config loading failed: ${error.message}`, 'error');
            }
        }

        async function testCategoryLogging() {
            log('=== Test 2: Category-Aware Logging ===', 'info');

            // Test category-aware methods
            logger.debug('ui', 'ðŸ› Debug log with UI category');
            logger.info('vulnerability', 'â„¹ï¸ Info log with vulnerability category');
            logger.warn('websocket', 'âš ï¸ Warning log with websocket category');
            logger.error('api', 'âŒ Error log with API category');

            log('âœ… Category logging methods executed (check browser console)', 'success');
            log('   Expected: All 4 logs should appear in console', 'info');
        }

        async function testAuditEndpoint() {
            log('=== Test 3: Audit Endpoint ===', 'info');

            try {
                // Test audit logging directly
                const response = await fetch('/api/audit-logs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        category: 'test.session3',
                        message: 'Frontend logger Session 3 test',
                        data: {
                            timestamp: new Date().toISOString(),
                            testName: 'HEX-254 Session 3',
                            userAgent: navigator.userAgent
                        }
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    log('âœ… Audit endpoint responded successfully', 'success');
                    log(`   Response: ${JSON.stringify(result)}`, 'info');
                } else {
                    const error = await response.json();
                    log(`âŒ Audit endpoint failed: ${response.status}`, 'error');
                    log(`   Error: ${JSON.stringify(error)}`, 'error');
                }

                // Test via logger.audit() method
                await logger.audit('test.logger_method', 'Testing logger.audit() method', {
                    method: 'logger.audit()',
                    session: 3
                });
                log('âœ… logger.audit() method executed', 'success');

            } catch (error) {
                log(`âŒ Audit test failed: ${error.message}`, 'error');
            }
        }

        async function testLegacyCompatibility() {
            log('=== Test 4: Legacy Compatibility ===', 'info');

            // Test legacy usage without categories (should still work)
            logger.log('Legacy log() without category');
            logger.debug('Legacy debug() without category');
            logger.info('Legacy info() without category');
            logger.warn('Legacy warn() without category');
            logger.error('Legacy error() without category');

            log('âœ… Legacy methods executed (check browser console)', 'success');
            log('   Expected: All 5 logs should appear in console', 'info');
        }

        async function runAllTests() {
            clearOutput();
            log('=== Running All Tests ===', 'info');
            log('', 'info');

            await testConfigLoading();
            await new Promise(resolve => setTimeout(resolve, 500));

            await testCategoryLogging();
            await new Promise(resolve => setTimeout(resolve, 500));

            await testAuditEndpoint();
            await new Promise(resolve => setTimeout(resolve, 500));

            await testLegacyCompatibility();

            log('', 'info');
            log('=== All Tests Complete ===', 'success');
            log('Now verify encrypted audit logs in database:', 'info');
            log('  docker exec hextrackr-app sqlite3 /app/app/data/hextrackr.db "SELECT id, category, username, encrypted_message FROM audit_logs ORDER BY created_at DESC LIMIT 5"', 'info');
        }

        // Auto-run tests on load
        window.addEventListener('load', () => {
            log('Logger test page loaded', 'success');
            log('Logger instance available: ' + (window.logger ? 'YES' : 'NO'), 'info');
            log('Ready to run tests!', 'info');
        });
    </script>
</body>
</html>
