<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth State Test - HexTrackr</title>

    <!-- Tabler CSS -->
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css" rel="stylesheet">

    <!-- Tabler Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/dist/tabler-icons.min.css">

    <!-- FontAwesome (LOCAL HOSTED - eliminates glyph bbox warnings) -->
    <link rel="stylesheet" href="fonts/fontawesome.min.css">
</head>
<body>
    <!-- Header Container -->
    <div id="headerContainer"></div>

    <div class="page-wrapper">
        <div class="page-body">
            <div class="container-xl">
                <div class="row row-deck row-cards mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Authentication State Test</h3>
                            </div>
                            <div class="card-body">
                                <h4>Test Results:</h4>
                                <pre id="testResults" style="background: #f7f7f7; padding: 1rem; border-radius: 4px;">Loading...</pre>

                                <div class="mt-3">
                                    <button id="testInit" class="btn btn-primary">Test init()</button>
                                    <button id="testGetUser" class="btn btn-info">Test getUser()</button>
                                    <button id="testIsAuth" class="btn btn-success">Test isAuthenticated()</button>
                                    <button id="testFetch" class="btn btn-warning">Test authenticatedFetch()</button>
                                    <button id="testLogout" class="btn btn-danger">Test logout()</button>
                                    <button id="testSessionModal" class="btn btn-secondary">Test Session Expired Modal</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Tabler JS -->
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/js/tabler.min.js"></script>

    <!-- Auth State -->
    <script src="/scripts/shared/auth-state.js"></script>

    <!-- Header Loader -->
    <script src="/scripts/shared/header-loader.js"></script>

    <script>
        const results = document.getElementById('testResults');

        function log(message) {
            results.textContent += message + '\n';
        }

        // Test init on page load
        document.addEventListener('DOMContentLoaded', async () => {
            log('=== Auth State Test Suite ===\n');

            // Test 1: Check global instance exists
            if (window.authState) {
                log('✅ Global authState instance exists');
            } else {
                log('❌ Global authState instance NOT found');
                return;
            }

            // Test 2: Init
            log('\n--- Testing init() ---');
            const isAuth = await authState.init();
            log(`Authentication status: ${isAuth}`);

            if (isAuth) {
                // Test 3: Get user
                log('\n--- Testing getUser() ---');
                const user = authState.getUser();
                log(`User: ${JSON.stringify(user, null, 2)}`);

                // Test 4: isAuthenticated
                log('\n--- Testing isAuthenticated() ---');
                log(`Is authenticated: ${authState.isAuthenticated()}`);

                // Update user menu
                log('\n--- Testing updateUserMenu() ---');
                setTimeout(() => {
                    authState.updateUserMenu();
                    log('✅ User menu updated (check navbar)');
                }, 500);
            }
        });

        // Button handlers
        document.getElementById('testInit').addEventListener('click', async () => {
            log('\n--- Manual init() test ---');
            const result = await authState.init();
            log(`Result: ${result}`);
        });

        document.getElementById('testGetUser').addEventListener('click', () => {
            log('\n--- Manual getUser() test ---');
            const user = authState.getUser();
            log(`User: ${JSON.stringify(user, null, 2)}`);
        });

        document.getElementById('testIsAuth').addEventListener('click', () => {
            log('\n--- Manual isAuthenticated() test ---');
            log(`Is authenticated: ${authState.isAuthenticated()}`);
        });

        document.getElementById('testFetch').addEventListener('click', async () => {
            log('\n--- Manual authenticatedFetch() test ---');
            try {
                const response = await authState.authenticatedFetch('/api/auth/status');
                const data = await response.json();
                log(`Fetch result: ${JSON.stringify(data, null, 2)}`);
            } catch (error) {
                log(`Fetch error: ${error.message}`);
            }
        });

        document.getElementById('testLogout').addEventListener('click', async () => {
            log('\n--- Manual logout() test ---');
            if (confirm('Are you sure you want to log out?')) {
                await authState.logout();
            }
        });

        document.getElementById('testSessionModal').addEventListener('click', () => {
            log('\n--- Manual showSessionExpiredModal() test ---');
            authState.showSessionExpiredModal();
        });
    </script>
</body>
</html>
