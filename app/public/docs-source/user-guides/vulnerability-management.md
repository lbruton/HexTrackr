# Vulnerability Management Guide

The Vulnerability Management dashboard (`vulnerabilities.html`) is a powerful tool for analyzing, tracking, and managing security vulnerabilities across your assets.

## Importing Vulnerability Data

The primary way to populate the dashboard is by importing CSV files from vulnerability scanners. HexTrackr supports multiple CSV formats with advanced processing capabilities.

### Basic Import Process

1. From the dashboard, click the **Import** button.
2. You will be prompted to select a **Scan Date**. This date is critical for accurate historical trending. It should be the date the vulnerability scan was performed.
3. After confirming the date, select the CSV file from your computer.

The system will then upload and process the file. Thanks to the rollover pipeline described in [Backend Architecture](../architecture/backend.md#vulnerability-rollover-workflow), the new data will be integrated and the dashboard will automatically refresh.

### Progress Feedback and WebSocket Fallback

- The import dialog launches the shared **Progress Modal**, which joins the session returned by `POST /api/vulnerabilities/import-staging` and displays live updates from Socket.io (`progress-update`, `progress-complete`, `progress-error`).
- If the WebSocket connection fails, the modal displays a warning banner and continues in manual mode-imports still complete, but the progress bar advances based on return values from the REST endpoints.
- Enable verbose WebSocket logging for troubleshooting by setting `localStorage.hextrackr_debug = "true"` before starting an import.

### Supported CSV Formats

HexTrackr automatically detects and processes multiple CSV export formats from various vulnerability scanners:

#### Format 1: Legacy Cisco Export (aug28 style)

## Key Characteristics

- Missing `definition.cve` column
- CVE data extracted from `definition.name` using intelligent regex patterns
- Cisco vulnerability IDs extracted from parentheses in vulnerability names

## Supported Columns

- `asset.display_ipv4_address` - Primary IP address of the asset
- `asset.id` - Unique asset identifier
- `asset.name` - Hostname of the affected device
- `definition.family` - Vulnerability family (e.g., "CISCO", "Misc.")
- `definition.id` - Plugin/vulnerability identifier
- `definition.name` - Full vulnerability name with embedded identifiers
- `definition.vpr.score` - Vulnerability Priority Rating score
- `id` - Unique vulnerability instance identifier
- `severity` - Risk severity level
- `state` - Vulnerability state (typically "ACTIVE")

## CVE Extraction Examples

- `Cisco IOS XE Software Bootstrap (cisco-sa-bootstrap-KfgxYgdh)` -> extracts `cisco-sa-bootstrap-KfgxYgdh`
- `SSH Weak MAC Algorithms Enabled` -> no CVE extracted (handled via plugin ID)

#### Format 2: Standard Cisco Export (sept01/sept02 style)

## Key Characteristics: (2)

- Direct `definition.cve` column mapping (recommended format)
- Enhanced metadata including plugin publication dates
- Support for resurfaced vulnerability tracking

## Additional Columns

- `definition.cve` - Direct CVE identifier mapping
- `definition.plugin_published` - Plugin publication date (ISO format)
- `definition.plugin_updated` - Plugin last update date (ISO format)
- `resurfaced_date` - Date when vulnerability reappeared (if applicable)

**This is the recommended export format** for optimal data quality and processing efficiency.

#### Format 3: Full Tenable Export (comprehensive format)

## Key Characteristics: (3)

- Support for `asset.ipv4_addresses` with multiple comma-separated IPs
- Comprehensive vulnerability metadata and risk scoring
- Enhanced fields for advanced vulnerability management
- Handles large files (60MB+) efficiently

## Extended Columns

- `asset.ipv4_addresses` - Multiple IP addresses (comma-separated)
- `definition.description` - Detailed vulnerability description
- `definition.vpr_v2.score` - Enhanced VPR scoring
- `definition.vpr_v2.drivers_cve_id` - CVE drivers for VPR calculation
- `definition.vulnerability_published` - CVE publication date
- `vuln_age` - Age of vulnerability in days
- `vuln_sla_date` - SLA target date for remediation
- `port` - Affected network port
- `protocol` - Network protocol
- `age_in_days` - Asset exposure duration

### Advanced Import Features

#### CVE and Vulnerability ID Extraction Logic

The import system uses a comprehensive multi-tier approach to identify vulnerability information:

1. **Primary CVE**: Direct mapping from `definition.cve` column
2. **CVE Fallback**: Regex extraction from `definition.name` using pattern `(CVE-\d{4}-\d+)`
3. **Cisco Vulnerability IDs**: Extract Cisco Security Advisory IDs from parentheses `(cisco-sa-[\w-]+)` patterns
4. **Plugin Fallback**: Use `definition.id` + `definition.name` for unique identification

##### Cisco Security Advisory Support

HexTrackr now provides enhanced support for Cisco vulnerability identifiers:

- **Pattern Recognition**: Automatically detects `cisco-sa-*` patterns in vulnerability names
- **Link Generation**: Cisco SA IDs link directly to Cisco's security advisory portal
- **Display Priority**: Cisco SA IDs are displayed prominently in the "Vulnerability" column (renamed from "CVE")
- **Fallback Handling**: When neither CVE nor Cisco SA is available, displays plugin ID with descriptive styling

## Examples

- **CVE Direct**: `CVE-2025-20155` -> `CVE-2025-20155` (links to CVE.org)
- **CVE Extracted**: `Cisco IOS Software DoS (CVE-2020-3200)` -> `CVE-2020-3200` (links to CVE.org)
- **Cisco SA**: `Bootstrap Vulnerability (cisco-sa-bootstrap-KfgxYgdh)` -> `cisco-sa-bootstrap-KfgxYgdh` (links to cisco.com)
- **Plugin ID**: `SSH Weak Encryption` -> `Plugin 12345` (plugin ID with styling)

#### Multiple Value Handling

**CVEs (Comma-separated)**:

- Input: `"CVE-2023-1234, CVE-2023-5678, CVE-2023-9012"`
- Processing: Uses first CVE (`CVE-2023-1234`) as primary identifier
- Additional CVEs stored in description for reference

**IP Addresses (Comma-separated)**:

- Input: `"10.95.12.1, 10.40.12.1, 10.50.12.1"`
- Processing: Uses first IP (`10.95.12.1`) as primary address
- Complete list maintained for device correlation

#### Hostname Normalization

Automatic hostname processing for consistent device identification:

- **Domain Stripping**: `server01.domain.com` -> `server01`
- **IP Preservation**: `192.168.1.1` -> `192.168.1.1` (no modification)
- **Invalid Format Handling**: Gracefully handles malformed hostnames

#### Enhanced Deduplication

Multi-tier unique key generation with confidence scoring:

1. **Tier 1**: `asset.id` + `definition.id` (95% confidence - most stable)
2. **Tier 2**: `normalized_hostname` + `cve` (90% confidence)
3. **Tier 3**: `definition.id` + `normalized_hostname` + `vendor` (85% confidence)
4. **Tier 4**: `plugin_id` + `description` hash (80% confidence - fallback)

### Rollover Architecture Behavior

HexTrackr implements a sophisticated rollover system that manages vulnerability lifecycles:

#### Import Processing Flow

1. **File Upload**: CSV files uploaded via the dashboard import button trigger server-side processing
2. **Data Parsing**: Advanced CSV parsing handles multiple formats with intelligent column detection
3. **Vulnerability ID Extraction**: System extracts CVE, Cisco SA, or plugin identifiers using multi-tier logic
4. **New Import Storage**: CSV data processed and stored in `vulnerability_snapshots` (historical record)
5. **Current State Update**: `vulnerabilities_current` table updated with latest vulnerability state
6. **Lifecycle Management**: System automatically determines vulnerability lifecycle states
7. **UI Refresh**: Dashboard automatically updates to display new data with enhanced vulnerability column
8. **Aggregation**: Daily totals updated for trend analysis

#### Lifecycle States

- **`active`**: Newly discovered or currently present vulnerabilities
- **`reopened`**: Previously resolved vulnerabilities that have reappeared
- **`resolved`**: Vulnerabilities no longer detected in latest scan

#### Expected Behavior After Import

**New Vulnerabilities**:

- Immediately appear in dashboard with `lifecycle_state = 'active'`
- Included in current vulnerability counts and statistics
- Available in all dashboard views (Table, Devices, Vulnerabilities)

**Missing Vulnerabilities**:

- Vulnerabilities not found in new scan marked as `lifecycle_state = 'resolved'`
- Hidden from main dashboard views (maintains clean current state)
- Historical data preserved for trend analysis

**Reappearing Vulnerabilities**:

- Previously resolved vulnerabilities that reappear marked as `lifecycle_state = 'reopened'`
- Displayed prominently in dashboard with reopened status
- Lifecycle history maintained for audit purposes

### Import Troubleshooting

#### Common Issues and Solutions

## Empty Dashboard After Import

- **Issue**: No vulnerabilities visible despite successful import
- **Cause**: Default view filters show only `active` and `reopened` states
- **Solution**: Check `lifecycle_state` filtering; resolved vulnerabilities are hidden by design
- **Verification**: Use `/api/vulnerabilities/resolved` endpoint to verify resolved items

## Missing CVE Information

- **Issue**: CVE fields appear blank in dashboard
- **Cause**: CVE extraction failed from `definition.name` field
- **Solution**: Verify vulnerability names contain recognizable CVE patterns
- **Workaround**: System uses plugin ID + description for unique identification

## Hostname Duplicates

- **Issue**: Same device appears multiple times with slight name variations
- **Cause**: Hostname normalization not handling specific domain patterns
- **Solution**: Check normalized hostname rules; may need custom normalization
- **Example**: `server01.corp.com` and `server01.internal.com` both normalize to `server01`

## Large File Performance

- **Issue**: Import appears slow or times out with large CSV files
- **Cause**: Client-side processing limitations with files over 10MB
- **Solution**: System automatically switches to server-side processing for large files
- **Expected**: Files over 60MB process successfully with progress indicators

## Incomplete Data After Import

- **Issue**: Some vulnerability records missing key fields
- **Cause**: CSV column mapping mismatch or unsupported format
- **Solution**: Verify CSV format matches supported column structures
- **Debugging**: Check server logs for field mapping warnings

## CSV Import Returns 404 Error (Fixed in v1.0.5)

- **Issue**: CSV file upload fails with 404 "Cannot POST /undefined/import" error
- **Root Cause**: Missing `apiBase` property in ModernVulnManager class causing undefined API endpoint URLs
- **Symptoms**: Import button clicks result in 404 errors, CSV files not processed
- **Resolution**: Fixed in version 1.0.5 by adding `this.apiBase = "/api"` property to ModernVulnManager constructor
- **Verification**: Import functionality now properly routes to `/api/vulnerabilities/import` endpoint
- **Impact**: Resolves complete CSV import functionality breakdown that prevented all vulnerability data uploads

#### Supported Column Mapping Reference

| Source Column | Internal Mapping | Purpose | Required |
|---------------|------------------|---------|----------|
| `asset.display_ipv4_address` | `ip_address` | Primary device IP | Yes |
| `asset.ipv4_addresses` | `ip_address` | Multi-IP support (first used) | Alternative |
| `asset.name` | `hostname` | Device hostname | Yes |
| `asset.id` | `asset_id` | Unique asset identifier | Recommended |
| `definition.cve` | `cve` | Direct CVE mapping | Preferred |
| `definition.name` | `plugin_name` | Vulnerability name/CVE source | Yes |
| `definition.id` | `plugin_id` | Plugin identifier | Yes |
| `definition.family` | `vendor` | Vulnerability vendor/family | Yes |
| `definition.vpr.score` | `vpr_score` | Risk priority score | Recommended |
| `definition.description` | `description` | Detailed vulnerability info | Optional |
| `severity` | `severity` | Risk severity level | Yes |
| `state` | `state` | Current vulnerability state | Yes |

#### Performance Optimization

**Large File Handling**:

- Files under 10MB: Client-side parsing with Papa.parse
- Files over 10MB: Automatic server-side processing
- Memory management: Streaming processing prevents memory exhaustion
- Progress tracking: Real-time import progress for large datasets

**Database Optimization**:

- Sequential processing prevents race conditions during import
- Batch insertion for improved performance
- Automatic cleanup of temporary files after processing
- Database transaction handling ensures data integrity

## The Dashboard

The dashboard provides multiple ways to analyze your vulnerability data.

### Statistics Cards

At the top of the page, you'll find cards summarizing the current vulnerability state by severity. You can **click on any card** to flip it and view the data in two ways:

- **Vulnerability Counts**: The total number of vulnerabilities for that severity.
- **VPR Totals**: The sum of the Vulnerability Priority Rating (VPR) scores for that severity, giving you a risk-based perspective.

### Historical Trend Chart

The main chart visualizes vulnerability trends over time. You can toggle the view to see trends based on:

- **Vulnerability Count**
- **VPR Score Sum**

This allows you to see whether your overall risk is increasing or decreasing.

## Data Views

You can switch between three different views to analyze the data from different perspectives:

### 1. Table View

This is the default view, powered by AG Grid. It provides a detailed, sortable, and filterable table of all current vulnerabilities.

- **Sorting**: Click on any column header to sort the data.
- **Filtering**: Use the search bar and the severity dropdown to filter the data.
- **Column Resizing**: Drag column borders to resize columns to your preferred width.
- **Advanced Features**: The table includes grouping, column pinning, and export capabilities for comprehensive data analysis.

### 2. Devices View

This view groups all vulnerabilities by the affected device (hostname). Each card represents a device and shows:

- The total number of vulnerabilities on that device.
- The total VPR score for that device.
- A breakdown of vulnerabilities by severity.

Click **View Device Details** to see a list of all vulnerabilities affecting that specific device. The device modal provides detailed information about the selected device and displays an interactive grid of its vulnerabilities.

**Enhanced Modal Aggregation (v1.0.6+)**: The device modal now properly aggregates and displays ALL vulnerabilities affecting the selected device. For example, a device like `grimesnswan03` will show all 12 vulnerabilities associated with it, providing complete visibility into the device's vulnerability profile.

**Enhanced Navigation**: You can click on hostname links within vulnerability modals to seamlessly navigate to device details. The modal system now properly transitions between views, ensuring a smooth user experience without layering issues.

### 3. Vulnerabilities View

This view groups all findings by vulnerability identifier (CVE, Cisco SA, or plugin ID). Each card represents a unique vulnerability and shows:

- The number of devices affected by it.
- The total VPR score it contributes across all devices.
- A breakdown of the severity of the findings.
- **Enhanced Display**: Vulnerability identifiers are now shown in a dedicated "Vulnerability" column with appropriate linking:
  - **CVE identifiers** link to the MITRE CVE database
  - **Cisco SA identifiers** link to Cisco's security advisory portal
  - **Plugin IDs** are styled for easy identification when CVE/SA data is unavailable

Click on a card to see a list of all devices affected by that vulnerability.

**Enhanced Modal Aggregation (v1.0.6+)**: The vulnerability modal now properly aggregates and displays ALL devices affected by the selected vulnerability. For example, CVE-2017-3881 will show all 24 affected devices in a comprehensive list, providing complete visibility into the vulnerability's impact across your infrastructure.

## Card Pagination

Both the Devices View and Vulnerabilities View now include intelligent pagination controls:

- **Default Display**: Shows 6 cards per page for optimal viewing and performance
- **Navigation Controls**: Use the pagination controls at the bottom to navigate through pages
- **Responsive Design**: Cards automatically adjust to screen size while maintaining readability
- **Quick Navigation**: Jump to first, last, or specific page numbers for efficient browsing

This pagination system ensures smooth performance even with large datasets while maintaining the visual appeal of the card-based interface.

## Vulnerability Lookup

From the Table or Vulnerability views, you can click on vulnerability identifiers to access authoritative information:

- **CVE identifiers** (e.g., `CVE-2023-12345`) link to the [MITRE CVE website](https://cve.mitre.org/)
- **Cisco SA identifiers** (e.g., `cisco-sa-bootstrap-KfgxYgdh`) link to [Cisco's Security Advisory portal](https://cisco.com/c/en/us/support/docs/csa/)
- **Plugin IDs** display with distinctive styling for easy identification

This provides direct access to detailed vulnerability information from authoritative sources.

## Integration with Other Systems

The vulnerability management system integrates seamlessly with other HexTrackr components:

- **Ticket System**: Create tickets directly from vulnerability data
- **ServiceNow Integration**: Automated ticket creation for critical vulnerabilities
- **Backup System**: All vulnerability data included in system-wide backups
- **API Access**: RESTful API endpoints for programmatic access to vulnerability data
