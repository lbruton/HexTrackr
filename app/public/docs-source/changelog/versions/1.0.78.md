# Version 1.0.78

---

## [1.0.78] - 2025-10-17

### Bug Fixes

#### Critical Template Truncation Fix (HEX-286) - 2025-10-17

**Description**: Fixed major bug where ticket markdown templates were truncated in the database, causing incomplete template rendering in ticket details modal.

**Problem**:
- Ticket details modal displayed truncated markdown templates
- `markdown_replacement` template cut off at "Tracking: [TRACKIN" (392 chars instead of 1133)
- Missing sections: Return Address, Equipment details, Action Required, Timeline, Personnel, Notes
- Affected all 3 markdown templates: `markdown_upgrade`, `markdown_replacement`, `markdown_mitigate`
- `default_content` field completely empty (0 bytes)

**Root Cause**:
Migration 008 used `SELECT...FROM` pattern to create job-type-specific templates, which propagated already-truncated data from source template, causing cascading corruption.

**Solution**:
- Created Migration 013 to restore all 3 templates from canonical source (`seedEmailTemplates.js`)
- Updated both `template_content` AND `default_content` fields
- Verified template lengths: markdown_mitigate (947 chars), markdown_replacement (1133 chars), markdown_upgrade (982 chars)

**Files Modified**:
- **Created**: `app/public/scripts/migrations/013-fix-truncated-markdown-templates.sql`

**Commit**: `fix(HEX-286): Restore truncated markdown ticket templates` (bfddcb1b)

**Verification**:
- ✅ Database verification: Templates show correct lengths and full content
- ✅ Browser test: Ticket 0039 (REFRESH job type) displays complete template
- ✅ All sections now render correctly

---

#### Backup Retention Policy Enforcement (HEX-283/284) - 2025-10-17

**Description**: Fixed backup retention policy not being enforced, allowing manual backups to accumulate beyond configured limits.

**Problem**:
- Vulnerability backups: 5 manual backups displayed (expected max 3)
- Tickets backups: 4 manual backups displayed (expected max 3)
- Old backups accumulated across Docker restarts

**Root Cause**:
Backup cleanup only executed AFTER creating new manual backups, not on application startup. When Docker container restarted, old backups persisted until next manual backup triggered cleanup.

**Solution**:
Added startup backup cleanup scheduler in `server.js` (lines 655-669):
```javascript
// HEX-283/284: Enforce backup retention on startup (5 second delay)
setTimeout(async () => {
    const result = await backupService.cleanupOldBackups();
    if (result.deleted > 0) {
        logger.info("system", "Startup cleanup: X old backups deleted, Y MB freed");
    }
}, 5000);
```

**Retention Policy Enforced**:
- Automated backups: Keep 7 most recent
- Manual backups: Keep 3 most recent
- Per type: Vulnerabilities, Tickets, Database

**Files Modified**:
- `app/public/server.js` - Startup cleanup scheduler

**Commit**: `fix(HEX-283/284/285): Enforce backup retention policy + fix modal button alignment` (71a73f6c)

**Verification**:
- ✅ Docker restart triggered startup cleanup
- ✅ Deleted 3 old backups (134.54MB freed)
- ✅ Verified: 3 vulnerability + 3 tickets manual backups remain (within limits)

---

#### Backup Modal Button Alignment (HEX-285) - 2025-10-17

**Description**: Fixed vertical misalignment of download buttons in Backup Management modals.

**Problem**:
- Download buttons vertically misaligned with backup list items
- Radio buttons, backup info, and download buttons not on same horizontal line
- Affected both Vulnerability and Tickets backup modals

**Root Cause**:
Missing flexbox alignment classes on column containers. Bootstrap `col-auto` divs lacked vertical centering.

**Solution**:
Applied consistent flexbox alignment in `backup-modal.js` (lines 249-272):
```javascript
// Added d-flex align-items-center to all col-auto divs
<div class="col-auto d-flex align-items-center">
    <button class="btn btn-sm btn-primary">Download</button>
</div>
```

**Files Modified**:
- `app/public/scripts/shared/backup-modal.js` - Button alignment fix

**Commit**: `fix(HEX-283/284/285): Enforce backup retention policy + fix modal button alignment` (71a73f6c)

**Verification**:
- ✅ Visual inspection: All buttons align with backup list items
- ✅ Tested both Vulnerability and Tickets modals
- ✅ Alignment consistent across all backup types (manual/auto)

---

#### KEV Background Sync Scheduler Restored (HEX-282) - 2025-10-17

**Description**: Restored missing KEV (CISA Known Exploited Vulnerabilities) background sync scheduler and removed redundant Cisco advisory caching layer.

**Problem 1: KEV Background Sync Missing**:
- KEV auto-sync toggle in UI saved preference but had no effect
- Documentation claimed "Every 24 hours" sync but it never ran
- Manual "Sync Now" worked, hiding the silent feature loss
- Background scheduler code was lost (likely in merge conflict)

**Problem 2: Cisco Advisory Cache Issues**:
- Server cached null responses for 5 minutes when frontend requested advisory before sync
- Stale "not found" results persisted even after successful sync
- Redundant caching layer (database IS the cache for persisted advisory data)

**Solution 1: KEV Background Sync**:
Added KEV background sync scheduler in `server.js` (lines 574-634):
```javascript
// CISA KEV background sync scheduler (HEX-282)
setTimeout(async () => {
    if (kevBackgroundSyncEnabled) {
        logger.info("system", "CISA KEV background sync scheduled (every 24 hours)");
        setInterval(async () => {
            await kevService.syncKevData();
        }, 24 * 60 * 60 * 1000);
    }
}, 6 * 60 * 1000); // 6 min after startup
```

**Features**:
- Mirrors Cisco/Palo Alto pattern (startup delay + 24hr interval)
- Staggered timing: KEV runs 6min after startup (prevents database lock contention)
- Respects `kev_background_sync_enabled` preference

**Background Sync Schedule** (All Staggered):
- Cisco: 5.0 min after startup + every 24 hours
- Palo Alto: 5.5 min after startup + every 24 hours
- KEV: 6.0 min after startup + every 24 hours

**Solution 2: Cisco Advisory Cache Removal**:
Removed redundant caching layer in `ciscoController.js` (lines 112-122):
```javascript
// HEX-282: Query database directly - no cache needed
// Database IS the cache - advisory data is persisted from sync operations
const advisoryData = await this.ciscoAdvisoryService.getCiscoAdvisory(cveId);

// Set browser cache header (60 seconds) for moderate caching
res.setHeader("Cache-Control", "public, max-age=60, must-revalidate");

// Return null for 404s (frontend handles this gracefully)
return res.json(advisoryData || null);
```

**Caching Strategy**:
- Database: Persistent storage (primary cache)
- Browser: 60-second Cache-Control header
- Frontend: 5-minute cache in `cisco-advisory-helper.js`
- Eliminated: Server-side null response caching (caused stale data)

**Files Modified**:
- `app/public/server.js` - KEV background sync scheduler restored
- `app/controllers/ciscoController.js` - Removed redundant cache layer
- `app/public/scripts/shared/cisco-advisory-helper.js` - Frontend cache documentation
- `app/services/ciscoAdvisoryService.js` - Service layer updates

**Commit**: `fix(HEX-282): Restore KEV background sync scheduler + remove redundant Cisco advisory cache` (f162c80f)

**Verification**:
- ✅ Docker restart triggers all three syncs in sequence
- ✅ KEV preference initialization confirmed in logs
- ✅ No database lock contention with staggered timing
- ✅ Cisco advisory queries return fresh data (no stale nulls)
- ✅ Browser cache headers set correctly (60 seconds)

---

## Summary

**Total Issues Fixed**: 4 major bugs (HEX-282, HEX-283, HEX-284, HEX-285, HEX-286)

**Categories**:
- Database corruption: 1 (template truncation)
- Background scheduling: 2 (backup retention, KEV sync)
- Caching issues: 1 (Cisco advisory stale data)
- UI alignment: 1 (backup modal buttons)

**Impact**:
- ✅ Ticket templates now render completely (1133 chars vs 392 truncated)
- ✅ Backup retention enforced automatically on startup (freed 134.54MB)
- ✅ KEV background sync restored (24-hour automated updates)
- ✅ Cisco advisory cache eliminated (no more stale null responses)
- ✅ Backup modal UI properly aligned

**Technical Debt Addressed**:
- Migration pattern improved (avoid SELECT...FROM for critical data)
- Eliminated redundant caching layers (database as single source of truth)
- Startup initialization now enforces data retention policies
- Staggered background sync prevents database lock contention

---

## Related Issues

- [HEX-282](https://linear.app/hextrackr/issue/HEX-282) - KEV background sync scheduler missing + Cisco advisory cache issues
- [HEX-283](https://linear.app/hextrackr/issue/HEX-283) - Manual backup retention policy not enforced (Vulnerability backups)
- [HEX-284](https://linear.app/hextrackr/issue/HEX-284) - Manual backup retention policy not enforced (Tickets backups)
- [HEX-285](https://linear.app/hextrackr/issue/HEX-285) - Backup modal buttons vertically misaligned
- [HEX-286](https://linear.app/hextrackr/issue/HEX-286) - Ticket markdown templates truncated in database

---

*Changelog Version: 1.0.78 | Bug Fixes | 2025-10-17*
