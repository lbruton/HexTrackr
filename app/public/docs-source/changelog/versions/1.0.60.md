# Version 1.0.60

---

## [1.0.60] - 2025-10-10

### Fixed

#### Vendor Filter Trend Percentage Inconsistency (HEX-183)

**Overview**: Fixed data consistency bug where vendor filter correctly updated VPR card totals and charts but not trend percentage badges. Trend percentages now reflect vendor-specific changes between uploads instead of global trends.

**Problem**:
- When filtering vulnerabilities by vendor (CISCO, Palo Alto, Other), VPR card totals and charts updated correctly
- Trend percentage badges on cards (e.g., "+12%", "-5.2%") showed **global** trends instead of **vendor-specific** trends
- Example: Filtering to "CISCO" showed 450 CISCO vulnerabilities with "+12%" trend from ALL vendors combined, not CISCO-only trend
- Created misleading information for users making decisions based on vendor-filtered views

**Root Cause**:
- Vendor filter parameter wired through `setupVendorToggle()` → `updateStatisticsDisplay(vendor)` for card totals
- Trend calculation path (lines 91-122 in `vulnerability-statistics.js`) ignored vendor parameter entirely
- Always fetched global trends regardless of active vendor filter

**Solution**:
- Created `updateTrendDisplay(severity, currentStat, trendBucket, vendorFilter)` method with vendor-aware trend fetching
- Added `_fetchVendorTrends(vendorFilter)` helper to call existing backend API `/api/vulnerabilities/trends?vendor=X`
- Wired vendor parameter through call chain: filter → stats → trends
- Reused existing backend endpoint from CSV export feature (no backend changes required)

**Edge Cases Fixed**:

**1. First Upload with No Previous Data**:
- Problem: Showed invalid percentages like `+59883801295192064.0%` due to division by zero
- Solution: Check if `previous === 0` before calculating, display "N/A" instead
- Cap maximum display at 999.9% to prevent overflow

**2. Async Race Condition**:
- Problem: Rapidly toggling filters (All → CISCO → Palo → Other) caused overlapping async calls completing out of order, leaving Critical/Low cards stuck
- Solution: Collect trend update promises in array, use `await Promise.all(promises)` to ensure all 5 severity updates complete before next filter change

**3. Zero-Count Vendor Severities**:
- Problem: Palo Alto with 0 Critical/Low vulnerabilities left CISCO values displayed (43 Critical, 3192 Low) because backend returns `null` for zero-count severities
- Solution: Remove `if(stat)` guard, use default object fallback `statistics[severity] || {count: 0, total_vpr: 0}` to always update DOM

**Result**:
- Trend percentages dynamically update when switching between vendor filters
- Each vendor shows different trend percentages reflecting their specific data
- "N/A" displayed when no previous data available for comparison
- All cards update reliably even with sparse data (zero counts, first uploads)
- No race conditions from rapid filter toggling

**Testing**:
- Validated with multi-date dataset across all vendor filters
- Tested edge cases: first upload, zero-count severities, rapid toggling
- Confirmed mathematical accuracy of percentage calculations

**Files Modified**:
- `app/public/scripts/shared/vulnerability-statistics.js` - Added vendor-aware trend display with edge case handling

**Issues**:
- [HEX-183](https://linear.app/hextrackr/issue/HEX-183) - RESEARCH: Vendor Filter Trend Percentage Inconsistency
- [HEX-184](https://linear.app/hextrackr/issue/HEX-184) - PLAN: Vendor Filter Trend Percentage Inconsistency

---

#### Documentation Portal Dark Mode Issues (HEX-166, HEX-167, HEX-177)

**Overview**: Resolved three critical dark mode issues in the Documentation Portal affecting diagram rendering, code syntax highlighting, and navigation visibility. All fixes improve the documentation reading experience in dark mode without breaking light mode functionality.

---

### HEX-166: Mermaid Diagram Syntax Error

**Problem**:
- "Ticket Creation/Update" sequence diagram in database architecture docs displayed "Syntax error in text"
- Mermaid parser failed to render the diagram due to malformed markdown code fence

**Root Cause**:
- Missing closing fence (` ``` `) for Mermaid code block in `/app/public/docs-source/architecture/database.md:185`
- Markdown had `---` separator without proper fence closure
- Mermaid.js couldn't distinguish between diagram code and following content

**Solution**:
```markdown
# Before (line 185):
User->>API: { ticketData }
API->>DB: INSERT (or UPDATE for modifications) into tickets
API-->>User: { success, id }
---

# After (line 185):
User->>API: { ticketData }
API->>DB: INSERT (or UPDATE for modifications) into tickets
API-->>User: { success, id }
```
---
```

**Result**:
- Mermaid diagram renders correctly in both light and dark modes
- Proper fence closure prevents parser confusion
- All sequence diagrams in database.md validated

---

### HEX-167: Code Block Syntax Highlighting in Dark Mode

**Problem**:
- Code blocks in documentation showed all white text in dark mode
- No colorized syntax highlighting for keywords, strings, functions, etc.
- Plain monochrome code was difficult to read

**Root Causes**:
1. **Prism CDN stylesheet conflict**: CDN theme CSS (`prism.min.css`) loaded after custom dark theme CSS, overriding token colors
2. **Marked.js HTML output**: Default markdown renderer didn't add Prism-compatible `language-` class prefix
3. **Prism autoloader not configured**: Language grammars weren't loading from CDN

**Solution Implemented**:

**1. Removed conflicting CDN stylesheet** (`/app/public/docs-html/index.html:60`):
```html
<!-- Before -->
<link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css" rel="stylesheet">

<!-- After -->
<!-- Prism.js custom theme in docs-tabler.css (HEX-167) - DO NOT load CDN theme -->
```

**2. Added custom code renderer** (`/app/public/docs-html/js/docs-portal-v2.js:1280-1299`):
```javascript
// Custom code block renderer for Prism.js syntax highlighting (HEX-167)
renderer.code = function(token) {
    const code = token.text;
    const lang = token.lang || "";

    // Escape HTML in code to prevent XSS
    const escapedCode = code
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");

    // Return Prism-compatible HTML with language- prefix
    if (lang) {
        return `<pre><code class="language-${lang}">${escapedCode}</code></pre>`;
    } else {
        return `<pre><code>${escapedCode}</code></pre>`;
    }
};
```

**3. Configured Prism autoloader** (`/app/public/docs-html/index.html:151-156`):
```javascript
// Configure Prism autoloader to load language grammars from CDN
if (window.Prism) {
    Prism.plugins.autoloader.languages_path = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/';
}
```

**4. Enhanced CSS specificity** (`/app/public/docs-html/css/docs-tabler.css`):
- Custom dark mode token colors properly applied
- Light mode colors preserved
- WCAG AA contrast compliance maintained

**Token Colors (Dark Mode)**:
- Keywords: `#3b82f6` (bright blue)
- Strings: `#10b981` (bright green)
- Functions: `#fbbf24` (bright amber)
- Numbers/Constants: `#f97316` (bright orange)
- Comments: `#94a3b8` (muted gray, italic)

**Result**:
- Full colorized syntax highlighting in both light and dark modes
- Proper token classification for JavaScript, CSS, SQL, shell, etc.
- WCAG AA accessible contrast ratios
- No CSS cascade conflicts

---

### HEX-177: Navigation Header Visibility in Dark Mode

**Problem**:
- Navigation panel header in docs portal had no visual boundary in dark mode
- Header background matched page background (`#0f172a`)
- "Navigation" title and icon blended into the dark background

**Root Cause**:
- Tabler.io CSS specificity overriding custom dark mode header styles
- Bootstrap classes applied broad card header styling
- Custom CSS lacked sufficient specificity to win cascade

**Solution** (`/app/public/docs-html/css/docs-tabler.css:619-634`):
```css
/* Increased specificity with .page-body .card prefix and !important */
[data-bs-theme="dark"] .page-body .card .card-header {
    background-color: var(--hextrackr-surface-2, #1e293b) !important;
    border-bottom: 1px solid var(--bs-border-color, #374151) !important;
}

/* Navigation header title with proper contrast */
[data-bs-theme="dark"] .page-body .card .card-header .card-title {
    color: var(--bs-emphasis-color, #f1f5f9) !important;
}

/* Navigation header icon with proper contrast */
[data-bs-theme="dark"] .page-body .card .card-header .icon {
    color: var(--bs-emphasis-color, #f1f5f9) !important;
    opacity: 0.8;
}
```

**Result**:
- Clear visual separation between navigation header and content
- Proper contrast for header text and icon
- Consistent styling with other HexTrackr cards
- Light mode unaffected

---

### Known Limitations

**Mermaid Diagram Theme Refresh**:
- Diagrams maintain their original theme colors after toggling light/dark mode until page refresh
- This is an acceptable edge case as users rarely toggle themes from the documentation portal
- Theme preference is typically set once during initial login and persists
- Fixing would require significant architectural changes to the documentation generation system

---

**Files Modified**:
- `app/public/docs-source/architecture/database.md` - Fixed Mermaid diagram fence (line 185)
- `app/public/docs-html/index.html` - Removed Prism CDN stylesheet, added autoloader config (lines 60, 151-156)
- `app/public/docs-html/js/docs-portal-v2.js` - Added custom code renderer for Prism (lines 1280-1299)
- `app/public/docs-html/css/docs-tabler.css` - Increased navigation header specificity (lines 619-634)
- `app/public/docs-html/content/` - Regenerated HTML from updated markdown sources

**Issues**:
- [HEX-166](https://linear.app/hextrackr/issue/HEX-166) - Mermaid diagram syntax error in database documentation
- [HEX-167](https://linear.app/hextrackr/issue/HEX-167) - Code block syntax highlighting missing in dark mode
- [HEX-177](https://linear.app/hextrackr/issue/HEX-177) - Navigation header lacks visual boundary in dark mode

---

**Version**: 1.0.60
**Last Updated**: 2025-10-10
