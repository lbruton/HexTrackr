---
title: "Version 1.0.86 - Location Filter: Backend-Driven Filtering Across All Views"
date: "2025-10-18"
version: "1.0.86"
status: "Released"
category: "Enhancement"
---

# Version 1.0.86 - Location Filter: Backend-Driven Filtering Across All Views

**Release Status**: ✅ Released
**Release Date**: 2025-10-18
**Category**: Enhancement

## Overview

Implements a comprehensive location filtering system with backend-driven hostname parsing and normalized location matching. The location filter dropdown works seamlessly across all 4 views (Devices, Vulnerabilities, Table, Locations) with improved data quality and edge case handling.

## New Features

### Location Filter Dropdown
- **Global Filter Control**: New location dropdown in the filter bar (next to Severity and Vendor filters)
- **Backend-Driven**: Populated from `/api/locations/stats` with only locations that have active vulnerabilities
- **Normalized Display**: Location aliases automatically normalized (wtuls → WTULSA, strou → STROUD)
- **Cross-View Filtering**: Filters all 4 views simultaneously when a location is selected
- **State Persistence**: Selected location persists when switching between views

### Improved Hostname Parsing

#### Regex Pattern Support
- Added support for complex regex patterns in device type matching
- Pattern `ns\d+com01` now correctly matches VLAN interfaces like `tulns27com01-vlan27`
- Enables more precise hostname parsing for edge cases

#### Location Normalization
- New `normalizeLocation()` method handles location aliases
- Aliases automatically mapped to canonical names:
  - `wtuls` → `wtulsa`
  - `strou` → `stroud`
  - `tulsatwr` → `tulsatower`
- Case-insensitive matching across all filters

### Enhanced API Responses
- Added `normalized_location` field to vulnerability API (`/api/vulnerabilities`)
- Each vulnerability now includes parsed and normalized location for client-side filtering
- Consistent location data across all views

## Bug Fixes

### Data Quality Issues
- **Fixed**: Location cards showing devices with no active vulnerabilities
  - Added `lifecycle_state IN ('active', 'reopened')` filter to location aggregation
  - Ensures only active/reopened vulnerabilities contribute to location statistics
  - Eliminates "ghost locations" from resolved vulnerabilities

- **Fixed**: TULNS appearing as separate location
  - Was: `tulns27com01` → location="tulns" (incorrect)
  - Now: `tulns27com01` → location="tul" (correct via regex pattern)

### Hostname Parsing Edge Cases
- **Fixed**: `barnsdnfpan01` parsing as "bar" instead of "barns"
  - Removed dangerous generic "ns" pattern (precedence 5)
  - Added specific "dnfpan" pattern (precedence 7)
  - Result: Correctly extracts location="barns"

- **Fixed**: `tulnfdevpan01` parsing as "tulnf" instead of "tul"
  - Added specific "nfdevpan" pattern (precedence 9)
  - Pattern matches before generic "devpan" (precedence 14)
  - Result: Correctly extracts location="tul"

### UI/UX Issues
- **Fixed**: Location dropdown resets when switching to Locations view
  - Dropdown selection now preserved during lazy loading
  - Current filter automatically applied after location cards data loads

- **Fixed**: Case sensitivity issues in location filtering
  - All comparisons now use uppercase normalization
  - Dropdown values match display names (ELPASO, ALLEN, etc.)
  - Consistent filtering across all views

- **Fixed**: Filter dropdowns different sizes
  - All three filter dropdowns now uniform 140px width
  - Severity, Vendor, and Location filters visually balanced

## Technical Details

### Backend Changes

**Files Modified**:
- `app/services/hostnameParserService.js` - Regex matching, location normalization
- `app/services/vulnerabilityService.js` - API enrichment with normalized_location
- `app/services/locationService.js` - Added lifecycle_state filter
- `config/device-naming-patterns.json` - Removed generic patterns, added specific ones

**Device Naming Pattern Updates**:
```json
// Removed (Too Generic - Caused False Matches):
{ "pattern": "ns", "precedence": 5 }   // ❌ Removed
{ "pattern": "com", "precedence": 6 }  // ❌ Removed

// Added (Specific - Correct Matches):
{ "pattern": "ns\\d+com01", "precedence": 5 }  // ✅ VLAN interfaces
{ "pattern": "dnfpan", "precedence": 7 }       // ✅ Dev firewalls
{ "pattern": "nfdevpan", "precedence": 9 }     // ✅ Network FW dev
```

### Frontend Changes

**Files Modified**:
- `app/public/vulnerabilities.html` - Added location filter dropdown
- `app/public/scripts/shared/vulnerability-data.js` - Location filtering logic
- `app/public/scripts/shared/vulnerability-search.js` - Event coordination
- `app/public/scripts/shared/vulnerability-core.js` - Dropdown population, state management
- `app/public/scripts/shared/location-cards.js` - Location card filtering
- `app/public/styles/pages/vulnerabilities.css` - Filter dropdown sizing

**Key Implementation Details**:
```javascript
// Location filter dropdown populated on page load
async loadLocationFilterData() {
    const response = await authState.authenticatedFetch("/api/locations/stats");
    const result = await response.json();
    this.populateLocationFilter(result.data);
}

// Filter preserves selection when switching views
if (locationFilter && locationFilter.value) {
    locationCardsManager.applyLocationFilter(locationFilter.value);
}

// Case-insensitive comparison
const vulnLocation = (vuln.normalized_location || '').toUpperCase();
const filterLocation = currentLocationFilter.toUpperCase();
matchesLocation = vulnLocation === filterLocation;
```

## Database Schema

No database schema changes in this release.

## Migration Notes

### Automatic
- No manual migration required
- Hostname parsing improvements apply automatically on page load
- Existing data re-parsed with new patterns

### Configuration
The following device naming patterns were updated in `config/device-naming-patterns.json`:
- Generic patterns "ns" and "com" removed
- Specific patterns added for edge cases
- Precedence values renumbered (1-18)

If you have custom hostname patterns, review the updated configuration file.

## API Changes

### Modified Endpoints

**GET /api/vulnerabilities**
- **Added Field**: `normalized_location` (string)
- **Purpose**: Normalized location extracted from hostname for filtering
- **Example**:
  ```json
  {
    "hostname": "wtulnswan01",
    "normalized_location": "wtulsa"
  }
  ```

**GET /api/locations/stats**
- **Modified**: Now filters by `lifecycle_state IN ('active', 'reopened')`
- **Impact**: Only locations with active vulnerabilities appear in response
- **Breaking**: Previously included resolved vulnerabilities

## Testing

### Verified Functionality
- ✅ Location dropdown populates on page load
- ✅ Selecting location filters all 4 views (Devices, Vulnerabilities, Table, Locations)
- ✅ Filter persists when switching between views
- ✅ Works in combination with search box, severity, and vendor filters
- ✅ Case-insensitive matching (ALLEN, allen, Allen all work)
- ✅ Location normalization (selecting WTULSA shows wtuls and wtulsa hostnames)

### Hostname Parsing Test Cases
| Hostname | Before | After | Status |
|----------|--------|-------|--------|
| `barnsdnfpan01` | location="bar" ❌ | location="barns" ✅ | Fixed |
| `tulnfdevpan01` | location="tulnf" ❌ | location="tul" ✅ | Fixed |
| `tulns27com01-vlan27` | location="tulns" ❌ | location="tul" ✅ | Fixed |
| `wtulnswan01` | location="wtuls" → "wtulsa" ✅ | location="wtulsa" ✅ | Improved |
| `stroudnrwan01` | location="strou" → "stroud" ✅ | location="stroud" ✅ | Improved |

## Performance Impact

- **Minimal**: Location dropdown populated once on page load (cached)
- **Efficient**: Client-side filtering using pre-computed normalized_location field
- **Optimized**: Location cards use display name matching (no complex parsing)

## Known Issues

None reported.

## Upgrade Instructions

### Standard Deployment
1. Pull latest code from `dev` branch
2. Restart Docker container: `docker-compose restart hextrackr`
3. Clear browser cache and hard refresh (Ctrl+Shift+R)

### Verify Installation
1. Navigate to Vulnerabilities page
2. Check that location dropdown appears next to Vendor filter
3. Select a location from dropdown
4. Verify all 4 views (Devices, Vulnerabilities, Table, Locations) filter correctly
5. Switch between views and confirm filter persists

## Related Issues

**Git Commit**: `bada4650` - feat: Add location filter dropdown with normalized hostname parsing

## Contributors

- Implementation: Claude Code
- Testing & Requirements: User

## Notes

This release focuses on improving data quality and user experience for location-based filtering. The backend-driven architecture ensures consistent filtering across all views while maintaining performance.

The hostname parsing improvements fix long-standing edge cases that caused incorrect location extraction for specific device naming patterns.
