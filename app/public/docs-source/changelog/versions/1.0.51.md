# Version 1.0.51

**Release Date**: 2025-10-06

---

## [1.0.51] - 2025-10-06

### Added

#### Browser Storage â†’ Database Migration (HEX-138)

**Feature**: Hybrid caching architecture combining localStorage (fast synchronous cache) with database-backed persistence for cross-device preferences sync.

**Architecture**:
- **localStorage**: Remains the fast synchronous cache for immediate UI responsiveness
- **Database**: Provides persistent storage with cross-device synchronization
- **Sync Bridge**: `preferences-sync.js` bidirectionally syncs between cache and database
- **Security**: Sensitive credentials (Cisco API keys) bypass localStorage entirely

**Implementation Phases**:

**Phase 1 - Backend Foundation**:
- Created `user_preferences` table with foreign key to users table
- Implemented `preferences-service.js` backend with CRUD operations
- Added `/api/preferences` endpoints (GET, POST for single/bulk operations)
- Migration file: `006-user-preferences.sql`

**Phase 2 - Frontend Service**:
- Created `preferences-service.js` frontend client with fetch API calls
- Implemented CSRF-protected API communication
- Added error handling and fallback to localStorage-only mode

**Phase 3 - Preference Migration (6 Tasks)**:
1. **Theme Preferences**: Dark/light mode synced across all pages
2. **Markdown Templates**: Ticket and vulnerability templates (persistent editing)
3. **Pagination Settings**: Enable/disable pagination preference
4. **Global Settings**: Skipped (incomplete legacy feature)
5. **KEV Auto-Refresh**: CISA KEV sync preference with debounced updates
6. **Cisco Credentials** (SECURITY PRIORITY): Client ID + Client Secret stored database-only

**Phase 4 - Testing & Documentation**:
- Verified theme sync across login, docs portal, and main app pages
- Confirmed cross-device persistence via database storage
- Validated security: Cisco credentials never touch localStorage

**Sync Mechanism**:
- Debounced writes (1-second delay) to prevent API rate limiting
- Immediate sync for security-critical data (credentials)
- Auto-load preferences from database on app initialization
- Fallback to localStorage-only mode if database unavailable

**Files Added/Modified**:
- `app/public/scripts/init-database.js` - Added user_preferences table
- `app/services/preferences-service.js` - Backend service layer (NEW)
- `app/routes/preferences.js` - API endpoints (NEW)
- `app/public/scripts/shared/preferences-service.js` - Frontend client (NEW)
- `app/public/scripts/shared/preferences-sync.js` - Sync bridge (NEW)
- `app/public/scripts/shared/settings-modal.js` - Enhanced with Cisco credential handling

**Database Schema**:
```sql
CREATE TABLE user_preferences (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT NOT NULL,
  preference_key TEXT NOT NULL,
  preference_value TEXT NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  UNIQUE(user_id, preference_key)
);
```

**Result**: Users now enjoy seamless preference synchronization across devices while maintaining fast UI performance through localStorage caching. Sensitive API credentials are securely stored in the database with proper isolation from browser storage.

---