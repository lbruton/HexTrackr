# Version 1.0.35

**Release Date**: 2025-09-30

---

## [1.0.35] - 2025-09-30

### Fixed (6)

#### HEX-90: Ticket Field Clearing Bug - Nullish Coalescing Operator Fix

**Issue**: Users could not clear optional ticket fields (notes, status, location, supervisor, tech, site) when updating tickets. Sending empty strings or null values silently kept the previous value in the database.

**Root Cause**: The `updateTicket` method in `ticketService.js` used the `||` (logical OR) operator for field merging:
```javascript
// ❌ BEFORE - || treats ANY falsy value as "use fallback"
const payload = {
    notes: ticket.notes || existingTicket.notes,
    status: ticket.status || existingTicket.status,
    // ... empty strings ("") kept old values
};
```

The `||` operator treats ALL falsy values as "use fallback":

- Empty string `""` → falsy → uses old value ❌
- `null` → falsy → uses old value ❌
- `undefined` → falsy → uses old value ✅
- `0` → falsy → uses old value ❌
- `false` → falsy → uses old value ❌

**Solution**: Replaced `||` with `??` (nullish coalescing) for optional fields:
```javascript
// ✅ AFTER - ?? only falls back on null/undefined
const payload = {
    // Optional fields - use ?? to allow clearing with empty strings
    hexagonTicket: ticket.hexagonTicket ?? ticket.hexagon_ticket ?? existingTicket.hexagon_ticket,
    serviceNowTicket: ticket.serviceNowTicket ?? ticket.service_now_ticket ?? existingTicket.service_now_ticket,
    location: ticket.location ?? existingTicket.location,
    supervisor: ticket.supervisor ?? existingTicket.supervisor,
    tech: ticket.tech ?? existingTicket.tech,
    status: ticket.status ?? existingTicket.status,
    notes: ticket.notes ?? existingTicket.notes,
    site: ticket.site ?? existingTicket.site,
    site_id: ticket.site_id ?? existingTicket.site_id,
    location_id: ticket.location_id ?? existingTicket.location_id,

    // Required fields - keep || to prevent empty values
    dateSubmitted: ticket.dateSubmitted || ticket.date_submitted || existingTicket.date_submitted,
    dateDue: ticket.dateDue || ticket.date_due || existingTicket.date_due,
    devices: ticket.devices || existingTicket.devices,
    attachments: ticket.attachments || existingTicket.attachments,
};
```

**Operator Comparison**:

- `||` (Logical OR): Falls back on ANY falsy value (prevents `""`, `0`, `false`)
- `??` (Nullish Coalescing): Falls back ONLY on `null` or `undefined` (allows `""`, `0`, `false`)

**Files Modified**:

- `app/services/ticketService.js` (lines 148-195) - Updated `updateTicket` method with ?? operators and comprehensive JSDoc
- Added JSDoc documentation explaining operator choice for future maintainers

**Impact**:

- Users can now clear optional fields by sending empty strings
- UI shows cleared field and database reflects the change
- No breaking changes to required field validation
- Discovered during Codacy review of PR #59 (WebSocket CORS fix)

**User Experience**:

- Before: Silent failures when clearing fields (UI shows cleared, DB keeps old value)
- After: Fields clear successfully (UI and DB synchronized)
- No error messages needed - clearing now works as expected

**Testing**:

- All linters passed (ESLint, Stylelint, Markdownlint)
- Docker container tested and running on port 8989
- Verified field clearing for all 9 optional fields

### Added (5)

#### Trust Proxy Configuration for Nginx Reverse Proxy

**Purpose**: Enable proper client IP detection and rate limiting when running behind nginx reverse proxy

**Implementation**:

- Added `TRUST_PROXY` environment variable to configure Express trust proxy setting
- Updated `app/public/server.js` (lines 48-52) with conditional proxy trust configuration
- Updated `.env.example` with documentation for production deployment

**Configuration**:
```javascript
// Trust proxy when behind nginx (enables proper client IP detection)
if (process.env.TRUST_PROXY === "true") {
    app.set("trust proxy", 1);
}
```

**Benefits**:

- Rate limiting works correctly with real client IPs (not nginx IP)
- Eliminates ValidationError logs from proxy forwarding
- Enables Cache-Control header optimization
- Ready for Claude-Prod to enable with `TRUST_PROXY=true`

**Linear Issue**: [HEX-90](https://linear.app/hextrackr/issue/HEX-90)

---