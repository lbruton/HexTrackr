---
title: "Version 1.1.11 - Database Schema Cleanup & Backup System Fixes"
date: "2025-10-31"
version: "1.1.11"
status: "Released"
category: "Bug Fix"
---

# Version 1.1.11 - Database Schema Cleanup & Backup System Fixes

**Release Status**: ✅ Released
**Release Date**: 2025-10-31
**Parent Issues**: [HEX-359](https://linear.app/hextrackr/issue/HEX-359), [HEX-349](https://linear.app/hextrackr/issue/HEX-349)

## Overview

Fixed critical vulnerability backup/restore system bugs that prevented 95K+ record recovery, and removed legacy `vulnerabilities` table from schema to complete HEX-300 rollover architecture migration. This release ensures data integrity during backup/restore operations and eliminates technical debt from unused database tables.

---

## [1.1.11]

### Fixed

#### Critical Backup/Restore System Bugs (HEX-359) - 2025-10-31

**Description**: Fixed four critical bugs in the vulnerability backup/restore system that would have caused catastrophic data loss during production recovery scenarios.

**Problems Solved**:
1. Wrong table name - restore was inserting into legacy `vulnerabilities` instead of `vulnerabilities_current`
2. Missing chunked file support - couldn't restore datasets split into chunks (95K+ records hit JSON.stringify 500MB limits)
3. Incomplete restore - only restored main vulnerability table, missing 9 related tables
4. Incomplete clear - `clearAllData()` only cleared 6 tables, missing 4 vendor/advisory tables causing duplicates on restore

**Root Cause**:
During the HEX-300 rollover architecture migration, the backup/restore system was never fully updated to handle:
- New `vulnerabilities_current` table name
- Chunked backup files for large datasets (10K records per chunk)
- All 10 exported tables (snapshots, KEV status, Cisco/Palo Alto advisories, vendor totals)

**Technical Fixes**:

1. **Fixed table name in restore** (`app/services/backupService.js:555`)
   ```javascript
   // OLD: INSERT INTO vulnerabilities
   // NEW: INSERT INTO vulnerabilities_current
   ```

2. **Added chunked file support** (`app/services/backupService.js:630-677`)
   - New helper function `_readTableFromZip()` that:
     - Checks for `_chunks_index.json` files first
     - Reads and reassembles all chunk files
     - Falls back to single file if no chunks found
     - Handles both chunked and non-chunked backups

3. **Comprehensive restore logic** (`app/services/backupService.js:508-705`)
   - Now restores all 10 tables:
     - `vulnerabilities_current` (main data)
     - `vulnerabilities_affected_devices` (device mappings)
     - `vulnerabilities_affected_locations` (location mappings)
     - `vulnerabilities_snapshots_history` (historical snapshots)
     - `vendor_daily_totals` (vendor aggregation)
     - `cisco_advisories` (Cisco PSIRT data)
     - `cisco_fixed_versions` (Cisco version mappings)
     - `palo_alto_advisories` (Palo Alto bulletins)
     - `kev_status` (CISA KEV correlations)
     - `daily_totals` (trend aggregation)

4. **Complete clear operation** (`app/services/vulnerabilityService.js:522-550`)
   - Added 4 missing DELETE statements:
   ```javascript
   this.db.run("DELETE FROM vendor_daily_totals");
   this.db.run("DELETE FROM cisco_advisories");
   this.db.run("DELETE FROM palo_alto_advisories");
   this.db.run("DELETE FROM kev_status");
   ```

**Files Modified**:
- `app/services/backupService.js` (lines 400-705)
- `app/services/vulnerabilityService.js` (lines 522-550)

**Validation**:
- ✅ Chunked file support working for 95K+ vulnerability records
- ✅ All 10 exported tables restored successfully
- ✅ Clear operation prevents duplicates by clearing all related tables
- ✅ Ready for production backup/restore validation

**Issues**:
- [HEX-359](https://linear.app/hextrackr/issue/HEX-359) - Fix Incomplete Vulnerability Backup/Restore System

---

### Changed

#### Removed Legacy Vulnerabilities Table (HEX-349) - 2025-10-31

**Description**: Removed unused legacy `vulnerabilities` table from schema, completing the HEX-300 rollover architecture migration and eliminating technical debt.

**Background**:
- Legacy `vulnerabilities` table: 0 rows, NOT backed up by BackupService, no production queries
- Active table: `vulnerabilities_current` - all production code uses this
- Junction table: `ticket_vulnerabilities` - had FK to legacy table (now updated to reference `vulnerabilities_current`)

**Schema Changes**:

1. **databaseService.js**
   - ❌ Removed: `CREATE TABLE vulnerabilities`
   - ✅ Updated: `ticket_vulnerabilities` foreign key now references `vulnerabilities_current`

2. **init-database.js**
   - ❌ Removed: `CREATE TABLE vulnerabilities`
   - ✅ Updated: `ticket_vulnerabilities` foreign key now references `vulnerabilities_current`
   - ✅ Renumbered: All subsequent table comments (5→4, 6→5, etc.)

3. **init-database-v1.1.0.js**
   - ❌ Removed: `CREATE TABLE vulnerabilities`
   - ✅ Updated: `ticket_vulnerabilities` foreign key now references `vulnerabilities_current`
   - ✅ Renumbered: All subsequent table comments (TABLE 5→4 through TABLE 21→20)

4. **vulnerabilityService.js**
   - ❌ Removed line 529: `DELETE FROM vulnerabilities` (clearAllData function)
   - ❌ Removed lines 586-590: `DELETE FROM vulnerabilities` query object (deleteVulnerabilities function)

**Seed Database Rebuild**:
- ✅ Generated new seed at `app/data/hextrackr.seed.db`
- ✅ Dropped legacy `vulnerabilities` table from seed
- ✅ Ran VACUUM to compact database
- ✅ Regenerated SHA-256 checksum: `0d53b020094f91977c83cad9e956e28f15753d0f172235c3162045c992d273b2`
- ✅ Verified: 21 tables (down from 22)
- ✅ Confirmed: Only `vulnerabilities_current` exists, no legacy `vulnerabilities` table

**Files Modified**:
- `app/services/databaseService.js`
- `app/public/scripts/init-database.js`
- `app/public/scripts/init-database-v1.1.0.js`
- `app/services/vulnerabilityService.js`
- `app/data/hextrackr.seed.db` (rebuilt clean)
- `app/data/hextrackr.seed.db.sha256` (new checksum)

**Validation**:
- ✅ Legacy table removed from all schema files
- ✅ Foreign key updated to reference correct table
- ✅ Legacy DELETE operations removed
- ✅ Seed database contains only modern schema (21 tables)
- ✅ No references to legacy table remain in codebase

**Future Ready**:
- Junction table `ticket_vulnerabilities` preserved with updated FK
- Ready for future mitigation tracking feature (currently in SRPI research phase)

**Issues**:
- [HEX-349](https://linear.app/hextrackr/issue/HEX-349) - Deprecate legacy `vulnerabilities` table - migrate to rollover architecture

---

## Notes

### Key Learning

**Pattern Identified**: When migrating to new architecture, always audit old schema files and remove unused tables to prevent confusion and technical debt.

**Critical Discovery**: The backup system was silently failing to restore 95K+ vulnerability records due to missing chunked file support. This would have caused catastrophic data loss in a production recovery scenario. Always validate backup/restore functionality after architectural changes.

### Performance Improvements

- Reduced seed database size: 21 tables (down from 22)
- Cleaned up 6 files with legacy table references
- Simplified restore logic by removing unnecessary fallback paths
- Improved data integrity by ensuring complete table cleanup before restore

### Security Improvements

- Backup/restore system now handles large datasets without memory overflow
- All related tables properly cleared before restore to prevent data corruption
- Junction table foreign keys now reference correct active table

---

*Changelog Entry: v1.1.11 | HEX-359 Backup/Restore Fixes + HEX-349 Legacy Table Removal*
