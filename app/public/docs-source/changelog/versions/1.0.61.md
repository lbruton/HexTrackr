# Version 1.0.61

**Release Date**: 2025-10-10
**Type**: Feature Release
**Linear Issue**: [HEX-190](https://linear.app/hextrackr/issue/HEX-190) - Device Ticket Power Tool

---

## üéØ New Features

### Device Ticket Auto-Population Power Tool
**Three keyboard shortcut modes for rapid ticket creation from vulnerability cards:**

- **Mode 1 (Single Device)**: Regular click
  - Auto-populates SITE (4 chars), Location (5 chars), and hostname
  - All fields formatted in **ALL CAPS** for consistency

- **Mode 2 (KEV Devices)**: Cmd+Shift+Click (Mac) or Ctrl+Shift+Click (Windows)
  - Auto-populates **all KEV devices** at the same location (first 5 characters match)
  - Filters by `device.hasKev === true` property
  - Perfect for prioritizing Known Exploited Vulnerabilities

- **Mode 3 (All Devices)**: Alt+Shift+Click
  - Auto-populates **all devices** at the same location (first 5 characters match)
  - Ideal for site-wide maintenance tickets

**Key Enhancements:**
- JSON sessionStorage structure with device arrays, site, location, and mode metadata
- Case-insensitive hostname comparison (works with lowercase, uppercase, or mixed case)
- Autofill conflict resolution prevents power tool data from triggering location-to-device autofill
- Backward compatibility maintained for existing single-device workflow
- Enhanced toast messages show device count and mode

---

## üêõ Bug Fixes

### Soft Delete + XT# Uniqueness (HEX-196)
**Critical data integrity fix preventing duplicate ticket numbers and lost audit trail:**

**Root Causes:**
1. Hard `DELETE` operations destroyed ticket records, losing audit trail
2. Deleted XT# numbers were reused, creating duplicate ticket IDs in history
3. Frontend calculated XT# client-side using only active tickets (excluded deleted)
4. Database UNIQUE constraint on `xt_number` column blocked soft delete functionality

**Solution Implemented:**
- **Soft Delete Pattern**: Changed `DELETE FROM tickets` to `UPDATE SET deleted=1, deleted_at=now()`
- **Database Migration 004**: Added `deleted` (INTEGER) and `deleted_at` (TEXT) columns with index
- **Database Migration 005**: Rebuilt table to remove column-level UNIQUE constraint, added partial UNIQUE index (`WHERE deleted = 0`)
- **Backend API**: Created `GET /api/tickets/next-xt-number` endpoint (includes ALL tickets in max calculation)
- **Frontend Refactor**: Modified `generateNextXtNumber()` to call backend API, removed fallback logic
- **Application Validation**: Added duplicate XT# check before INSERT with detailed error message
- **Query Filters**: Added `WHERE deleted = 0` to getAllTickets, exportTickets, getTicketById

**Impact:**
- ‚úÖ Audit trail preserved for compliance (tickets never truly deleted)
- ‚úÖ XT# uniqueness guaranteed for database lifetime (no number reuse)
- ‚úÖ Accidental deletes recoverable (future admin UI can restore)
- ‚úÖ ServiceNow references remain valid (foreign key integrity)

**Files Modified:**
- `app/public/scripts/migrations/004-soft-delete-tickets.sql` (new)
- `app/public/scripts/migrations/005-remove-xt-unique-constraint.sql` (new)
- `app/services/ticketService.js` (soft delete + validation)
- `app/routes/tickets.js` (new endpoint)
- `app/controllers/ticketController.js` (new method)
- `app/public/scripts/pages/tickets.js` (async API call, no fallback)

---

### Clone 3 Testing Phase Fixes (HEX-190)
During comprehensive testing, Clone 3 (Testing Specialist) identified and fixed 5 bugs:

1. **Event Bubbling**: Create Ticket button click was propagating to parent card's onclick handler
   - **Fix**: Added `event.stopPropagation()` before method call in onclick attribute
   - **File**: `vulnerability-cards.js:259`

2. **Method Path Error**: `vulnManager.handleCreateTicketClick is not a function`
   - **Fix**: Corrected path to `vulnManager.cardsManager.handleCreateTicketClick()`
   - **File**: `vulnerability-cards.js:259`

3. **Parameter Forwarding**: Delegation wrapper in `vulnerabilities.js` dropped options parameter
   - **Fix**: Updated `createTicketFromDevice(hostname, options = null)` to forward both parameters
   - **File**: `vulnerabilities.js:101-102`

4. **Case Sensitivity**: Hostname comparison failed when device data case didn't match
   - **Fix**: Implemented case-insensitive comparison using `.toLowerCase()` in filters
   - **File**: `vulnerability-cards.js:83, 95`

5. **Wrong Property**: Used non-existent `device.kevCount` instead of `device.hasKev`
   - **Fix**: Changed filter to `device.hasKev === true`
   - **File**: `vulnerability-cards.js:83`

---

## üìù Implementation Details

### Modified Files
- `app/public/scripts/shared/vulnerability-cards.js` - Keyboard modifier detection and filtering
- `app/public/scripts/shared/vulnerability-core.js` - JSON sessionStorage creation
- `app/public/scripts/pages/vulnerabilities.js` - Parameter forwarding fix
- `app/public/scripts/pages/tickets.js` - JSON parsing and multi-device population

### Technical Architecture
- **Delegation Chain**: `cardsManager.handleCreateTicketClick()` ‚Üí `componentContext.createTicketFromDevice()` ‚Üí `coreOrchestrator.createTicketFromDevice()`
- **sessionStorage Format**: JSON object with `{devices: [], site: "", location: "", mode: "", timestamp: number}`
- **Fallback Support**: Old format (`createTicketDevice` string) maintained for backward compatibility

---

## üß™ Testing

**Test Environment**: dev.hextrackr.com (Mac M4 Docker)
**Test Site**: GRIMES location (5 KEV devices, 1 non-KEV device)
**Test Results**: All three modes validated and working correctly

**Keyboard Shortcuts Tested:**
- ‚úÖ Single click ‚Üí Populates 1 device with SITE/Location
- ‚úÖ Cmd+Shift+Click ‚Üí Populates 5 KEV devices at GRIMES
- ‚úÖ Alt+Shift+Click ‚Üí Populates all 6 devices at GRIMES

---

## üë• Contributors

- **Clone 2** (Implementation): Delegated to `hextrackr-fullstack-dev` agent for code implementation
- **Clone 3** (Testing & Bug Fixes): Comprehensive testing and 5 bug fixes via iterative debugging
- **Lonnie B.** (Planning & Review): SRPI workflow coordination, changelog documentation

---

## üîó Related Issues

### Device Ticket Power Tool (HEX-190)
- **Parent**: [HEX-190](https://linear.app/hextrackr/issue/HEX-190) - SPECIFICATION: Device Ticket Power Tool
- **Research**: [HEX-191](https://linear.app/hextrackr/issue/HEX-191) - RESEARCH: Device Ticket Power Tool
- **Planning**: [HEX-192](https://linear.app/hextrackr/issue/HEX-192) - PLAN: Device Ticket Power Tool
- **Implementation**: [HEX-193](https://linear.app/hextrackr/issue/HEX-193) - IMPLEMENT: Device Ticket Power Tool

### Soft Delete + XT# Uniqueness Fix
- **Bug Fix**: [HEX-196](https://linear.app/hextrackr/issue/HEX-196) - Soft Delete + XT# Duplicate Bug Fix

---

## üìö Documentation

See [User Guide: Power Tools](../guides/power-tools.md) for detailed keyboard shortcut reference and usage examples.
