---
title: "Version 1.0.79 - Cisco Advisory: Fix Multi-OS-Family Data Corruption"
date: "2025-10-17"
version: "1.0.79"
status: "Released"
category: "Bug Fix"
---

# Version 1.0.79 - Cisco Advisory: Fix Multi-OS-Family Data Corruption

**Release Status**: ✅ Released
**Release Date**: 2025-10-17
**Parent Issue**: [HEX-287](https://linear.app/hextrackr/issue/HEX-287)
**Implementation**: [HEX-287](https://linear.app/hextrackr/issue/HEX-287) Session 1

## Overview

Fixed critical bug where Cisco advisory data was being overwritten during sync, causing multi-OS-family CVEs (affecting both IOS and IOS XE) to lose fixed version data. Implemented normalized database schema to prevent data loss and added proper train family filtering.

## Critical Bug Fixed

### Problem
- **Symptom**: Cisco advisory fixed versions disappearing after sync
- **Impact**: IOS devices showing IOS XE fixed versions (wrong OS type)
- **Root Cause**: Multi-OS-family CVEs stored in denormalized JSON array, causing last-write-wins overwrites

**Example**:
```json
// Before fix - denormalized (BAD)
{
  "cve_id": "CVE-2025-20352",
  "first_fixed": ["15.2(8)E8"]  // After IOS sync
}
// After IOS XE sync - IOS data LOST!
{
  "cve_id": "CVE-2025-20352",
  "first_fixed": ["17.12.6"]  // IOS data overwritten
}
```

### Solution

**Normalized Schema** (Third Normal Form):
```sql
-- One row per CVE (metadata only)
CREATE TABLE cisco_advisories (
    cve_id TEXT PRIMARY KEY,
    advisory_id TEXT,
    advisory_title TEXT,
    ...
);

-- Many rows per CVE (one per OS family + version)
CREATE TABLE cisco_fixed_versions (
    id INTEGER PRIMARY KEY,
    cve_id TEXT NOT NULL,
    os_family TEXT NOT NULL,      -- "ios", "iosxe", "iosxr", "nxos"
    fixed_version TEXT NOT NULL,
    FOREIGN KEY (cve_id) REFERENCES cisco_advisories(cve_id),
    UNIQUE(cve_id, os_family, fixed_version)
);
```

**Result**: CVE-2025-20352 now has multiple preserved rows:
```
cve_id            | os_family | fixed_version
------------------|-----------|---------------
CVE-2025-20352    | ios       | 15.2(8)E8
CVE-2025-20352    | ios       | 15.9(3)M11
CVE-2025-20352    | iosxe     | 17.12.6
```

## Implementation Details

### Backend Changes

**Migration 007** (`app/public/scripts/migrations/007-normalize-cisco-fixed-versions.sql`):
- Created `cisco_fixed_versions` table with proper foreign key constraints
- Migrated existing data from JSON arrays to normalized rows
- Added unique constraint to prevent duplicate entries

**Service Layer** (`app/services/ciscoAdvisoryService.js` lines 665-743):
- **Three-step sync process**:
  1. Insert/update advisory metadata (one row per CVE)
  2. Insert fixed versions (many rows per CVE)
  3. Update flags (is_cisco_advisory, etc.)
- Changed from `INSERT OR REPLACE` to `INSERT ... ON CONFLICT DO UPDATE`
- Added `getFixedVersions(cveId, osFamily)` method for querying by OS family

**API Endpoint** (`app/routes/cisco.js` line 39-41):
```javascript
GET /api/cisco/fixed-versions/:cveId?os_family=ios
```

### Frontend Changes

**Train Family Normalization** (`app/public/scripts/shared/cisco-advisory-helper.js`):

Fixed critical bug where SE-train devices matched Service Provider (S) fixes instead of Enterprise (E) fixes.

**Train Family Mapping**:
```javascript
// Enterprise family variants
"E"   → "E"
"EA"  → "E"  // Early Adoption
"ED"  → "E"  // Extended Delivery
"SE"  → "E"  // Switching Enterprise (NOT Service Provider!)
"SG"  → "E"  // Security Gateway

// Mainline family variants
"M"   → "M"
"MA"  → "M"

// Service Provider family variants
"S"   → "S"  // NOT "SE" or "SG"!
"SA"  → "S"
```

**Updated Methods**:
- `matchFixedVersion()` - Now uses train family normalization instead of first-letter matching
- `normalizeTrainFamily()` - Maps train variants to base families
- `compareVersions()` - Enhanced to handle both IOS train notation and IOS XE clean format

### Version Matching Workflow

**Example**: Device with `"CISCO IOS 15.2(4)SE5"` affected by `CVE-2025-20352`

1. **Parse OS Type**: `"CISCO IOS 15.2(4)SE5"` → OS family = `"ios"`
2. **Fetch from API**: `GET /api/cisco/fixed-versions/CVE-2025-20352?os_family=ios`
3. **Response**: `["15.2(8)E8", "15.9(3)M11", "15.1(2)SG8"]`
4. **Extract Train**: `"15.2(4)SE5"` → train = `"SE"`
5. **Normalize Train**: `"SE"` → family = `"E"` (Enterprise)
6. **Filter Array**:
   - `"15.2(8)E8"` → train=`"E"`, family=`"E"` → ✅ MATCH
   - `"15.9(3)M11"` → train=`"M"`, family=`"M"` → ❌ NO MATCH
   - `"15.1(2)SG8"` → train=`"SG"`, family=`"E"` → ✅ MATCH
7. **Result**: `["15.2(8)E8", "15.1(2)SG8"]` (E-family only)
8. **Return**: `"15.2(8)E8"` (highest E-family version)

## Files Modified

### Backend
- `app/services/ciscoAdvisoryService.js` (lines 665-860)
  - Three-step sync process
  - `getFixedVersions()` method
- `app/controllers/ciscoController.js`
  - `getFixedVersions()` endpoint handler
- `app/routes/cisco.js` (lines 39-41)
  - New `/fixed-versions/:cveId` route
- `app/public/scripts/migrations/007-normalize-cisco-fixed-versions.sql` (NEW)
  - Normalized schema migration

### Frontend
- `app/public/scripts/shared/cisco-advisory-helper.js` (lines 199-270)
  - `normalizeTrainFamily()` - Train family mapping
  - `matchFixedVersion()` - Updated to use train normalization
  - `getFixedVersion()` - Updated to use new API endpoint

### Documentation
- `docs/CISCO_ADVISORY_ARCHITECTURE.md` (NEW - 600+ lines)
  - Complete architecture documentation
  - Train family reference guide
  - Common pitfalls and solutions
  - Testing checklist

## Database Schema

### Before (Denormalized)
```sql
CREATE TABLE cisco_advisories (
    cve_id TEXT PRIMARY KEY,
    first_fixed TEXT  -- JSON array: ["15.2(8)E8", "17.12.6"]
);
```

**Problem**: Multi-OS-family CVEs overwrite each other.

### After (Normalized)
```sql
CREATE TABLE cisco_advisories (
    cve_id TEXT PRIMARY KEY,
    advisory_id TEXT,
    advisory_title TEXT,
    severity TEXT,
    ...
);

CREATE TABLE cisco_fixed_versions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    cve_id TEXT NOT NULL,
    os_family TEXT NOT NULL,
    fixed_version TEXT NOT NULL,
    affected_version TEXT,
    last_synced TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (cve_id) REFERENCES cisco_advisories(cve_id) ON DELETE CASCADE,
    UNIQUE(cve_id, os_family, fixed_version)
);
```

**Result**: No more overwrites. Each OS family's data preserved independently.

## Success Criteria

- [X] Version bumped to 1.0.79 across 5 files
- [X] Migration 007 creates normalized table successfully
- [X] Backend sync preserves multi-OS-family data (no overwrites)
- [X] Frontend filters by OS family via API parameter
- [X] Frontend filters by train family via normalization
- [X] SE-train devices show E-family fixes (not S-family)
- [X] IOS devices show IOS fixes (not IOS XE)
- [X] IOS XE devices show IOS XE fixes (not IOS)
- [X] Comprehensive architecture documentation created

## Testing Verified

### Test 1: Multi-OS-Family CVE
- ✅ IOS device shows IOS fixed version
- ✅ IOS XE device shows IOS XE fixed version
- ✅ Data persists after re-sync (no overwrites)

### Test 2: Multi-Train CVE (IOS only)
- ✅ E-train device shows E-family version
- ✅ M-train device shows M-family version
- ✅ SE-train device shows E-family version (NOT S-family)

### Test 3: Version Sorting
- ✅ Highest version returned after semantic sort
- ✅ IOS XE clean format handled correctly (`17.12.6`)
- ✅ IOS train notation handled correctly (`15.2(8)E8`)

## Related Issues

- Parent: [HEX-287](https://linear.app/hextrackr/issue/HEX-287) - Cisco advisory data corruption
- Related: [HEX-282](https://linear.app/hextrackr/issue/HEX-282) - Database corruption prevention
- Related: [HEX-204](https://linear.app/hextrackr/issue/HEX-204) - Cisco advisory caching
- Related: [HEX-141](https://linear.app/hextrackr/issue/HEX-141) - Cisco advisory batch optimization

## Breaking Changes

None. Migration automatically converts existing data to normalized schema.

## Known Issues

None.

## Documentation

- **Architecture Guide**: `docs/CISCO_ADVISORY_ARCHITECTURE.md`
- **User Guide**: `app/public/docs-source/guides/cisco-psirt-integration.md`
- **Migration**: `app/public/scripts/migrations/007-normalize-cisco-fixed-versions.sql`
