# Version 1.0.36

**Release Date**: 2025-09-30

---

## [1.0.36] - 2025-09-30

### Performance (2)

#### HEX-91: Optimize HTTPS Performance - 3x Slowdown with 30K Vulnerability Records

**Issue**: After implementing HTTPS with nginx reverse proxy (HEXP-14), the vulnerabilities page loaded 3x slower than direct HTTPS in dev environment. Page load time increased from 2-4 seconds to 6-12 seconds when loading 30,000 vulnerability records.

**Root Causes Identified**:

1. **Double Compression**: Nginx gzip + Express compression middleware both compressing the same response
2. **No Application Cache**: Every request triggered fresh database query for 30K records
3. **Aggressive Browser Cache**: 10-minute browser TTL prevented fresh data after CSV imports
4. **Missing Cache Headers**: No Cache-Control headers for browser-side caching coordination

**Solution - Two-Layer Caching Architecture**:

##### Layer 1: Application-Level Caching (node-cache)

- Implemented aggressive server-side caching with 5-10 minute TTL
- Separate cache zones for statistics and trends data
- Memory footprint: ~5-10MB for 30K records
- Performance: 400-1000ms initial load → 2-5ms cached responses

##### Layer 2: Browser Cache Coordination (Cache-Control headers)

- Right-sized browser cache TTL: 30-60 seconds for fresh data visibility
- Automatic cache invalidation on CSV imports and KEV sync
- X-Cache headers (HIT/MISS) for monitoring and debugging

**Technical Implementation**:

**Files Modified**:

- `app/services/cacheService.js` - New caching service with dual-zone architecture (statistics + trends)
- `app/controllers/vulnerabilityController.js` - Integrated caching for all stats and trends endpoints
- `app/public/server.js` - Conditionally disabled Express compression when `TRUST_PROXY=true`

**Key Innovation - withCaching() Helper**:
```javascript
async withCaching(res, cacheType, cacheKey, serverTTL, handler, browserTTL = null) {
    // Server cache: Aggressive (5-10min) for performance
    // Browser cache: Light (30-60s) for freshness
}
```

**Cache Configuration by Endpoint**:

- Vulnerability Stats: 300s server / 60s browser
- Recent Trends: 600s server / 60s browser
- Historical Trends: 600s server / 60s browser
- Vulnerabilities List: 600s server / 30s browser (most critical for filtering)

**Double Compression Fix**:

- Added `TRUST_PROXY` environment variable check in `server.js:130`
- Express compression disabled when nginx handles compression
- Eliminates wasted CPU cycles and response delays

**Performance Results**:

- Page load time: 6-12s → under 2s (80-85% improvement)
- Cached API responses: 2-5ms vs 400-1000ms uncached
- Cache hit rate: 61% improvement on vulnerabilities endpoint
- Fresh data visible: Within 30-60s after import without hard refresh

**Code Quality**:

- Refactored duplicate caching logic using withCaching() helper (Codacy fix)
- Eliminated 44 lines of duplicated code across controllers
- Single source of truth for cache TTL management
- X-Cache headers enable cache effectiveness monitoring

**Production Impact**:

- Maintains ability to filter across all 30,000 records
- Cache automatically cleared on KEV sync and CSV imports
- No breaking changes to existing functionality
- Ready for Claude-Prod deployment to Ubuntu production

**Linear Issue**: [HEX-91](https://linear.app/hextrackr/issue/HEX-91)

---