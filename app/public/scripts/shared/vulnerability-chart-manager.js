/**
 * @fileoverview VulnerabilityChartManager Class
 * Manages vulnerability trend visualization using ApexCharts
 * Extracted from vulnerability-manager.js for better modularity
 * 
 * @version 2.1.0 - Dark Mode Integration (T027)
 * @date 2025-09-12
 * @spec 005-dark-mode-theme-system
 */

/* global ApexCharts, document, console, setTimeout, window, EventTarget, CustomEvent, module */

// ChartThemeAdapter is available as global window.ChartThemeAdapter

/**
 * VulnerabilityChartManager - Manages vulnerability chart lifecycle
 * Extends EventTarget for event-driven communication with other components
 */
class VulnerabilityChartManager extends EventTarget {
    /**
     * Initialize the chart manager
     * @param {string} containerId - DOM element ID to render chart
     * @param {Object} statisticsManager - Statistics manager instance
     * @param {Object} dataManager - Data manager instance
     */
    constructor(containerId, statisticsManager, dataManager) {
        super();
        this.containerId = containerId;
        this.statisticsManager = statisticsManager;
        this.dataManager = dataManager;
        this.chart = null;
        
        // Initialize theme adapter for dynamic theme support - T027
        this.themeAdapter = new window.ChartThemeAdapter();
    }

    /**
     * Initialize the ApexCharts instance with configuration
     * Made resilient to theme initialization timing issues
     * CRITICAL FIX: Now async to await chart.render() completion
     */
    async initialize() {
        if (this.chart) {
            console.warn("Chart already initialized");
            return;
        }

        const initChart = async (theme) => {
            const container = document.getElementById(this.containerId);
            if (!container) {
                console.error(`Chart container with ID '${this.containerId}' not found`);
                return;
            }

            const options = this.getChartOptions(theme);
            this.chart = new ApexCharts(container, options);
            await this.chart.render(); // CRITICAL: Wait for chart to fully render
            console.log("âœ… Chart fully rendered and ready for updates");

            this.themeAdapter.registerCharts({
                [this.containerId]: this.chart
            });

            // A timeout to ensure the theme is applied correctly after rendering
            setTimeout(() => {
                if (this.chart && this.themeAdapter) {
                    this.themeAdapter.updateChartTheme(this.chart, theme, this.containerId);
                }
            }, 100);

            this.setupEventListeners();
            this.dispatchEvent(new CustomEvent("chartInitialized", {
                detail: { containerId: this.containerId, theme: theme }
            }));
            console.log(`Chart initialized successfully with theme: ${theme}`);
        };

        // PERFORMANCE FIX: Render chart immediately, don't wait for events/timeouts
        const currentTheme = this.themeAdapter.detectCurrentTheme();
        await initChart(currentTheme);

        // Also listen for theme changes after initialization
        document.addEventListener("themeInitialized", (e) => {
            if (this.chart && this.themeAdapter) {
                this.themeAdapter.updateChartTheme(this.chart, e.detail.theme, this.containerId);
            }
        });
    }

    /**
     * Update chart with latest data from statistics manager
     * HEX-117: Modified to handle async chart updates
     * HEX-156: Added vendor parameter for vendor-filtered trends
     * @param {boolean} bustCache - If true, force fresh data fetch bypassing cache
     * @param {string|null} vendor - Optional vendor filter ('CISCO', 'Palo Alto', 'Other', or null for all)
     */
    async update(bustCache = false, vendor = null) {
        if (!this.chart) {
            console.warn("Chart not initialized - cannot update");
            return;
        }

        // HEX-156: Pass vendor parameter to chart update
        await this.statisticsManager.updateChart(this.chart, bustCache, vendor);
        
        // Auto-zoom to recent data if available
        const historicalData = this.dataManager.getHistoricalData();
        if (historicalData && historicalData.length > 0) {
            this.zoomToRecentData(30); // Default to 30 days
        }
        
        // Emit update event
        this.dispatchEvent(new CustomEvent("chartUpdated", {
            detail: { 
                containerId: this.containerId,
                hasData: historicalData && historicalData.length > 0
            }
        }));
    }

    /**
     * Zoom chart to show the most recent N days of actual data
     * @param {number} days - Number of days to show (default: 30)
     */
    zoomToRecentData(days = 30) {
        if (!this.chart) {
            console.warn("Chart not initialized - cannot zoom");
            return;
        }

        const historicalData = this.dataManager.getHistoricalData();
        if (!historicalData || historicalData.length === 0) {
            return;
        }

        // Extend timeline data to include projected points (extends to today)
        const extendedData = this.dataManager.extendTimelineData(historicalData);

        if (extendedData.length === 0) {
            return;
        }

        // Use the last point in extended data (today) for zoom end
        // This ensures we always show "last 14 days from today", not "last 14 days from last scan"
        const latestDate = new Date(extendedData[extendedData.length - 1].date);

        // Calculate zoom range from today
        const endTime = latestDate.getTime();
        const startTime = endTime - (days * 24 * 60 * 60 * 1000);

        // Apply zoom
        this.chart.zoomX(startTime, endTime);
    }

    /**
     * Export chart as image
     * @param {string} format - Export format ('png' or 'svg')
     * @param {number} width - Export width
     * @param {number} height - Export height
     * @returns {Promise<string|null>} Data URI of exported chart
     */
    async exportChart(format = "png", width, height) {
        if (!this.chart) {
            console.warn("Chart not initialized - cannot export");
            return null;
        }

        try {
            return await this.chart.dataURI({
                type: format,
                width,
                height
            });
        } catch (error) {
            console.error("Chart export failed:", error);
            return null;
        }
    }

    /**
     * Destroy the chart instance and cleanup
     */
    destroy() {
        if (this.chart) {
            this.chart.destroy();
            this.chart = null;
            
            // Emit destruction event
            this.dispatchEvent(new CustomEvent("chartDestroyed", {
                detail: { containerId: this.containerId }
            }));
        }
    }

    /**
     * Get the complete chart configuration options
     * @param {string} [theme='light'] - Chart theme ('light' or 'dark')
     * @returns {Object} ApexCharts configuration object
     */
    getChartOptions(theme = "light") {
        // Get base theme configuration from theme adapter - T027
        const _baseThemeConfig = this.themeAdapter.getThemeConfig(theme);
        
        // Merge theme configuration with vulnerability-specific chart settings
        const vulnerabilityChartConfig = {
            series: [{
                name: "Critical",
                data: []
            }, {
                name: "High", 
                data: []
            }, {
                name: "Medium",
                data: []
            }, {
                name: "Low",
                data: []
            }],
            chart: {
                height: 450,
                type: "line",
                background: "transparent",
                fontFamily: "Inter, -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif",
                zoom: {
                    enabled: true,
                    type: "x",
                    autoScaleYaxis: true,
                    zoomedArea: {
                        fill: {
                            color: "#90CAF9",
                            opacity: 0.4
                        },
                        stroke: {
                            color: "#0D47A1",
                            opacity: 0.4,
                            width: 1
                        }
                    }
                },
                toolbar: {
                    show: true,
                    offsetX: 0,
                    offsetY: 0,
                    tools: {
                        download: true,
                        selection: true,
                        zoom: true,
                        zoomin: true,
                        zoomout: true,
                        pan: true,
                        reset: true
                    },
                    export: {
                        csv: {
                            filename: `vulnerability-trends-${new Date().toISOString().split("T")[0]}`
                        },
                        png: {
                            filename: `vulnerability-trends-${new Date().toISOString().split("T")[0]}`
                        }
                    }
                },
                animations: {
                    enabled: true,
                    easing: "easeinout",
                    speed: 800,
                    animateGradually: {
                        enabled: true,
                        delay: 150
                    },
                    dynamicAnimation: {
                        enabled: true,
                        speed: 350
                    }
                }
            },
            colors: ["#dc2626", "#ea580c", "#2563eb", "#16a34a"],
            stroke: {
                curve: "smooth",
                width: 3,
                lineCap: "round"
            },
            markers: {
                size: 0,
                strokeWidth: 2,
                strokeColors: "#ffffff",
                fillOpacity: 1,
                hover: {
                    size: 10,
                    sizeOffset: 3
                },
                discrete: []
            },
            dataLabels: {
                enabled: false
            },
            grid: {
                show: true,
                borderColor: theme === "dark" ? "#334155" : "#f1f5f9",
                strokeDashArray: 3,
                position: "back",
                xaxis: {
                    lines: {
                        show: true
                    }
                },
                yaxis: {
                    lines: {
                        show: true
                    }
                },
                padding: {
                    top: 0,
                    right: 20,
                    bottom: 0,
                    left: 10
                }
            },
            xaxis: {
                type: "datetime",
                labels: {
                    style: {
                        colors: theme === "dark" ? "#cbd5e1" : "#64748b",
                        fontSize: "13px",
                        fontFamily: "Inter, sans-serif",
                        fontWeight: 500
                    },
                    datetimeUTC: false,
                    format: "MMM dd",
                    rotate: 0
                },
                axisBorder: {
                    show: true,
                    color: "#e2e8f0",
                    height: 1
                },
                axisTicks: {
                    show: true,
                    color: "#e2e8f0",
                    height: 4
                },
                tooltip: {
                    enabled: false
                }
            },
            yaxis: {
                labels: {
                    style: {
                        colors: theme === "dark" ? "#cbd5e1" : "#64748b",
                        fontSize: "13px",
                        fontFamily: "Inter, sans-serif",
                        fontWeight: 500
                    },
                    formatter: function(value) {
                        return Math.round(value).toLocaleString();
                    }
                },
                axisBorder: {
                    show: true,
                    color: "#e2e8f0"
                },
                axisTicks: {
                    show: true,
                    color: "#e2e8f0"
                },
                title: {
                    text: "Vulnerability Count",
                    style: {
                        color: "#475569",
                        fontSize: "14px",
                        fontFamily: "Inter, sans-serif",
                        fontWeight: 600
                    }
                },
                min: 0
            },
            legend: {
                show: true,
                position: "top",
                horizontalAlign: "left",
                floating: false,
                fontSize: "14px",
                fontFamily: "Inter, sans-serif",
                fontWeight: 500,
                offsetY: 0,
                offsetX: 0,
                markers: {
                    width: 16,
                    height: 16,
                    strokeWidth: 0,
                    radius: 8
                },
                itemMargin: {
                    horizontal: 20,
                    vertical: 8
                },
                labels: {
                    colors: "#374151"
                }
            },
            tooltip: {
                enabled: true,
                shared: true,
                intersect: false,
                theme: theme,
                followCursor: true,
                fixed: {
                    enabled: false
                },
                style: {
                    fontSize: "13px",
                    fontFamily: "Inter, sans-serif"
                },
                x: {
                    format: "MMM dd, yyyy"
                },
                filter: {
                    seriesIndex: 0,
                    type: "none"
                },
                custom: this.createCustomTooltip.bind(this)
            },
            title: {
                text: "Historical Vulnerability Trends",
                align: "left",
                style: {
                    fontSize: "20px",
                    fontWeight: "600",
                    color: "#1f2937",
                    fontFamily: "Inter, sans-serif"
                },
                offsetY: 20
            },
            subtitle: {
                text: "Showing data points only for actual vulnerability scans",
                align: "left",
                style: {
                    fontSize: "14px",
                    fontWeight: "400",
                    color: "#6b7280",
                    fontFamily: "Inter, sans-serif"
                },
                offsetY: 45
            },
            theme: {
                mode: theme,
                palette: "palette1"
            },
            responsive: [{
                breakpoint: 768,
                options: {
                    chart: {
                        height: 350
                    },
                    legend: {
                        position: "bottom",
                        offsetY: 10
                    },
                    title: {
                        style: {
                            fontSize: "18px"
                        }
                    }
                }
            }]
        };
        
        // Apply theme configuration using ChartThemeAdapter - T027
        return this.applyThemeToChartOptions(vulnerabilityChartConfig, theme);
    }

    /**
     * Create custom tooltip for chart data points
     * @param {Object} params - Tooltip parameters from ApexCharts
     * @returns {string} HTML content for tooltip
     */
    createCustomTooltip({ series, seriesIndex: _seriesIndex, dataPointIndex, w: _w }) {
        const vulnerabilityTracker = window.vulnerabilityTracker;
        if (!vulnerabilityTracker || !vulnerabilityTracker.historicalData) {
            return "";
        }
        
        const extendedData = vulnerabilityTracker.extendTimelineData(vulnerabilityTracker.historicalData);
        const dataPoint = extendedData[dataPointIndex];
        
        if (!dataPoint || !dataPoint.hasActualData) {
            return "";
        }
        
        const date = new Date(dataPoint.scan_date || dataPoint.date).toLocaleDateString("en-US", { 
            weekday: "long",
            month: "long", 
            day: "numeric", 
            year: "numeric" 
        });
        
        const currentMetric = this.statisticsManager.currentMetricType || "count";
        
        let tooltipContent = `
            <div class="apexcharts-tooltip-custom" style="
                background: white;
                border: 1px solid #e2e8f0;
                border-radius: 12px;
                box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
                padding: 16px;
                font-family: Inter, sans-serif;
                min-width: 280px;
                max-width: 320px;
            ">
                <div style="
                    font-weight: 600;
                    font-size: 14px;
                    color: #1f2937;
                    margin-bottom: 12px;
                    padding-bottom: 8px;
                    border-bottom: 1px solid #f3f4f6;
                    text-align: center;
                ">${date}</div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
        `;
        
        const seriesNames = ["Critical", "High", "Medium", "Low"];
        const colors = ["#dc2626", "#ea580c", "#2563eb", "#16a34a"];
        
        series.forEach((seriesData, index) => {
            const value = seriesData[dataPointIndex];
            if (value !== undefined && value !== null) {
                const metric = currentMetric === "vpr" ? " VPR" : "";
                
                tooltipContent += `
                    <div style="
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        padding: 6px 0;
                    ">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="
                                width: 14px;
                                height: 14px;
                                border-radius: 50%;
                                background-color: ${colors[index]};
                                border: 2px solid white;
                                box-shadow: 0 0 0 1px ${colors[index]}40;
                            "></div>
                            <span style="
                                font-size: 13px;
                                color: #4b5563;
                                font-weight: 500;
                            ">${seriesNames[index]}</span>
                        </div>
                        <span style="
                            font-size: 14px;
                            font-weight: 600;
                            color: #1f2937;
                        ">${value.toLocaleString()}${metric}</span>
                    </div>
                `;
            }
        });
        
        tooltipContent += `
                </div>
                <div style="
                    margin-top: 12px;
                    padding-top: 8px;
                    border-top: 1px solid #f3f4f6;
                    font-size: 11px;
                    color: #6b7280;
                    text-align: center;
                ">ðŸ“Š Data from vulnerability scan</div>
            </div>
        `;
        
        return tooltipContent;
    }

    /**
     * Apply theme configuration to existing chart options - T027
     * @param {Object} chartOptions - Base ApexCharts configuration
     * @param {string} theme - Theme to apply ('light' | 'dark')
     * @returns {Object} Theme-enhanced chart configuration
     */
    applyThemeToChartOptions(chartOptions, theme) {
        // Get theme configuration from adapter
        const themeConfig = this.themeAdapter.getThemeConfig(theme);

        // Deep merge theme configuration with chart options
        // IMPORTANT: Preserve vulnerability-specific colors, don't override with generic palette
        return {
            ...chartOptions,
            theme: themeConfig.theme,
            chart: {
                ...chartOptions.chart,
                ...themeConfig.chart
            },
            // Keep original vulnerability severity colors - don't override with theme colors
            colors: chartOptions.colors,
            stroke: {
                ...chartOptions.stroke,
                // Only apply theme border colors, preserve line properties
                ...(themeConfig.stroke && themeConfig.stroke.colors ? { colors: themeConfig.stroke.colors } : {})
            },
            fill: {
                ...chartOptions.fill,
                ...themeConfig.fill
            },
            grid: {
                ...chartOptions.grid,
                ...themeConfig.grid
            },
            xaxis: {
                ...chartOptions.xaxis,
                ...themeConfig.xaxis
            },
            yaxis: {
                ...chartOptions.yaxis,
                ...themeConfig.yaxis
            },
            title: {
                ...chartOptions.title,
                style: {
                    ...chartOptions.title?.style,
                    ...themeConfig.title?.style
                }
            },
            subtitle: {
                ...chartOptions.subtitle,
                style: {
                    ...chartOptions.subtitle?.style,
                    ...themeConfig.subtitle?.style
                }
            },
            legend: {
                ...chartOptions.legend,
                labels: {
                    ...chartOptions.legend?.labels,
                    ...themeConfig.legend?.labels
                }
            },
            tooltip: {
                ...chartOptions.tooltip,
                ...themeConfig.tooltip
            },
            dataLabels: {
                ...chartOptions.dataLabels,
                ...themeConfig.dataLabels
            }
        };
    }

    /**
     * Update chart theme dynamically - T027
     * @param {string} newTheme - New theme to apply ('light' | 'dark')
     * @returns {Promise<boolean>} Success status
     */
    async updateTheme(newTheme) {
        if (!this.chart) {
            console.warn("Chart not initialized - cannot update theme");
            return false;
        }

        try {
            const success = await this.themeAdapter.updateChartTheme(this.chart, newTheme, this.containerId);
            
            if (success) {
                // Emit theme change event
                this.dispatchEvent(new CustomEvent("themeChanged", {
                    detail: { 
                        containerId: this.containerId,
                        newTheme: newTheme,
                        timestamp: Date.now()
                    }
                }));
            }
            
            return success;
        } catch (error) {
            console.error("Error updating chart theme:", error);
            return false;
        }
    }

    /**
     * Setup chart event listeners for enhanced interactivity
     */
    setupEventListeners() {
        setTimeout(() => {
            const chartContainer = document.getElementById(this.containerId);
            if (chartContainer) {
                let _pinnedTooltip = null;
                let _tooltipCloseTime = null;
                
                chartContainer.addEventListener("click", (_e) => {
                    const tooltip = document.querySelector(".apexcharts-tooltip.persistent-tooltip");
                    if (tooltip && tooltip.style.opacity !== "0") {
                        _pinnedTooltip = tooltip;
                        tooltip.style.border = "2px solid #3b82f6";
                        tooltip.style.boxShadow = "0 4px 12px rgba(59, 130, 246, 0.3)";
                        tooltip.setAttribute("data-pinned", "true");
                        
                        if (!tooltip.querySelector(".close-btn")) {
                            const closeBtn = document.createElement("div");
                            closeBtn.className = "close-btn";
                            closeBtn.innerHTML = "âœ•";
                            closeBtn.style.cssText = `
                                position: absolute; top: 4px; right: 8px; 
                                cursor: pointer; color: #6b7280; font-size: 14px; 
                                width: 16px; height: 16px; display: flex; 
                                align-items: center; justify-content: center;
                                border-radius: 50%; background: #f3f4f6;
                            `;
                            closeBtn.addEventListener("mouseenter", () => {
                                closeBtn.style.background = "#e5e7eb";
                            });
                            closeBtn.addEventListener("mouseleave", () => {
                                closeBtn.style.background = "#f3f4f6";
                            });
                            closeBtn.addEventListener("click", (e) => {
                                e.stopPropagation();
                                tooltip.style.opacity = "0";
                                tooltip.style.display = "none";
                                _tooltipCloseTime = Date.now();
                            });
                            tooltip.appendChild(closeBtn);
                        }
                    }
                });
            }
        }, 1000);
    }
}

// Export for CommonJS (Node.js/Jest) and browser global
if (typeof module !== "undefined" && module.exports) {
    module.exports = VulnerabilityChartManager;
} else {
    window.VulnerabilityChartManager = VulnerabilityChartManager;
}