/**
 * @fileoverview VulnerabilityCardsManager - Handles device and vulnerability card rendering
 * Extracted from ModernVulnManager as part of Phase 2 modularization
 * @version 2.0.0
 * @author Claude  
 * @date 2025-09-08
 */

/* eslint-env browser, es6 */
/* global window, document, Sortable, CVEUtilities */
/* exported VulnerabilityCardsManager */

/**
 * Manages device cards and vulnerability cards rendering with pagination
 */
class VulnerabilityCardsManager {
    constructor(dataManager, devicePagination, vulnerabilityPagination, componentContext) {
        this.dataManager = dataManager;
        this.devicePagination = devicePagination;
        this.vulnerabilityPagination = vulnerabilityPagination;
        this.componentContext = componentContext; // Reference to parent component for callbacks
    }

    /**
     * Render device cards with VPR scoring and pagination
     */
    renderDeviceCards() {
        const container = document.getElementById("deviceCards");
        const filteredDevices = this.dataManager.getDevices().filter(device => {
            const searchTerm = document.getElementById("searchInput").value.toLowerCase();
            return !searchTerm || device.hostname.toLowerCase().includes(searchTerm);
        });

        // Sort devices by total VPR score (high to low)
        filteredDevices.sort((a, b) => {
            const aTotalVPR = (a.criticalVPR || 0) + (a.highVPR || 0) + (a.mediumVPR || 0) + (a.lowVPR || 0);
            const bTotalVPR = (b.criticalVPR || 0) + (b.highVPR || 0) + (b.mediumVPR || 0) + (b.lowVPR || 0);
            return bTotalVPR - aTotalVPR;
        });

        // Update pagination with filtered count
        this.devicePagination.setTotalItems(filteredDevices.length);
        
        // Get current page data
        const paginatedDevices = this.devicePagination.getCurrentPageData(filteredDevices);

        container.innerHTML = this.generateDeviceCardsHTML(paginatedDevices);

        // Render pagination controls
        this.devicePagination.renderPaginationControls(
            "devicePaginationControls",
            () => this.renderDeviceCards(),
            () => this.renderDeviceCards()
        );

        this.initializeSortable(container);
    }

    /**
     * Generate HTML for device cards with theme-aware styling
     * @param {Array} devices - Array of device objects
     * @returns {string} HTML string for device cards
     *
     * @description Generates device cards with VPR scoring mini-cards and click functionality.
     * Uses CSS classes that integrate with HexTrackr's theme system:
     * - `.device-card`: Card styling from shared/cards.css
     * - `.device-hostname`: Typography using --hextrackr-text-primary
     * - `.vpr-mini-card`: VPR severity indicators using --vpr-* variables
     * - `.text-red`, `.text-orange`, etc.: Semantic color classes
     *
     * @example
     * // CSS variables used in styling:
     * // --hextrackr-surface-base (card background)
     * // --hextrackr-border-color (card borders)
     * // --vpr-critical, --vpr-high, --vpr-medium, --vpr-low (severity colors)
     */
    generateDeviceCardsHTML(devices) {
        return devices.map(device => {
            const criticalVPR = device.criticalVPR || 0;
            const highVPR = device.highVPR || 0;
            const mediumVPR = device.mediumVPR || 0;
            const lowVPR = device.lowVPR || 0;
            const totalVPR = criticalVPR + highVPR + mediumVPR + lowVPR;

            return `
            <div class="col-lg-4 col-md-6 mb-3 fade-in">
                <div class="card device-card" style="cursor: pointer;" onclick="vulnManager.viewDeviceDetails('${device.hostname}')">
                    <div class="card-body">
                        <div class="device-hostname">
                            <i class="fas fa-server me-2 text-primary"></i>
                            ${device.hostname}
                        </div>
                        
                        <div class="device-stats">
                            <div>
                                <div class="text-muted small">Total Vulnerabilities</div>
                                <div class="fw-bold">${device.totalCount}</div>
                            </div>
                            <div class="text-end">
                                <div class="text-muted small">Total VPR</div>
                                <div class="device-total-vpr">${totalVPR.toFixed(1)}</div>
                            </div>
                        </div>

                        <div class="vpr-mini-cards">
                            <div class="vpr-mini-card critical">
                                <div class="vpr-count text-red">${device.criticalCount}</div>
                                <div class="vpr-label">Critical</div>
                                <div class="vpr-sum">${criticalVPR.toFixed(1)}</div>
                            </div>
                            <div class="vpr-mini-card high">
                                <div class="vpr-count text-orange">${device.highCount}</div>
                                <div class="vpr-label">High</div>
                                <div class="vpr-sum">${highVPR.toFixed(1)}</div>
                            </div>
                            <div class="vpr-mini-card medium">
                                <div class="vpr-count text-yellow">${device.mediumCount}</div>
                                <div class="vpr-label">Medium</div>
                                <div class="vpr-sum">${mediumVPR.toFixed(1)}</div>
                            </div>
                            <div class="vpr-mini-card low">
                                <div class="vpr-count text-green">${device.lowCount}</div>
                                <div class="vpr-label">Low</div>
                                <div class="vpr-sum">${lowVPR.toFixed(1)}</div>
                            </div>
                        </div>

                        <div class="card-actions">
                            <button class="btn btn-outline-success"
                                    onclick="event.stopPropagation(); vulnManager.createTicketFromDevice('${device.hostname}')">
                                <i class="fas fa-ticket-alt me-1"></i>Create Ticket
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            `;
        }).join("");
    }

    /**
     * Render vulnerability cards grouped by CVE with VPR scoring
     */
    renderVulnerabilityCards() {
        const container = document.getElementById("vulnerabilityCards");
        const groupedVulns = this.dataManager.groupVulnerabilitiesByCVE();
        
        // Sort vulnerability groups by total VPR score (high to low)
        const sortedVulnEntries = Object.entries(groupedVulns).sort(([,vulnsA], [,vulnsB]) => {
            const totalVPRA = vulnsA.reduce((sum, v) => sum + (v.vpr_score || 0), 0);
            const totalVPRB = vulnsB.reduce((sum, v) => sum + (v.vpr_score || 0), 0);
            return totalVPRB - totalVPRA;
        });

        // Update pagination with total count
        this.vulnerabilityPagination.setTotalItems(sortedVulnEntries.length);
        
        // Get current page data
        const paginatedVulnEntries = this.vulnerabilityPagination.getCurrentPageData(sortedVulnEntries);

        container.innerHTML = this.generateVulnerabilityCardsHTML(paginatedVulnEntries);

        // Render pagination controls
        this.vulnerabilityPagination.renderPaginationControls(
            "vulnerabilityPaginationControls",
            () => this.renderVulnerabilityCards(),
            () => this.renderVulnerabilityCards()
        );

        this.initializeSortable(container);
    }

    /**
     * Generate HTML for vulnerability cards with severity-based styling
     * @param {Array} vulnEntries - Array of [cve, vulns] tuples
     * @returns {string} HTML string for vulnerability cards
     *
     * @description Generates vulnerability cards grouped by CVE with VPR scoring and
     * external link functionality. Integrates with HexTrackr's theme system:
     * - `.vulnerability-card`: Card styling from shared/cards.css
     * - `.vulnerability-title`: Title typography using --hextrackr-text-primary
     * - `.vulnerability-cve`: CVE link styling with external link behavior
     * - `.severity-*`: Severity badges using --vpr-* color variables
     * - `.vpr-mini-card`: VPR score indicators with theme-aware colors
     *
     * @example
     * // CSS variables used in vulnerability card styling:
     * // --hextrackr-surface-base (card background)
     * // --hextrackr-border-color (card borders)
     * // --vpr-critical, --vpr-high, --vpr-medium, --vpr-low (severity colors)
     * // --hextrackr-text-primary, --hextrackr-text-muted (text colors)
     */
    generateVulnerabilityCardsHTML(vulnEntries) {
        return vulnEntries.map(([cve, vulns]) => {
            const criticalVulns = vulns.filter(v => v.severity === "Critical");
            const highVulns = vulns.filter(v => v.severity === "High");
            const mediumVulns = vulns.filter(v => v.severity === "Medium");
            const lowVulns = vulns.filter(v => v.severity === "Low");
            
            const criticalVPR = criticalVulns.reduce((sum, v) => sum + (v.vpr_score || 0), 0);
            const highVPR = highVulns.reduce((sum, v) => sum + (v.vpr_score || 0), 0);
            const mediumVPR = mediumVulns.reduce((sum, v) => sum + (v.vpr_score || 0), 0);
            const lowVPR = lowVulns.reduce((sum, v) => sum + (v.vpr_score || 0), 0);
            const totalVPR = criticalVPR + highVPR + mediumVPR + lowVPR;

            const primaryVuln = vulns[0];
            const description = primaryVuln.description || primaryVuln.plugin_name || "No description available";
            
            // Create a safe data attribute for the vulnerability data
            const vulnDataId = `vuln-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            // Store the vulnerability data temporarily for modal access
            window.vulnModalData = window.vulnModalData || {};
            window.vulnModalData[vulnDataId] = primaryVuln;

            return `
            <div class="col-lg-4 col-md-6 mb-3 fade-in">
                <div class="card vulnerability-card" style="cursor: pointer;" data-vuln-id="${vulnDataId}" onclick="vulnManager.viewVulnerabilityDetails('${vulnDataId}')">
                    <div class="card-body">
                        <div class="vulnerability-title">
                            ${description.substring(0, 100)}${description.length > 100 ? "..." : ""}
                        </div>
                        
                        <div class="vulnerability-meta">
                            <div>
                                ${this.generateVulnerabilityLinkHTML(cve, primaryVuln)}
                            </div>
                            <div class="text-end">
                                <div class="vulnerability-vpr text-primary">
                                    ${totalVPR.toFixed(1)}
                                </div>
                                <div class="text-muted small">Total VPR</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <span class="badge severity-${primaryVuln.severity.toLowerCase()}">
                                ${primaryVuln.severity}
                            </span>
                            <span class="text-muted ms-2">
                                <i class="fas fa-server me-1"></i>
                                ${vulns.length} device${vulns.length !== 1 ? "s" : ""}
                            </span>
                        </div>

                        <div class="vpr-mini-cards">
                            <div class="vpr-mini-card critical">
                                <div class="vpr-count text-red">${criticalVulns.length}</div>
                                <div class="vpr-label">Critical</div>
                                <div class="vpr-sum">${criticalVPR.toFixed(1)}</div>
                            </div>
                            <div class="vpr-mini-card high">
                                <div class="vpr-count text-orange">${highVulns.length}</div>
                                <div class="vpr-label">High</div>
                                <div class="vpr-sum">${highVPR.toFixed(1)}</div>
                            </div>
                            <div class="vpr-mini-card medium">
                                <div class="vpr-count text-yellow">${mediumVulns.length}</div>
                                <div class="vpr-label">Medium</div>
                                <div class="vpr-sum">${mediumVPR.toFixed(1)}</div>
                            </div>
                            <div class="vpr-mini-card low">
                                <div class="vpr-count text-green">${lowVulns.length}</div>
                                <div class="vpr-label">Low</div>
                                <div class="vpr-sum">${lowVPR.toFixed(1)}</div>
                            </div>
                        </div>

                        ${this.generateVulnerabilityActionsHTML(cve, primaryVuln, vulnDataId)}
                    </div>
                </div>
            </div>
            `;
        }).join("");
    }

    /**
     * Generate vulnerability link HTML (CVE or Cisco SA)
     * Handles multiple CVEs with proper individual link creation
     * @param {string} cve - CVE identifier(s) - may be comma/space separated
     * @param {Object} primaryVuln - Primary vulnerability object
     * @returns {string} HTML string for vulnerability link(s)
     */
    generateVulnerabilityLinkHTML(cve, primaryVuln) {
        // Use CVE utilities for multiple CVE handling
        if (cve && (cve.includes("CVE-") || cve.includes("cisco-sa-"))) {
            // Check if CVEUtilities is available
            if (typeof CVEUtilities !== "undefined" && CVEUtilities.createMultipleCVELinks) {
                return CVEUtilities.createMultipleCVELinks(cve, {
                    cssClass: "vulnerability-cve",
                    external: true
                });
            } else {
                // Fallback for single CVE (backward compatibility) - open in popup
                if (cve.startsWith("CVE-")) {
                    const cveUrl = `https://cve.mitre.org/cgi-bin/cvename.cgi?name=${cve}`;
                    return `<a href="#" class="vulnerability-cve"
                               onclick="event.stopPropagation(); window.open('${cveUrl}', 'cve_popup', 'width=1200,height=1200,scrollbars=yes,resizable=yes'); return false;"
                               title="View CVE details on MITRE">
                                ${cve}
                            </a>`;
                }
            }
        }
        
        // Check for Cisco SA ID in plugin name as fallback
        if (primaryVuln.plugin_name && typeof primaryVuln.plugin_name === "string") {
            const ciscoSaMatch = primaryVuln.plugin_name.match(/cisco-sa-([a-zA-Z0-9-]+)/i);
            if (ciscoSaMatch) {
                const ciscoId = `cisco-sa-${ciscoSaMatch[1]}`;
                const ciscoUrl = `https://sec.cloudapps.cisco.com/security/center/content/CiscoSecurityAdvisory/${ciscoId}`;
                return `<a href="#" class="vulnerability-cve text-warning"
                           onclick="event.stopPropagation(); window.open('${ciscoUrl}', 'cisco_popup', 'width=1200,height=1200,scrollbars=yes,resizable=yes'); return false;"
                           title="View Cisco Security Advisory">
                            ${ciscoId}
                        </a>`;
            }
        }
        
        return `<span class="text-muted">Plugin ${primaryVuln.plugin_id}</span>`;
    }

    /**
     * Generate vulnerability card actions HTML
     * @param {string} cve - CVE identifier
     * @param {Object} primaryVuln - Primary vulnerability object
     * @param {string} vulnDataId - Vulnerability data ID
     * @returns {string} HTML string for card actions
     */
    generateVulnerabilityActionsHTML(cve, primaryVuln, vulnDataId) {
        // Check if we have CVE - open external CVE link in popup
        if (cve && cve.startsWith("CVE-")) {
            const cveUrl = `https://cve.mitre.org/cgi-bin/cvename.cgi?name=${cve}`;
            return `<div class="card-actions">
                        <button class="btn btn-primary"
                                onclick="event.stopPropagation(); window.open('${cveUrl}', 'cve_popup', 'width=1200,height=1200,scrollbars=yes,resizable=yes');">
                            <i class="fas fa-external-link-alt me-1"></i>View CVE Details
                        </button>
                    </div>`;
        }
        
        // Check for Cisco SA ID in plugin name
        if (primaryVuln.plugin_name && typeof primaryVuln.plugin_name === "string") {
            const ciscoSaMatch = primaryVuln.plugin_name.match(/cisco-sa-([a-zA-Z0-9-]+)/i);
            if (ciscoSaMatch) {
                const ciscoId = `cisco-sa-${ciscoSaMatch[1]}`;
                const ciscoUrl = `https://sec.cloudapps.cisco.com/security/center/content/CiscoSecurityAdvisory/${ciscoId}`;
                return `<div class="card-actions">
                            <button class="btn btn-primary"
                                    onclick="event.stopPropagation(); window.open('${ciscoUrl}', 'cisco_popup', 'width=1200,height=1200,scrollbars=yes,resizable=yes');">
                                <i class="fas fa-external-link-alt me-1"></i>View Cisco Advisory
                            </button>
                        </div>`;
            }
        }
        
        // Default action for no external reference
        return `<div class="card-actions">
                    <button class="btn btn-primary" onclick="event.stopPropagation(); vulnManager.viewVulnerabilityDetails('${vulnDataId}')">
                        <i class="fas fa-eye me-1"></i>View Vulnerability Details
                    </button>
                </div>`;
    }

    /**
     * Initialize Sortable.js for drag-and-drop functionality with theme-aware CSS classes
     * @param {HTMLElement} container - Container element to make sortable
     *
     * @description Applies Sortable.js with CSS classes that work with HexTrackr's theme system:
     * - `.sortable-ghost`: Semi-transparent placeholder during drag (from shared/animations.css)
     * - `.sortable-chosen`: Selected item styling using --hextrackr-primary colors
     * - `.sortable-drag`: Active drag state styling with theme-aware shadows
     *
     * @example
     * // CSS classes applied during sorting:
     * // .sortable-ghost { opacity: 0.5; background: var(--hextrackr-surface-2); }
     * // .sortable-chosen { transform: scale(1.02); box-shadow: var(--hextrackr-shadow-md); }
     */
    initializeSortable(container) {
        if (window.Sortable) {
            new Sortable(container, {
                animation: 150,
                ghostClass: "sortable-ghost",
                chosenClass: "sortable-chosen",
                dragClass: "sortable-drag"
            });
        }
    }

    /**
     * Update cards for current view type
     * @param {string} viewType - Current view type
     */
    updateForCurrentView(viewType) {
        switch (viewType) {
            case "devices":
                this.renderDeviceCards();
                break;
            case "vulnerabilities":
                this.renderVulnerabilityCards();
                break;
        }
    }
}