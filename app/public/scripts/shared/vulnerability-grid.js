/**
 * @fileoverview VulnerabilityGridManager - Handles all AG Grid operations and configurations
 * Extracted from ModernVulnManager as part of Phase 2 modularization
 * 
 * @version 2.1.0 - Dark Mode Integration (T028)
 * @author HexTrackr Team
 * @date 2025-09-12
 * @spec 005-dark-mode-theme-system
 */

/* eslint-env browser, es6 */
/* global agGrid, createVulnerabilityGridOptions, document */
/* exported VulnerabilityGridManager */

/**
 * Manages all AG Grid operations for vulnerability data display
 */
class VulnerabilityGridManager {
    constructor(dataManager, componentContext) {
        this.dataManager = dataManager;
        this.componentContext = componentContext; // Reference to parent component for callbacks
        this.gridApi = null;

        // Removed ChartThemeAdapter to fix double registration issue
        // AGGridThemeManager handles all theme management centrally

        this.setupDataManagerListeners();
    }

    /**
     * Setup data manager event listeners for grid updates
     */
    setupDataManagerListeners() {
        // Listen for filtered data changes to update grid
        this.dataManager.on("dataFiltered", async (data) => {
            if (this.gridApi) {
                // Enrich vulnerability data with ticket information before displaying
                const enrichedData = await this.enrichWithTicketData(data.filteredVulnerabilities);
                this.gridApi.setGridOption("rowData", enrichedData);

                // HEX-170: Update pagination display when external filters change (vendor, KEV, search)
                if (typeof this.updatePaginationInfo === "function") {
                    const totalRows = enrichedData.length;
                    const currentPage = this.gridApi.paginationGetCurrentPage();
                    const pageSize = this.gridApi.paginationGetPageSize();
                    this.updatePaginationInfo(totalRows, currentPage, pageSize);
                }
            }
        });
    }

    /**
     * Fetch ticket data in batch for multiple hostnames
     * HEX-216: Batch API to prevent N+1 HTTP requests
     * @param {Array<string>} hostnames - Array of hostnames to check
     * @returns {Promise<Object>} Map of hostname -> {count, status, jobType}
     */
    async checkTicketStateBatch(hostnames) {
        try {
            // Get CSRF token first (required for POST requests)
            const csrfResponse = await fetch("/api/auth/csrf", {
                credentials: "include"
            });
            const { csrfToken } = await csrfResponse.json();

            // Make batch request with CSRF token
            const response = await fetch("/api/tickets/batch-device-lookup", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "x-csrf-token": csrfToken
                },
                credentials: "include",
                body: JSON.stringify({ hostnames })
            });

            if (!response.ok) {
                console.error("Failed to fetch batch ticket data:", response.statusText);
                // Return empty map on error
                const emptyMap = {};
                hostnames.forEach(hostname => {
                    emptyMap[hostname.toLowerCase()] = { count: 0, status: null, jobType: null, tickets: [] };
                });
                return emptyMap;
            }

            const result = await response.json();
            return result.data || {};
        } catch (error) {
            console.error("Error checking ticket state batch:", error);
            // Return empty map on error
            const emptyMap = {};
            hostnames.forEach(hostname => {
                emptyMap[hostname.toLowerCase()] = { count: 0, status: null, jobType: null, tickets: [] };
            });
            return emptyMap;
        }
    }

    /**
     * Enrich vulnerability data with ticket status and count
     * Adds ticket_status, ticket_count, and ticket_ids fields for AG-Grid Ticket column
     * @param {Array<Object>} vulnerabilities - Array of vulnerability records
     * @returns {Promise<Array<Object>>} Enriched vulnerability records
     */
    async enrichWithTicketData(vulnerabilities) {
        // Extract unique hostnames
        const hostnames = [...new Set(vulnerabilities.map(v => v.hostname))];

        // Fetch ticket data in batch
        const ticketMap = await this.checkTicketStateBatch(hostnames);

        // Enrich each vulnerability record with ticket data
        return vulnerabilities.map(vuln => {
            const ticketData = ticketMap[vuln.hostname.toLowerCase()] || { count: 0, status: null, tickets: [] };
            return {
                ...vuln,
                ticket_count: ticketData.count,
                ticket_status: ticketData.status,
                ticket_ids: ticketData.tickets || []  // Array of ticket IDs for navigation
            };
        });
    }

    /**
     * Detect current theme mode
     * @returns {boolean} True if dark mode is active
     */
    detectCurrentThemeMode() {
        try {
            // Check theme controller first (most reliable)
            if (window.ThemeController && window.ThemeController.getCurrentTheme) {
                return window.ThemeController.getCurrentTheme() === "dark";
            }
            
            // Check document data-bs-theme attribute
            const documentTheme = document.documentElement.getAttribute("data-bs-theme");
            if (documentTheme) {
                return documentTheme === "dark";
            }
            
            // Check for dark class
            if (document.documentElement.classList.contains("theme-dark")) {
                return true;
            }

            // Check localStorage as fallback
            // FIX (HEX-140): Use correct key "hextrackr-theme" and parse JSON format
            try {
                const stored = localStorage.getItem("hextrackr-theme");
                if (stored) {
                    // Try parsing as JSON first (new format)
                    try {
                        const parsed = JSON.parse(stored);
                        const theme = parsed.theme || parsed;
                        return theme === "dark";
                    } catch {
                        // Simple string format (backward compatibility)
                        return stored === "dark";
                    }
                }
            } catch (_e) {
                // localStorage might not be available
            }

            // Default to light mode
            return false;
        } catch (error) {
            console.warn("Error detecting theme mode:", error);
            return false; // Default to light mode on error
        }
    }

    /**
     * Initialize the main vulnerability grid with theme support - T028
     */
    initializeGrid() {
        // Detect current theme before creating grid options
        const isDarkMode = this.detectCurrentThemeMode();

        console.log(`ðŸŽ¨ Initializing grid with ${isDarkMode ? "dark" : "light"} mode theme`);

        // Pass true for usePagination to enable built-in AG-Grid pagination
        const gridOptions = createVulnerabilityGridOptions(this.componentContext, isDarkMode, true);
        const gridDiv = document.getElementById("vulnGrid");
        
        if (this.gridApi) {
            // Unregister from AGGridThemeManager before destroying
            if (window.agGridThemeManager) {
                window.agGridThemeManager.unregisterGrid("vulnGrid");
            }
            
            this.gridApi.destroy();
        }

        this.gridApi = agGrid.createGrid(gridDiv, gridOptions);

        // Register grid with centralized AGGridThemeManager only (fixed double registration)
        if (this.gridApi && window.agGridThemeManager) {
            window.agGridThemeManager.registerGrid("vulnGrid", this.gridApi, gridDiv);
        }
    }

    /**
     * Update grid data for the current view
     * @param {string} viewType - The current view type ('table', 'devices', 'vulnerabilities')
     */
    async updateForCurrentView(viewType) {
        if (viewType === "table") {
            if (this.gridApi) {
                // Enrich vulnerability data with ticket information before displaying
                const vulnerabilities = this.dataManager.getFilteredVulnerabilities();
                const enrichedData = await this.enrichWithTicketData(vulnerabilities);
                this.gridApi.setGridOption("rowData", enrichedData);

                // HEX-170: Update footer with database metadata after grid data loads
                if (typeof this.updatePaginationInfo === "function") {
                    const totalRows = this.gridApi.getDisplayedRowCount();
                    const currentPage = this.gridApi.paginationGetCurrentPage();
                    const pageSize = this.gridApi.paginationGetPageSize();
                    this.updatePaginationInfo(totalRows, currentPage, pageSize);
                }
            }
        }
    }

    /**
     * Create and render assets grid in vulnerability details modal
     * @param {Object} vulnerability - The vulnerability object
     */
    createAssetsGrid(vulnerability) {
        const affectedAssets = this.dataManager.getAllVulnerabilities().filter(v => v.cve === vulnerability.cve);
        document.getElementById("affectedAssetsCount").textContent = `${affectedAssets.length} assets`;

        const assetsGridDiv = document.getElementById("vulnerabilityAssetsGrid");
        assetsGridDiv.innerHTML = "";

        const assetsColumnDefs = this.createAssetsColumnDefinitions();
        const assetsGridOptions = this.createAssetsGridOptions(assetsColumnDefs, affectedAssets);

        agGrid.createGrid(assetsGridDiv, assetsGridOptions);
    }

    /**
     * Create column definitions for the assets grid
     * @returns {Array} Array of column definitions
     */
    createAssetsColumnDefinitions() {
        return [
            {
                headerName: "Hostname",
                field: "hostname",
                width: 200,
                cellRenderer: (params) => {
                    const hostname = params.value;
                    return `<a href="#" class="text-primary text-decoration-none fw-bold" onclick="vulnManager.viewDeviceDetails('${hostname}'); return false;">${hostname}</a>`;
                }
            },
            {
                headerName: "Port",
                field: "port",
                width: 100,
                cellRenderer: (params) => {
                    return `<span class="badge bg-secondary">${params.value || "N/A"}</span>`;
                }
            },
            {
                headerName: "First Seen",
                field: "first_seen",
                width: 150,
                cellRenderer: (params) => {
                    return params.value ? new Date(params.value).toLocaleDateString() : "N/A";
                }
            },
            {
                headerName: "Last Seen",
                field: "last_seen",
                width: 150,
                cellRenderer: (params) => {
                    const lastSeen = params.data.last_seen;
                    const scanDate = params.data.scan_date;
                    
                    if (lastSeen && lastSeen.trim() !== "") {
                        return new Date(lastSeen).toLocaleDateString();
                    } else if (scanDate && scanDate.trim() !== "") {
                        return new Date(scanDate).toLocaleDateString();
                    }
                    return "N/A";
                }
            },
            { 
                headerName: "Plugin Output", 
                field: "plugin_output", 
                flex: 1 
            }
        ];
    }

    /**
     * Create grid options for the assets grid
     * @param {Array} columnDefs - Column definitions
     * @param {Array} rowData - Row data
     * @returns {Object} Grid options object
     */
    createAssetsGridOptions(columnDefs, rowData) {
        // Get current theme for assets grid
        const isDarkMode = this.detectCurrentThemeMode();
        
        // Create proper AG-Grid v33 Quartz theme configuration
        let quartzTheme = null;
        if (typeof window.agGrid !== "undefined" && window.agGrid.themeQuartz) {
            if (isDarkMode) {
                // Updated dark theme to match user's navy design with EXACT colors
                quartzTheme = window.agGrid.themeQuartz.withParams({
                    backgroundColor: "#0F1C31", // Dark navy background - EXACT
                    foregroundColor: "#FFF", // Pure white text for better contrast
                    browserColorScheme: "dark",
                    chromeBackgroundColor: "#202c3f", // EXACT header color (no mixing function)
                    headerBackgroundColor: "#202c3f", // EXACT header color #202c3f as specified
                    headerTextColor: "#FFF",
                    headerFontSize: 14,
                    oddRowBackgroundColor: "rgba(255, 255, 255, 0.02)",
                    rowBorder: false,
                    headerRowBorder: false,
                    columnBorder: false,
                    borderColor: "#2a3f5f", // Subtle navy border
                    selectedRowBackgroundColor: "#2563eb", // Bright blue for selection
                    rowHoverColor: "rgba(37, 99, 235, 0.15)", // Blue hover effect
                    rangeSelectionBackgroundColor: "rgba(37, 99, 235, 0.2)"
                });
            } else {
                quartzTheme = window.agGrid.themeQuartz.withParams({
                    backgroundColor: "#ffffff",
                    foregroundColor: "#2d3748",
                    chromeBackgroundColor: "#f7fafc",
                    headerBackgroundColor: "#edf2f7",
                    headerTextColor: "#2d3748",
                    oddRowBackgroundColor: "rgba(0, 0, 0, 0.02)",
                    rowBorder: false,
                    headerRowBorder: false,
                    columnBorder: false,
                    borderColor: "#e2e8f0",
                    selectedRowBackgroundColor: "#3182ce",
                    rowHoverColor: "rgba(49, 130, 206, 0.1)",
                    rangeSelectionBackgroundColor: "rgba(49, 130, 206, 0.2)"
                });
            }
        }

        return {
            theme: quartzTheme, // AG-Grid v33 proper Quartz theme configuration
            columnDefs: columnDefs,
            rowData: rowData,
            defaultColDef: {
                resizable: true,
                sortable: true,
                filter: true
            },
            pagination: true,
            paginationPageSize: 15,
            animateRows: true
        };
    }


    /**
     * Forces a redraw of the grid to apply theme changes.
     */
    forceGridRedraw() {
        if (this.gridApi) {
            this.gridApi.redrawRows();
            this.gridApi.refreshHeader();
        }
    }

    /**
     * Get the current grid API instance
     * @returns {Object} The AG Grid API instance
     */
    getGridApi() {
        return this.gridApi;
    }

    /**
     * Destroy the current grid instance
     */
    destroy() {
        if (this.gridApi) {
            this.gridApi.destroy();
            this.gridApi = null;
        }
    }

    /**
     * Refresh grid data
     */
    async refreshData() {
        if (this.gridApi) {
            // Enrich vulnerability data with ticket information before displaying
            const vulnerabilities = this.dataManager.getFilteredVulnerabilities();
            const enrichedData = await this.enrichWithTicketData(vulnerabilities);
            this.gridApi.setGridOption("rowData", enrichedData);
        }
    }

    /**
     * Update pagination information with database metadata
     * HEX-170: Repurposed to show database totals, last import, and vendor breakdown
     * Preserves 50k limit warnings (dual purpose: metadata + warning space)
     *
     * @param {number} _totalRows - Total number of rows currently displayed (unused - AG-Grid shows this)
     * @param {number} _currentPage - Current page number (unused)
     * @param {number} _pageSize - Number of rows per page (unused)
     */
    updatePaginationInfo(_totalRows, _currentPage, _pageSize) {
        const paginationDisplay = document.getElementById("gridPaginationInfo");
        if (!paginationDisplay) return;

        // Don't overwrite 50k limit warnings (vulnerability-data.js sets these during loading)
        if (paginationDisplay.querySelector(".alert-warning")) {
            console.log("âš ï¸ Preserving 50k limit warning, not updating footer");
            return;
        }

        // Get all vulnerabilities for metadata calculation
        const allVulns = this.dataManager.getAllVulnerabilities();
        const totalCount = this.dataManager.getTotalCount();

        // Calculate vendor breakdown
        const vendorCounts = { CISCO: 0, "Palo Alto": 0, Other: 0 };
        let lastImportDate = null;

        allVulns.forEach(vuln => {
            // Vendor counting using dataManager's normalization logic
            const vendor = this.dataManager.normalizeVendor(vuln.plugin_name || "", vuln.hostname || "");
            if (vendorCounts.hasOwnProperty(vendor)) {
                vendorCounts[vendor]++;
            }

            // Track most recent import date
            if (vuln.scan_date) {
                const scanDate = new Date(vuln.scan_date);
                if (!lastImportDate || scanDate > lastImportDate) {
                    lastImportDate = scanDate;
                }
            }
        });

        // Format last import date
        const lastImport = lastImportDate
            ? lastImportDate.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" })
            : "Unknown";

        // Build database metadata footer (AG-Grid already shows filtered counts)
        paginationDisplay.innerHTML = `
            <span class="text-muted small">
                <strong>Database:</strong> ${totalCount.toLocaleString()} total |
                <strong>Last import:</strong> ${lastImport} |
                <strong>CISCO:</strong> ${vendorCounts.CISCO.toLocaleString()} |
                <strong>Palo Alto:</strong> ${vendorCounts["Palo Alto"].toLocaleString()} |
                <strong>Other:</strong> ${vendorCounts.Other.toLocaleString()}
            </span>
        `;

        console.log(`ðŸ“Š Footer: ${totalCount} total, last import ${lastImport}, CISCO: ${vendorCounts.CISCO}, Palo Alto: ${vendorCounts["Palo Alto"]}, Other: ${vendorCounts.Other}`);
    }

    /**
     * Update grid theme dynamically - T028
     * @param {string} newTheme - New theme to apply ('light' | 'dark')
     * @returns {boolean} Success status
     */
    updateTheme(newTheme) {
        try {
            console.log(`ðŸŽ¨ Updating grid theme to ${newTheme} mode`);
            
            // Store current data
            const currentData = [];
            if (this.gridApi) {
                const rowCount = this.gridApi.getDisplayedRowCount();
                for (let i = 0; i < rowCount; i++) {
                    const rowNode = this.gridApi.getDisplayedRowAtIndex(i);
                    if (rowNode) {
                        currentData.push(rowNode.data);
                    }
                }
            }
            
            // Recreate grid with new theme - this is the proper v33 approach
            this.initializeGrid();
            
            // Restore data
            if (currentData.length > 0 && this.gridApi) {
                this.gridApi.setGridOption("rowData", currentData);
            }
            
            console.log(`âœ… Grid theme successfully updated to ${newTheme}`);
            return true;
        } catch (error) {
            console.error("Error updating grid theme:", error);
            return false;
        }
    }

    /**
     * Get current theme adapter instance - DEPRECATED
     * @returns {null} Always returns null (adapter removed to fix double registration)
     * @deprecated Use AGGridThemeManager instead
     */
    getThemeAdapter() {
        return null;  // Removed to fix double registration issue
    }

    /**
     * Check if grid has theme support - uses AGGridThemeManager
     * @returns {boolean} True if theme manager is available
     */
    hasThemeSupport() {
        return window.agGridThemeManager !== null && window.agGridThemeManager !== undefined;
    }
}

// Global export for browser usage
window.VulnerabilityGridManager = VulnerabilityGridManager;

// ES6 module export (dual export pattern for compatibility)
try {
  if (typeof module !== "undefined" && module.exports) {
    module.exports = { VulnerabilityGridManager };
  }
  // ES6 export for import statements
  if (typeof exports !== "undefined") {
    exports.VulnerabilityGridManager = VulnerabilityGridManager;
  }
} catch (_error) {
  // Silently ignore if module system not available
  console.debug("Module export not available, using global window export");
}