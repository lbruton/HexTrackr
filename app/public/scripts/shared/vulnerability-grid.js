/**
 * @fileoverview VulnerabilityGridManager - Handles all AG Grid operations and configurations
 * Extracted from ModernVulnManager as part of Phase 2 modularization
 * @version 2.0.0
 * @author Claude
 * @date 2025-09-08
 */

/* eslint-env browser, es6 */
/* global agGrid, createVulnerabilityGridOptions, document */
/* exported VulnerabilityGridManager */

/**
 * Manages all AG Grid operations for vulnerability data display
 */
class VulnerabilityGridManager {
    constructor(dataManager, componentContext) {
        this.dataManager = dataManager;
        this.componentContext = componentContext; // Reference to parent component for callbacks
        this.gridApi = null;
        this.setupDataManagerListeners();
    }

    /**
     * Setup data manager event listeners for grid updates
     */
    setupDataManagerListeners() {
        // Listen for filtered data changes to update grid
        this.dataManager.on("dataFiltered", (data) => {
            if (this.gridApi) {
                this.gridApi.setGridOption("rowData", data.filteredVulnerabilities);
            }
        });
    }

    /**
     * Initialize the main vulnerability grid
     */
    initializeGrid() {
        const gridOptions = createVulnerabilityGridOptions(this.componentContext);
        const gridDiv = document.getElementById("vulnGrid");
        
        if (this.gridApi) {
            this.gridApi.destroy();
        }

        this.gridApi = agGrid.createGrid(gridDiv, gridOptions);
    }

    /**
     * Update grid data for the current view
     * @param {string} viewType - The current view type ('table', 'devices', 'vulnerabilities')
     */
    updateForCurrentView(viewType) {
        if (viewType === "table") {
            if (this.gridApi) {
                this.gridApi.setRowData(this.dataManager.getFilteredVulnerabilities());
            }
        }
    }

    /**
     * Create and render assets grid in vulnerability details modal
     * @param {Object} vulnerability - The vulnerability object
     */
    createAssetsGrid(vulnerability) {
        const affectedAssets = this.dataManager.getAllVulnerabilities().filter(v => v.cve === vulnerability.cve);
        document.getElementById("affectedAssetsCount").textContent = `${affectedAssets.length} assets`;

        const assetsGridDiv = document.getElementById("vulnerabilityAssetsGrid");
        assetsGridDiv.innerHTML = "";

        const assetsColumnDefs = this.createAssetsColumnDefinitions();
        const assetsGridOptions = this.createAssetsGridOptions(assetsColumnDefs, affectedAssets);

        new agGrid.Grid(assetsGridDiv, assetsGridOptions);
    }

    /**
     * Create column definitions for the assets grid
     * @returns {Array} Array of column definitions
     */
    createAssetsColumnDefinitions() {
        return [
            {
                headerName: "Hostname",
                field: "hostname",
                width: 200,
                cellRenderer: (params) => {
                    const hostname = params.value;
                    return `<a href="#" class="text-primary text-decoration-none fw-bold" onclick="vulnManager.viewDeviceDetails('${hostname}')">${hostname}</a>`;
                }
            },
            {
                headerName: "Port",
                field: "port",
                width: 100,
                cellRenderer: (params) => {
                    return `<span class="badge bg-secondary">${params.value || "N/A"}</span>`;
                }
            },
            {
                headerName: "First Seen",
                field: "first_seen",
                width: 150,
                cellRenderer: (params) => {
                    return params.value ? new Date(params.value).toLocaleDateString() : "N/A";
                }
            },
            {
                headerName: "Last Seen",
                field: "last_seen",
                width: 150,
                cellRenderer: (params) => {
                    const lastSeen = params.data.last_seen;
                    const scanDate = params.data.scan_date;
                    
                    if (lastSeen && lastSeen.trim() !== "") {
                        return new Date(lastSeen).toLocaleDateString();
                    } else if (scanDate && scanDate.trim() !== "") {
                        return new Date(scanDate).toLocaleDateString();
                    }
                    return "N/A";
                }
            },
            { 
                headerName: "Plugin Output", 
                field: "plugin_output", 
                flex: 1 
            }
        ];
    }

    /**
     * Create grid options for the assets grid
     * @param {Array} columnDefs - Column definitions
     * @param {Array} rowData - Row data
     * @returns {Object} Grid options object
     */
    createAssetsGridOptions(columnDefs, rowData) {
        return {
            columnDefs: columnDefs,
            rowData: rowData,
            defaultColDef: {
                resizable: true,
                sortable: true,
                filter: true
            },
            pagination: true,
            paginationPageSize: 15,
            animateRows: true
        };
    }

    /**
     * Get the current grid API instance
     * @returns {Object} The AG Grid API instance
     */
    getGridApi() {
        return this.gridApi;
    }

    /**
     * Destroy the current grid instance
     */
    destroy() {
        if (this.gridApi) {
            this.gridApi.destroy();
            this.gridApi = null;
        }
    }

    /**
     * Refresh grid data
     */
    refreshData() {
        if (this.gridApi) {
            this.gridApi.setRowData(this.dataManager.getFilteredVulnerabilities());
        }
    }

    /**
     * Update pagination information (called by AG Grid events)
     * @param {number} totalRows - Total number of rows
     * @param {number} currentPage - Current page number (0-indexed) 
     * @param {number} pageSize - Number of rows per page
     */
    updatePaginationInfo(totalRows, currentPage, pageSize) {
        // This method is called by the AG Grid pagination handler
        // to update any custom pagination displays with actual counts
        console.log(`Pagination updated: ${totalRows} total rows, page ${currentPage + 1}, ${pageSize} per page`);
        
        // The AG Grid handles the pagination display automatically
        // This method is here for future custom pagination implementations
    }
}