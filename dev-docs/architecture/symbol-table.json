{
  "version": "1.0.4",
  "generated": "2025-09-06T00:00:00Z",
  "source_files_analyzed": [
    "server.js",
    "scripts/pages/vulnerability-manager.js",
    "scripts/shared/vulnerability-data.js",
    "scripts/shared/ag-grid-responsive-config.js",
    "scripts/shared/settings-modal.js",
    "tests/*.spec.js"
  ],
  "classes": {
    "PaginationController": {
      "file": "scripts/pages/vulnerability-manager.js",
      "start_line": 22,
      "end_line": 208,
      "line_count": 187,
      "type": "class",
      "description": "Handles pagination logic and UI generation",
      "dependencies": [],
      "methods": [
        {
          "name": "constructor",
          "line": 23,
          "params": ["defaultPageSize", "availableSizes"],
          "description": "Initialize pagination with default settings"
        },
        {
          "name": "setTotalItems",
          "line": 30,
          "params": ["count"],
          "description": "Set total item count and adjust current page if needed"
        },
        {
          "name": "getTotalPages",
          "line": 39,
          "params": [],
          "description": "Calculate total number of pages"
        },
        {
          "name": "getCurrentPageData",
          "line": 43,
          "params": ["items"],
          "description": "Get slice of items for current page"
        },
        {
          "name": "renderPaginationControls",
          "line": 78,
          "params": ["containerId", "onPageChange", "onPageSizeChange"],
          "description": "Generate pagination UI HTML"
        }
      ],
      "refactor_priority": "HIGH",
      "refactor_target": "scripts/shared/pagination-controller.js",
      "refactor_notes": "Pure utility class, no dependencies, perfect extraction candidate"
    },
    "VulnerabilityDataManager": {
      "file": "scripts/shared/vulnerability-data.js",
      "start_line": 31,
      "end_line": 347,
      "line_count": 317,
      "type": "class",
      "description": "Centralized data management for vulnerability system",
      "dependencies": [],
      "methods": [
        {
          "name": "constructor",
          "line": 32,
          "params": ["apiBase"],
          "description": "Initialize data manager with API endpoint"
        },
        {
          "name": "loadData",
          "line": 50,
          "params": [],
          "description": "Load vulnerability and trend data from API"
        },
        {
          "name": "processDevices",
          "line": 89,
          "params": [],
          "description": "Process vulnerability data to create device aggregations"
        },
        {
          "name": "loadStatistics",
          "line": 151,
          "params": [],
          "description": "Load statistics and trend data from API"
        },
        {
          "name": "filterData",
          "line": 186,
          "params": ["searchTerm", "severityFilter"],
          "description": "Filter vulnerability data based on search term and severity"
        },
        {
          "name": "groupVulnerabilitiesByCVE",
          "line": 218,
          "params": [],
          "description": "Group vulnerabilities by CVE for card view display"
        }
      ],
      "refactor_priority": "COMPLETED",
      "refactor_target": "scripts/shared/vulnerability-data.js",
      "refactor_notes": "Successfully extracted from ModernVulnManager - pure data layer with event system"
    },
    "ModernVulnManager": {
      "file": "scripts/pages/vulnerability-manager.js", 
      "start_line": 24,
      "end_line": 2330,
      "line_count": 2307,
      "type": "class",
      "description": "Main vulnerability management orchestrator - reduced after data extraction",
      "dependencies": [
        "bootstrap",
        "agGrid", 
        "ApexCharts",
        "Papa",
        "Sortable",
        "PaginationController",
        "VulnerabilityDataManager"
      ],
      "methods": [
        {
          "name": "constructor",
          "line": 210,
          "description": "Initialize vulnerability manager"
        },
        {
          "name": "setupEventListeners",
          "line": 233,
          "description": "Set up all UI event handlers"
        },
        {
          "name": "initializeGrid",
          "line": 322,
          "description": "Initialize AG Grid"
        },
        {
          "name": "initializeChart", 
          "line": 333,
          "description": "Initialize ApexCharts"
        },
        {
          "name": "updateChart",
          "line": 1230,
          "description": "Update chart with new data"
        },
        {
          "name": "renderDeviceCards",
          "line": 1457,
          "description": "Render device view cards"
        },
        {
          "name": "renderVulnerabilityCards",
          "line": 1555,
          "description": "Render vulnerability view cards"
        }
      ],
      "refactor_priority": "HIGH",
      "refactor_plan": {
        "target_modules": [
          "vulnerability-core.js (orchestrator)",
          "vulnerability-grid.js (AG Grid logic)",
          "vulnerability-charts.js (ApexCharts logic)",
          "vulnerability-cards.js (card rendering)",
          "vulnerability-modals.js (modal handling)",
          "vulnerability-import.js (import/export)"
        ],
        "estimated_modules": 6,
        "estimated_lines_per_module": 385,
        "completed_extractions": [
          "vulnerability-data.js (COMPLETED - 347 lines)"
        ]
      }
    }
  },
  "functions": {
    "processVulnerabilityRowsWithRollover": {
      "file": "server.js",
      "line": 336,
      "type": "function",
      "description": "Legacy single-row processing function for vulnerability imports",
      "params": ["rows", "stmt", "importId", "filePath", "responseData", "res", "scanDate"],
      "performance": "LEGACY - Single row processing, use staging functions for bulk imports"
    },
    "bulkInsertToStagingTable": {
      "file": "server.js",
      "line": 519,
      "type": "function", 
      "description": "High-performance bulk insert to staging table using prepared statements",
      "params": ["rows", "importId", "filePath", "responseData", "res", "scanDate", "startTime"],
      "performance": "HIGH-PERFORMANCE - Batch processing optimized",
      "architecture": "staging_table_pattern"
    },
    "processStagingToFinalTables": {
      "file": "server.js",
      "line": 634,
      "type": "function",
      "description": "Process staging table records in configurable batches to final tables",
      "params": ["importId", "scanDate", "responseData", "res", "startTime"],
      "performance": "BATCH-OPTIMIZED - Configurable batch size (default: 1000)",
      "architecture": "batch_processing_pattern"
    },
    "finalizeBatchProcessing": {
      "file": "server.js",
      "line": 877,
      "type": "function",
      "description": "Cleanup staging table and calculate performance metrics",
      "params": ["importId", "currentDate", "batchStats", "responseData", "res", "startTime"],
      "performance": "CLEANUP - Staging table maintenance and metrics collection"
    },
    "mapVulnerabilityRow": {
      "file": "server.js",
      "line": "inline",
      "type": "function",
      "description": "Maps CSV row data to database schema with vendor-specific handling",
      "vendors_supported": ["Tenable", "Cisco", "Generic CSV"],
      "schema_mapping": "Dynamic based on CSV headers"
    },
    "createVulnerabilityGridOptions": {
      "file": "scripts/shared/ag-grid-responsive-config.js",
      "line": 36,
      "type": "function",
      "description": "Creates responsive AG Grid configuration with breakpoint management",
      "params": ["componentContext"],
      "responsive_patterns": {
        "mobile": "<768px - Hide secondary columns",
        "tablet": "768-1199px - Balanced column set",
        "desktop": ">1200px - Full column visibility"
      },
      "performance_features": ["debounced_resize", "column_virtualization", "pagination_optimization"]
    },
    "debounce": {
      "file": "scripts/shared/ag-grid-responsive-config.js",
      "line": 21,
      "type": "utility_function",
      "description": "Debounce function to limit rapid event firing (window resize optimization)",
      "params": ["func", "delay"],
      "performance": "CRITICAL - Prevents excessive resize event handling"
    }
  },
  "globals": {
    "window.refreshPageData": {
      "file": "scripts/pages/vulnerability-manager.js",
      "line": "multiple",
      "type": "global_function",
      "description": "Inter-module communication function",
      "usage": "Called to refresh page data across modules"
    }
  },
  "refactoring_queue": [
    {
      "priority": 1,
      "file": "scripts/pages/vulnerability-manager.js",
      "action": "extract_pagination_controller",
      "target": "scripts/shared/pagination-controller.js",
      "effort": "LOW",
      "impact": "HIGH",
      "dependencies": [],
      "status": "COMPLETED",
      "completed_date": "2025-09-05",
      "result": "216-line module extracted successfully"
    },
    {
      "priority": 2,
      "file": "scripts/pages/vulnerability-manager.js", 
      "action": "extract_vulnerability_data_manager",
      "target": "scripts/shared/vulnerability-data.js",
      "effort": "MEDIUM",
      "impact": "HIGH",
      "dependencies": ["pagination_controller_extracted"],
      "status": "COMPLETED",
      "completed_date": "2025-09-05",
      "result": "347-line data manager extracted successfully"
    },
    {
      "priority": 3,
      "file": "scripts/pages/vulnerability-manager.js",
      "action": "split_modern_vuln_manager",
      "target": "scripts/pages/vulnerability/",
      "effort": "HIGH",
      "impact": "CRITICAL",
      "dependencies": ["pagination_controller_extracted", "vulnerability_data_manager_extracted"]
    },
    {
      "priority": 3,
      "file": "scripts/pages/tickets.js",
      "action": "analyze_and_split",
      "target": "scripts/pages/tickets/",
      "effort": "HIGH", 
      "impact": "HIGH",
      "dependencies": ["vulnerability_manager_refactored"]
    }
  ],
  "metrics": {
    "total_files_analyzed": 6,
    "total_lines_analyzed": 9800,
    "largest_file": {
      "name": "server.js",
      "lines": 3300
    },
    "classes_identified": 3,
    "completed_extractions": 2,
    "lines_extracted": 563,
    "remaining_refactor_targets": 2,
    "estimated_modules_after_refactor": 16,
    "current_phase_progress": "Phase 3.0 ACTIVE - Staging table performance architecture implemented"
  },
  "next_update": "After performance testing and documentation of staging table patterns",
  "database_schema": {
    "staging_tables": {
      "vulnerability_staging": {
        "purpose": "High-performance CSV import staging with batch processing",
        "indexes": ["idx_staging_import_id", "idx_staging_processed", "idx_staging_batch_id", "idx_staging_unprocessed_batch"],
        "lifecycle": "temporary - records deleted after processing",
        "batch_size": "1000 (configurable)",
        "performance_pattern": "bulk_insert_batch_process_cleanup"
      }
    },
    "production_tables": {
      "vulnerabilities_current": {
        "deduplication_key": "enhanced_unique_key (hostname + CVE or plugin_id + description)",
        "indexes": ["idx_current_enhanced_unique_key", "idx_current_hostname", "idx_current_severity"]
      },
      "vulnerability_snapshots": {
        "purpose": "Historical record of all imports",
        "indexes": ["idx_snapshots_scan_date", "idx_snapshots_import_id"]
      },
      "vulnerability_daily_totals": {
        "purpose": "Aggregated daily statistics for trending",
        "unique_constraint": "scan_date"
      }
    }
  },
  "testing_patterns": {
    "playwright_specs": {
      "modal_validation": "tests/modal-success-validation.spec.js - Validates vulnerability and device modal aggregation",
      "import_export": "tests/vulnerability-import-export.spec.js - Tests CSV import/export functionality",
      "responsive_testing": "AG Grid responsive breakpoint testing patterns",
      "performance_testing": "Load time and chart update testing"
    },
    "test_data_patterns": {
      "modal_data_storage": "window.vulnModalData - Temporary storage for modal context",
      "aggregation_testing": "Device count validation in modals",
      "screenshot_validation": ".playwright-mcp/ directory for visual regression"
    }
  },
  "ui_flow_patterns": {
    "responsive_breakpoints": {
      "mobile": "<768px - Card view preferred, minimal columns",
      "tablet": "768-1199px - Hybrid view, essential columns",
      "desktop": ">1200px - Full table view, all columns"
    },
    "modal_interactions": {
      "vulnerability_details": "vulnManager.viewVulnerabilityDetails(vulnDataId) - Detailed vulnerability information",
      "device_details": "vulnManager.viewDeviceDetails(hostname) - Device-specific vulnerability aggregation",
      "lookup_integration": "vulnManager.lookupVulnerability(cve|ciscoId) - External vulnerability lookup"
    },
    "data_refresh_patterns": {
      "inter_module_communication": "window.refreshPageData('vulnerabilities'|'tickets')",
      "grid_updates": "gridApi.setRowData(newData) with responsive column updates",
      "chart_updates": "ApexCharts.updateOptions() with animation"
    }
  }
}